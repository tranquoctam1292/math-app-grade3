PROJECT SOURCE CODE EXPORT
==========================


==================================================
FILE PATH: eslint.config.js
==================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist', 'functions/']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


==================================================
FILE PATH: firebase.json
==================================================
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "disallowLegacyRuntimeConfig": true,
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ]
    }
  ],
  "firestore": {
    "database": "(default)",
    "location": "asia-southeast1",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  }
}


==================================================
FILE PATH: firestore.indexes.json
==================================================
{
  "indexes": [],
  "fieldOverrides": []
}

==================================================
FILE PATH: functions\index.js
==================================================
const { onCall, HttpsError } = require("firebase-functions/v2/https");
const { defineSecret } = require("firebase-functions/params");
const { GoogleGenerativeAI } = require("@google/generative-ai");
const admin = require("firebase-admin");
const { getFirestore } = require("firebase-admin/firestore");

if (!admin.apps.length) {
    admin.initializeApp();
}

const db = getFirestore();
const APP_ID = process.env.FIREBASE_APP_ID;

// ƒê·ªãnh nghƒ©a Secret m·ªõi cho Gemini
const apiKey = defineSecret("GEMINI_API_KEY");

const callGeminiForQuestions = async (model, prompt, attempt) => {
    const jsonInstruction = `
        B·∫°n l√† chuy√™n gia gi√°o d·ª•c To√°n ti·ªÉu h·ªçc.
        Nhi·ªám v·ª•: T·∫°o danh s√°ch c√¢u h·ªèi to√°n h·ªçc d·ª±a tr√™n y√™u c·∫ßu d∆∞·ªõi ƒë√¢y.
        Y√äU C·∫¶U QUAN TR·ªåNG V·ªÄ N·ªòI DUNG:
        1. Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát t·ª± nhi√™n, ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu, th√¢n thi·ªán v·ªõi tr·∫ª em.
        2. Tr√°nh t·ª´ ng·ªØ H√°n Vi·ªát ph·ª©c t·∫°p ho·∫∑c c√¢u vƒÉn qu√° d√†i d√≤ng.
        3. C√°c con s·ªë trong ƒë·ªÅ b√†i ph·∫£i h·ª£p l√Ω v·ªõi th·ª±c t·∫ø.
        4. N·∫øu l√† b√†i to√°n ƒë·ªë, h√£y d√πng t√™n th√¢n thu·ªôc (Lan, Minh...) ho·∫∑c con v·∫≠t.
        5. KH√îNG S·ª¨ D·ª§NG c√°c ƒë∆°n v·ªã ƒëo l∆∞·ªùng kh√¥ng ph·ªï bi·∫øn v·ªõi tr·∫ª nh·ªè nh∆∞: "t√°" (thay b·∫±ng 12), "y·∫øn/t·∫°/t·∫•n" (n·∫øu ch∆∞a h·ªçc), "l·∫°ng". H√£y ∆∞u ti√™n d√πng s·ªë c·ª• th·ªÉ.
        
        Y√äU C·∫¶U OUTPUT:
        Tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON (JSON Array) ch·ª©a c√°c object c√¢u h·ªèi. V√≠ d·ª•:
        [
          { "type": "mcq", ... },
          { "type": "sorting", ... }
        ]
        
        C·∫§U TR√öC M·ªñI C√ÇU H·ªéI (SCHEMA):
        1. Tr·∫Øc nghi·ªám ("mcq") ho·∫∑c ƒêi·ªÅn t·ª´ ("fill_blank") ho·∫∑c So s√°nh ("comparison"):
        {
          "type": "mcq", 
          "text": "N·ªôi dung c√¢u h·ªèi",
          "options": ["A", "B", "C", "D"], 
          "correctVal": "Gi√° tr·ªã ƒë√∫ng (string ho·∫∑c number)",
          "explanation": "Gi·∫£i th√≠ch chi ti·∫øt",
          "level": 2, 
          "topic": "arithmetic"
        }

        2. S·∫Øp x·∫øp ("sorting"):
        {
          "type": "sorting",
          "text": "ƒê·ªÅ b√†i",
          "items": ["10", "5", "8"], 
          "correctOrder": ["5", "8", "10"], 
          "explanation": "...",
          "level": 2, 
          "topic": "arithmetic"
        }

        3. Gh√©p c·∫∑p ("matching"):
        {
          "type": "matching",
          "text": "ƒê·ªÅ b√†i",
          "pairs": [
            {"left": "2+2", "right": "4"},
            {"left": "5x2", "right": "10"}
          ],
          "explanation": "...",
          "level": 2, 
          "topic": "arithmetic"
        }
        
        4. Y√™u c·∫ßu ƒë·∫∑c bi·ªát cho H√åNH H·ªåC ("geometry"):
        N·∫øu c√¢u h·ªèi y√™u c·∫ßu t√≠nh chu vi, di·ªán t√≠ch, ho·∫∑c nh·∫≠n bi·∫øt h√¨nh, h√£y th√™m tr∆∞·ªùng **"svgContent"**.
        **"svgContent"**: "Chu·ªói ch·ª©a c√°c th·∫ª SVG con (nh∆∞ <rect>, <path>, <circle>, <text>...) ƒë·ªÉ v·∫Ω h√¨nh minh h·ªça. KH√îNG bao g·ªìm th·∫ª <svg> bao ngo√†i. ViewBox m·∫∑c ƒë·ªãnh l√† 0 0 300 200. H√£y v·∫Ω n√©t ƒë·∫≠m (stroke-width='3'), m√†u ƒëen ho·∫∑c xanh d∆∞∆°ng, fill='none' ho·∫∑c m√†u nh·∫°t."

        V√≠ d·ª• c√¢u h·ªèi h√¨nh h·ªçc:
        {
          "type": "mcq",
          "text": "T√≠nh chu vi h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i 10cm, chi·ªÅu r·ªông 5cm.",
          "options": ["30cm", "15cm", "50cm", "25cm"],
          "correctVal": "30cm",
          "level": 2,
          "topic": "geometry",
          "svgContent": "<rect x='50' y='50' width='200' height='100' stroke='#4F46E5' stroke-width='3' fill='#E0E7FF' /><text x='150' y='170' text-anchor='middle' fill='black'>10cm</text><text x='260' y='100' text-anchor='middle' fill='black'>5cm</text>"
        }
        `;

    const safetySuffix = attempt > 0
        ? '\n\nCH·ªà TR·∫¢ V·ªÄ JSON THU·∫¶N. KH√îNG D√ôNG ``` HO·∫∂C GI·∫¢I TH√çCH. N·∫øu tr∆∞·ªõc ƒë√≥ b·∫°n tr·∫£ v·ªÅ sai ƒë·ªãnh d·∫°ng, h√£y s·ª≠a l·∫°i ƒë√∫ng JSON.'
        : '';

    const fullPrompt = jsonInstruction + "\n\n" + "N·ªòI DUNG Y√äU C·∫¶U C·ª§ TH·ªÇ:\n" + prompt + safetySuffix;

    // G·ªçi Gemini
    const result = await model.generateContent(fullPrompt);
    const response = await result.response;

    // V·ªõi responseMimeType=application/json, d√πng .text() v·∫´n nh·∫≠n chu·ªói JSON
    const text = response.text();
    if (!text) throw new HttpsError('internal', "Gemini tr·∫£ v·ªÅ r·ªóng.");

    let jsonStr = text.trim();
    if (jsonStr.startsWith("```")) {
        jsonStr = jsonStr.replace(/^```json/i, "").replace(/^```/, "").replace(/```$/, "");
    }

    try {
        const parsed = JSON.parse(jsonStr);
        if (Array.isArray(parsed)) return parsed;
        if (parsed.questions && Array.isArray(parsed.questions)) return parsed.questions;
        return [parsed];
    } catch (parseErr) {
        console.error(`L·ªói Parse JSON t·ª´ Gemini (attempt=${attempt}):`, parseErr, "Raw Text:", text);
        throw new HttpsError('internal', "L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu t·ª´ AI.");
    }
};

exports.generateQuestions = onCall({ 
    secrets: [apiKey],
    timeoutSeconds: 60,
    memory: "512MiB",
    region: "us-central1"
}, async (request) => {
    try {
        const prompt = request.data.prompt;
        if (!prompt) {
            throw new HttpsError('invalid-argument', 'Client kh√¥ng g·ª≠i prompt.');
        }

        const GEMINI_API_KEY = apiKey.value();
        if (!GEMINI_API_KEY) {
            throw new HttpsError('failed-precondition', 'Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY.');
        }

        // Kh·ªüi t·∫°o Gemini v·ªõi y√™u c·∫ßu JSON thu·∫ßn
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-2.0-flash",
            generationConfig: {
                responseMimeType: "application/json"
            }
        });

        // Th·ª≠ g·ªçi 1 l·∫ßn; n·∫øu parse l·ªói, retry th√™m 1 l·∫ßn v·ªõi prompt si·∫øt ch·∫∑t h∆°n
        try {
            return await callGeminiForQuestions(model, prompt, 0);
        } catch (firstError) {
            console.warn("Gemini JSON parse failed, retrying once...", firstError);
            return await callGeminiForQuestions(model, prompt, 1);
        }

    } catch (error) {
        console.error("CRITICAL ERROR:", error.message);
        throw new HttpsError('internal', error.message);
    }
});

// --- Cloud Function an to√†n ƒë·ªÉ c·∫≠p nh·∫≠t piggyBank ---
exports.updatePiggyBank = onCall(
    {
        timeoutSeconds: 15,
        memory: "256MiB",
        region: "us-central1",
    },
    async (request) => {
        const auth = request.auth;
        if (!auth || !auth.uid) {
            throw new HttpsError("unauthenticated", "Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi c·∫≠p nh·∫≠t ƒëi·ªÉm.");
        }

        const { delta, reason, appId: clientAppId } = request.data || {};

        if (typeof delta !== "number" || !Number.isFinite(delta) || delta === 0) {
            throw new HttpsError(
                "invalid-argument",
                "Gi√° tr·ªã delta kh√¥ng h·ª£p l·ªá. Ph·∫£i l√† s·ªë kh√°c 0."
            );
        }

        if (Math.abs(delta) > 100000) {
            throw new HttpsError(
                "failed-precondition",
                "Delta qu√° l·ªõn, thao t√°c b·ªã ch·∫∑n ƒë·ªÉ tr√°nh gian l·∫≠n."
            );
        }

        const appId = APP_ID || clientAppId;
        if (!appId) {
            throw new HttpsError(
                "failed-precondition",
                "Thi·∫øu APP_ID tr√™n server. Vui l√≤ng c·∫•u h√¨nh FIREBASE_APP_ID ho·∫∑c g·ª≠i appId h·ª£p l·ªá."
            );
        }

        const userId = auth.uid;
        const userRef = db.doc(`artifacts/${appId}/public/data/math_user_data/${userId}`);

        try {
            const result = await db.runTransaction(async (tx) => {
                const snap = await tx.get(userRef);
                if (!snap.exists) {
                    throw new HttpsError(
                        "not-found",
                        "Kh√¥ng t√¨m th·∫•y h·ªì s∆° h·ªçc t·∫≠p c·ªßa b√©."
                    );
                }

                const data = snap.data();
                const current = typeof data.piggyBank === "number" ? data.piggyBank : 0;
                const next = current + delta;

                if (next < 0) {
                    throw new HttpsError(
                        "failed-precondition",
                        "S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch."
                    );
                }

                const logs = Array.isArray(data.logs) ? data.logs : [];
                const serverLog = {
                    type: "piggyBank_update",
                    delta,
                    before: current,
                    after: next,
                    reason: reason || "system",
                    ts: Date.now(),
                };

                tx.update(userRef, {
                    piggyBank: next,
                    logs: [...logs, serverLog],
                });

                return { before: current, after: next };
            });

            return { success: true, ...result };
        } catch (error) {
            if (error instanceof HttpsError) {
                throw error;
            }
            console.error("L·ªói updatePiggyBank:", error);
            throw new HttpsError(
                "internal",
                "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm ti·∫øt ki·ªám. Vui l√≤ng th·ª≠ l·∫°i sau."
            );
        }
    }
);

==================================================
FILE PATH: functions\package.json
==================================================
{
  "name": "functions",
  "description": "Cloud Functions for Math App",
  "scripts": {
    "lint": "eslint .",
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "20"
  },
  "main": "index.js",
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "firebase-admin": "^11.8.0",
    "firebase-functions": "^4.3.1"
  },
  "devDependencies": {
    "eslint": "^8.15.0",
    "eslint-config-google": "^0.14.0"
  },
  "private": true
}


==================================================
FILE PATH: index.html
==================================================
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>math-app</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


==================================================
FILE PATH: package.json
==================================================
{
  "name": "math-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "test": "vitest",
    "test:coverage": "vitest run --coverage",
    "preview": "vite preview"
  },
  "dependencies": {
    "firebase": "^12.6.0",
    "lucide-react": "^0.555.0",
    "mathjs": "^15.1.0",
    "html-react-parser": "^5.1.5",
    "react": "^19.2.0",
    "react-dom": "^19.2.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4",
    "vitest": "^4.0.14"
  }
}


==================================================
FILE PATH: postcss.config.js
==================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


==================================================
FILE PATH: README.md
==================================================
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.


==================================================
FILE PATH: src\App.css
==================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


==================================================
FILE PATH: src\App.jsx
==================================================
import React, { useState, useEffect, useRef } from 'react';
import { CheckCircle, AlertTriangle, Loader, WifiOff } from 'lucide-react';
import { doc, updateDoc, getDoc } from 'firebase/firestore';
import { db, appId } from './lib/firebase';

// ‚úÖ FIX L·ªñI IMPORT ·ªû ƒê√ÇY: T√°ch import ra ƒë√∫ng file
import { fmt } from './lib/utils.js';
import { TOPIC_TRANSLATIONS } from './lib/constants.js'; 
import { secureUpdatePiggyBank } from './lib/piggyBank.js';

// --- CUSTOM HOOKS ---
import { useMathAuth } from './hooks/useMathAuth';
import { useUserData } from './hooks/useUserData';
import { useQuizRunner } from './hooks/useQuizRunner';

// Components
import AuthScreen from './components/AuthScreen';
import HomeScreen from './components/HomeScreen';
// Lazy load
const ProfileScreen = React.lazy(() => import('./components/ProfileScreen'));
const UserProfileScreen = React.lazy(() => import('./components/UserProfileScreen'));
const QV = React.lazy(() => import('./components/QuizScreen'));
const ResultScreen = React.lazy(() => import('./components/ResultScreen'));
const ReportScreen = React.lazy(() => import('./components/ReportScreen'));
const ConfigScreen = React.lazy(() => import('./components/ConfigScreen'));
const ShopScreen = React.lazy(() => import('./components/ShopScreen'));
const ParentGateModal = React.lazy(() => import('./components/ParentGateModal'));

// --- GLOBAL STYLES ---
const GLOBAL_STYLES = `
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap');
  body { font-family: 'Nunito', sans-serif; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .animate-shake { animation: shake 0.5s ease-in-out; }
  @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
  .animation-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
`;

const MathApp = () => {
    // 1. Hooks qu·∫£n l√Ω Logic
    const { appUser, setAppUser, isAuthReady, authError, setAuthError, login, logout, deviceSessions, remoteLogoutDevice } = useMathAuth();
    
    const { 
        profiles, setProfiles, piggyBank, setPiggyBank, 
        redeemRequests, userStats, setUserStats, 
        config, setConfig, isLoadingData, saveData, redeemCash,
        parentSettings, updateParentSettings, approveRedemption, rejectRedemption
    } = useUserData(appUser);
    
    // 2. UI State
    const [gameState, setGameState] = useState('auth');
    const [currentProfile, setCurrentProfile] = useState(null);
    const [isCreatingProfile, setIsCreatingProfile] = useState(false);
    const [newProfileName, setNewProfileName] = useState("");
    const [newProfileAvatar, setNewProfileAvatar] = useState("üê∂"); 
    const [appError, setAppError] = useState(null);
    const [notification, setNotification] = useState(null);
    const [parentGateRequest, setParentGateRequest] = useState(null);
    const [parentAccessUnlocked, setParentAccessUnlocked] = useState(false);
    const parentGateTimerRef = useRef(null);
    const parentAccessValid = parentAccessUnlocked;

    const requestParentGate = (reason, onApproved) => {
        if (parentAccessValid) {
            onApproved();
            return;
        }
        setParentGateRequest({ reason, onApproved });
    };

    const handleParentGateSuccess = () => {
        const duration = (parentSettings?.unlockedSeconds || 300) * 1000;
        setParentAccessUnlocked(true);
        if (parentGateTimerRef.current) {
            clearTimeout(parentGateTimerRef.current);
            parentGateTimerRef.current = null;
        }
        parentGateTimerRef.current = setTimeout(() => {
            setParentAccessUnlocked(false);
            parentGateTimerRef.current = null;
        }, duration);
        const callback = parentGateRequest?.onApproved;
        setParentGateRequest(null);
        if (callback) callback();
    };
    useEffect(() => {
        return () => {
            if (parentGateTimerRef.current) clearTimeout(parentGateTimerRef.current);
        };
    }, []);


    // 3. Game Runner Hook
    const gameRunner = useQuizRunner(currentProfile, config, userStats);

    const gameStateRef = useRef(gameState);
    useEffect(() => { gameStateRef.current = gameState; }, [gameState]);

    const showNotification = (type, message) => {
        setNotification({ type, message });
        setTimeout(() => { setNotification(null); }, 3000);
    };

    // --- EFFECT: Router c∆° b·∫£n ---
    useEffect(() => {
        if (!isAuthReady) return;
        
        const current = gameStateRef.current;

        if (!appUser) {
            if (current !== 'auth') {
                const timer = setTimeout(() => setGameState('auth'), 0);
                return () => clearTimeout(timer);
            }
        } else {
            if (current === 'auth') {
                const timer = setTimeout(() => setGameState('profile_select'), 0);
                return () => clearTimeout(timer);
            }
        }
    }, [appUser, isAuthReady, gameState]);

    // --- C·∫¨P NH·∫¨T: Logic t·ª± ƒë·ªông ch·ªçn l·∫°i Profile c≈© ---
    useEffect(() => {
        // Ch·ªâ ch·∫°y khi ƒë√£ t·∫£i xong d·ªØ li·ªáu v√† ch∆∞a ch·ªçn profile n√†o
        if (!isLoadingData && profiles.length > 0 && !currentProfile && gameState === 'profile_select') {
            const lastProfileId = localStorage.getItem('math_app_last_profile_id');
            if (lastProfileId) {
                const foundProfile = profiles.find(p => p.id === lastProfileId);
                if (foundProfile) {
                    console.log("Auto restoring profile:", foundProfile.name);
                    
                    // ‚úÖ FIX: D√πng setTimeout ƒë·ªÉ ƒë·∫©y vi·ªác update state ra kh·ªèi lu·ªìng render hi·ªán t·∫°i
                    // ƒêi·ªÅu n√†y gi√∫p tr√°nh l·ªói "set-state-in-effect" c·ªßa ESLint
                    setTimeout(() => {
                        setCurrentProfile(foundProfile);
                        setGameState('home');
                    }, 0);
                }
            }
        }
    }, [isLoadingData, profiles, currentProfile, gameState]);

    // --- EFFECT: Background Preloading ---
    const { generateQuizQuestions, setPreloadedQuiz } = gameRunner;
    useEffect(() => {
        if (gameState === 'result' && currentProfile) {
            const preload = async () => {
                const qs = await generateQuizQuestions(true);
                if (qs) setPreloadedQuiz(qs);
            };
            preload();
        }
    }, [gameState, currentProfile, generateQuizQuestions, setPreloadedQuiz]);

    // --- HANDLERS ---
    const handleLogin = async (user) => {
        const success = await login(user);
        if (success) showNotification('success', `Ch√†o m·ª´ng ${user.displayName || 'B·∫°n'}!`);
    };

    const handleLogout = async (force = false) => {
        if (force || window.confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
            await logout();
            setCurrentProfile(null);
            gameRunner.setPreloadedQuiz(null); // Clear cache
            setGameState('auth');
        }
    };

    // H√†m wrapper ƒë·ªÉ v·ª´a set profile v·ª´a chuy·ªÉn m√†n h√¨nh
    // --- C·∫¨P NH·∫¨T 2: L∆∞u profile id khi ch·ªçn ---
    const handleSelectProfile = (profile) => {
        localStorage.setItem('math_app_last_profile_id', profile.id); // <--- L∆ØU L·∫†I
        setCurrentProfile(profile);
        setGameState('home');
    };

    const handleStartQuiz = async () => {
        if (!currentProfile) { showNotification('error', "Ch·ªçn h·ªì s∆° tr∆∞·ªõc!"); return; }
        gameRunner.setIsGenerating(true);
        
        if (gameRunner.preloadedQuiz) {
            gameRunner.startSession(gameRunner.preloadedQuiz);
            gameRunner.setPreloadedQuiz(null);
        } else {
            const questions = await gameRunner.generateQuizQuestions(false);
            if (questions) gameRunner.startSession(questions);
            else setAppError("Kh√¥ng t·∫°o ƒë∆∞·ª£c c√¢u h·ªèi. Th·ª≠ l·∫°i sau!");
        }
        
        gameRunner.setIsGenerating(false);
        if(!appError) setGameState('playing');
    };

    const handleNextQuestionWrapper = () => {
        const hasMore = gameRunner.nextQuestion();
        if (!hasMore) finishGame();
    };

    const finishGame = async () => {
        const newScore = gameRunner.sessionScore;
        setGameState('result');

        // N·∫øu l√† kh√°ch (·∫©n danh), ch·ªâ c·∫≠p nh·∫≠t UI local
        if (!appUser || appUser.isAnon) {
            setPiggyBank(prev => prev + newScore);
            return;
        }

        try {
            // C·∫≠p nh·∫≠t piggyBank an to√†n qua Cloud Function
            try {
                const res = await secureUpdatePiggyBank(newScore, 'quiz_reward');
                if (res?.success && typeof res.after === 'number') {
                    setPiggyBank(res.after);
                } else {
                    setPiggyBank(prev => prev + newScore);
                }
            } catch (err) {
                console.error("L·ªói c·∫≠p nh·∫≠t piggyBank qua Cloud Function:", err);
                setPiggyBank(prev => prev + newScore);
            }

            // C·∫≠p nh·∫≠t stats & logs (kh√¥ng ƒë·ª•ng v√†o piggyBank n·ªØa)
            let newStats = { ...userStats };
            if (!newStats[currentProfile.id]) newStats[currentProfile.id] = { total_questions: 0, total_correct: 0, topics: {} };
            let pStats = newStats[currentProfile.id];
            
            gameRunner.history.forEach(q => {
                pStats.total_questions = (pStats.total_questions || 0) + 1;
                if (q.isCorrect) pStats.total_correct = (pStats.total_correct || 0) + 1;
                if (!pStats.topics) pStats.topics = {};
                const topicId = TOPIC_TRANSLATIONS[String(q.topic).toLowerCase().trim()] || q.topic || 'arithmetic';
                if (!pStats.topics[topicId]) pStats.topics[topicId] = { total: 0, correct: 0 };
                pStats.topics[topicId].total += 1;
                if (q.isCorrect) pStats.topics[topicId].correct += 1;
            });
            
            setUserStats(newStats);
            const logEntry = {
                id: crypto.randomUUID(), profileId: currentProfile.id, timestamp: Date.now(), score: newScore,
                difficultyMode: config.difficultyMode, semester: config.semester,
                questions: gameRunner.history 
            };
            
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'math_user_data', appUser.uid);
            const snap = await getDoc(userDocRef);
            const currentLogs = snap.exists() ? (snap.data().logs || []) : [];
            await updateDoc(userDocRef, { 
                stats: newStats, 
                logs: [...currentLogs, logEntry] 
            });
        } catch (e) { console.error("L·ªói l∆∞u k·∫øt qu·∫£:", e); }
    };

    const createProfileWrapper = async () => {
        if (!newProfileName.trim()) return;
        const newProfile = { id: `profile_${Date.now()}`, name: newProfileName, avatar: newProfileAvatar };
        const updatedProfiles = [...profiles, newProfile];
        setProfiles(updatedProfiles);
        await saveData({ profiles: updatedProfiles });
        setNewProfileName(""); setIsCreatingProfile(false); setCurrentProfile(newProfile);
        showNotification('success', "ƒê√£ t·∫°o h·ªì s∆° m·ªõi!");
    };

    const saveConfigWrapper = (newConfig) => {
        setConfig(newConfig);
        saveData({ config: newConfig });
        gameRunner.setPreloadedQuiz(null);
        showNotification('success', "ƒê√£ l∆∞u c·∫•u h√¨nh!");
        setGameState('home');
    };

    const handleRedeemCash = async (item) => {
        const confirmMsg = `ƒê·ªïi qu√†: ${item.name}? M·∫•t ${fmt(item.value)}ƒë.`;
        if (!window.confirm(confirmMsg)) return;

        const result = await redeemCash(item);

        if (result.success) {
            showNotification('success', result.message);
        } else {
            showNotification('error', result.message);
        }
    };

    // --- RENDER HELPERS ---
    const getNotificationClass = () => {
        const base = "absolute top-10 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl font-black text-sm text-white flex items-center gap-3 whitespace-nowrap animation-fade-in";
        const color = notification?.type === 'success' ? 'bg-green-500' : 'bg-red-500';
        return `${base} ${color}`;
    };

    if (!isAuthReady || isLoadingData) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader className="animate-spin text-indigo-500"/></div>;

    const renderScreen = () => {
        switch (gameState) {
            case 'auth': 
                return <AuthScreen onLoginSuccess={handleLogin} errorMsg={authError} setErrorMsg={setAuthError} />;
            case 'profile_select': 
                return <ProfileScreen 
                    profiles={profiles} 
                    setCurrentProfile={handleSelectProfile} 
                    isCreatingProfile={isCreatingProfile} 
                    setIsCreatingProfile={setIsCreatingProfile} 
                    newProfileName={newProfileName} 
                    setNewProfileName={setNewProfileName} 
                    newProfileAvatar={newProfileAvatar} 
                    setNewProfileAvatar={setNewProfileAvatar} 
                    createProfile={createProfileWrapper} 
                    appUser={appUser} 
                    isLoading={isLoadingData} // <--- TRUY·ªÄN PROP N√ÄY V√ÄO
                />;
            case 'home': 
                return <HomeScreen piggyBank={piggyBank} setGameState={setGameState} currentProfile={currentProfile} isGenerating={gameRunner.isGenerating} handleStartQuiz={handleStartQuiz} config={config} setCurrentProfile={setCurrentProfile} appError={appError} setAppError={setAppError} onOpenConfig={() => requestParentGate('config', () => setGameState('config'))} />;
            case 'playing': 
                return <React.Suspense fallback={<Loader/>}><QV quizData={gameRunner.quizData} currentQIndex={gameRunner.currentQIndex} setGameState={setGameState} sessionScore={gameRunner.sessionScore} selectedOption={gameRunner.selectedOption} isSubmitted={gameRunner.isSubmitted} handleSelectOption={gameRunner.handleSelectOption} handleNextQuestion={handleNextQuestionWrapper} /></React.Suspense>;
            case 'result': 
                return <ResultScreen history={gameRunner.history} sessionScore={gameRunner.sessionScore} setGameState={setGameState} currentProfile={currentProfile} />;
            case 'config': 
                return <ConfigScreen config={config} saveConfig={saveConfigWrapper} setGameState={setGameState} />;
            case 'user_profile': 
                return <UserProfileScreen appUser={appUser} setAppUser={setAppUser} setGameState={setGameState} onLogout={handleLogout} profiles={profiles} onSaveProfiles={(p) => { setProfiles(p); saveData({ profiles: p }); }} deviceSessions={deviceSessions} onRemoteLogoutDevice={remoteLogoutDevice} parentSettings={parentSettings} onUpdateParentSettings={updateParentSettings} />;
            case 'shop': 
                return <ShopScreen piggyBank={piggyBank} setGameState={setGameState} redeemCash={handleRedeemCash} redemptionRequests={redeemRequests} onApproveRequest={approveRedemption} onRejectRequest={rejectRedemption} ensureParentAccess={requestParentGate} parentAccessValid={parentAccessValid} />;
            case 'report': 
                return <ReportScreen currentProfile={currentProfile} appUser={appUser} setGameState={setGameState} setConfig={saveConfigWrapper} />;
            default: 
                return <AuthScreen onLoginSuccess={handleLogin} />;
        }
    };

    return (
        <div className="fixed inset-0 bg-slate-100 flex items-center justify-center select-none overflow-hidden">
            <style>{GLOBAL_STYLES}</style>

            <div className="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative flex flex-col sm:rounded-[2.5rem] sm:h-[95vh] sm:border-[8px] sm:border-slate-200">
                <React.Suspense fallback={<div className="flex justify-center items-center h-full"><Loader className="animate-spin"/></div>}>
                    {renderScreen()}
                </React.Suspense>
                
                {gameState === 'home' && gameRunner.preloadedQuiz && (
                    <div className="absolute top-24 right-6 text-[10px] font-bold text-green-500 bg-green-100 px-2 py-1 rounded-full flex items-center gap-1 animate-fade-in">
                        ‚ö° S·∫µn s√†ng
                    </div>
                )}
                
                {notification && (
                    <div className={getNotificationClass()}>
                        {notification.type === 'success' ? <CheckCircle size={20}/> : <AlertTriangle size={20}/>} 
                        {notification.message}
                    </div>
                )}

                <React.Suspense fallback={null}>
                    {parentGateRequest && (
                        <ParentGateModal
                            isOpen={Boolean(parentGateRequest)}
                            onClose={() => setParentGateRequest(null)}
                            onSuccess={handleParentGateSuccess}
                            parentSettings={parentSettings}
                            reasonLabel={parentGateRequest?.reason === 'config' ? 'C·∫•u h√¨nh h·ªçc t·∫≠p' : 'C·ª≠a h√†ng ph·ª• huynh'}
                        />
                    )}
                </React.Suspense>
            </div>
        </div>
    );
};

export default MathApp;

==================================================
FILE PATH: src\components\AuthScreen.jsx
==================================================
import React, { useState } from 'react';
import { Mail, Key, UserPlus, LogIn, AlertTriangle, Loader, ShieldCheck, UserCheck, Send } from 'lucide-react';
import { ClayButton } from '../lib/helpers.jsx';
import { getDeviceId } from '../lib/utils.js';
import { 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    updateProfile, 
    signInAnonymously,
    sendPasswordResetEmail
} from 'firebase/auth';
import { auth } from '../lib/firebase';

const AuthScreen = ({ onLoginSuccess, errorMsg, setErrorMsg }) => {
    const [isRegister, setIsRegister] = useState(false);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [displayName, setDisplayName] = useState(''); // Th√™m t√™n hi·ªÉn th·ªã khi ƒëƒÉng k√Ω
    const [loading, setLoading] = useState(false);
    const [resetLoading, setResetLoading] = useState(false);
    const [resetInfo, setResetInfo] = useState(null);

    const handleAuth = async () => {
        if (!email || !password) { setErrorMsg("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u"); return; }
        if (password.length < 6) { setErrorMsg("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n"); return; }
        if (isRegister && !displayName) { setErrorMsg("Vui l√≤ng nh·∫≠p t√™n hi·ªÉn th·ªã"); return; }
        
        setLoading(true);
        setErrorMsg(null);
        try {
            let userCredential;
            if (isRegister) {
                // ƒêƒÉng k√Ω m·ªõi
                userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // C·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã ngay sau khi t·∫°o
                await updateProfile(userCredential.user, {
                    displayName: displayName
                });
            } else {
                // ƒêƒÉng nh·∫≠p
                userCredential = await signInWithEmailAndPassword(auth, email, password);
            }

            const user = userCredential.user;
            // Chu·∫©n h√≥a object user ƒë·ªÉ tr·∫£ v·ªÅ App.jsx
            const appUser = {
                email: user.email,
                uid: user.uid,
                displayName: user.displayName || displayName || 'Ph·ª• Huynh',
                devices: [getDeviceId()], 
                createdAt: user.metadata.creationTime,
                isAnon: false
            };
            
            await onLoginSuccess(appUser);

        } catch (e) {
            console.error(e);
            let msg = "L·ªói k·∫øt n·ªëi: " + e.message;
            if (e.code === 'auth/email-already-in-use') msg = "Email n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω!";
            if (e.code === 'auth/invalid-email') msg = "Email kh√¥ng h·ª£p l·ªá!";
            if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') msg = "Sai email ho·∫∑c m·∫≠t kh·∫©u!";
            setErrorMsg(msg);
        } finally {
            setLoading(false);
        }
    };

    const handleAnonLogin = async () => {
        setLoading(true);
        setErrorMsg(null);
        try {
            const result = await signInAnonymously(auth);
            const anonUser = {
                email: "anon@temp.com",
                uid: result.user.uid,
                displayName: 'Kh√°ch',
                devices: [getDeviceId()], 
                createdAt: Date.now(),
                isAnon: true
            };
            await onLoginSuccess(anonUser);
        } catch(e) {
            setErrorMsg("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh: " + e.message);
        } finally {
            setLoading(false);
        }
    };

    const handleResetPassword = async () => {
        if (!email) {
            setErrorMsg("Vui l√≤ng nh·∫≠p email ƒë·ªÉ kh√¥i ph·ª•c m·∫≠t kh·∫©u");
            return;
        }
        setResetInfo(null);
        setErrorMsg(null);
        setResetLoading(true);
        try {
            await sendPasswordResetEmail(auth, email);
            setResetInfo("ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!");
        } catch (error) {
            console.error(error);
            let msg = "Kh√¥ng th·ªÉ g·ª≠i email. Vui l√≤ng th·ª≠ l·∫°i.";
            if (error.code === 'auth/user-not-found') msg = "Email n√†y ch∆∞a ƒëƒÉng k√Ω.";
            setErrorMsg(msg);
        } finally {
            setResetLoading(false);
        }
    };

    return (
        <div className="flex flex-col h-full bg-slate-50 p-6 justify-center">
            <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 text-center">
                <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner">üîê</div>
                <h1 className="text-3xl font-black text-slate-800 mb-2">{isRegister ? 'T·∫°o T√†i Kho·∫£n' : 'ƒêƒÉng Nh·∫≠p'}</h1>
                <p className="text-slate-400 font-medium mb-8 text-sm">Ph·ª• huynh ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô k·∫øt qu·∫£ h·ªçc t·∫≠p cho b√©.</p>

                {resetInfo && (
                    <div className="mb-4 bg-green-50 text-green-600 p-3 rounded-xl border border-green-100 flex items-center gap-2 text-xs font-bold animate-fade-in">
                        <Send size={16}/> {resetInfo}
                    </div>
                )}

                {errorMsg && (
                    <div className="mb-4 bg-red-50 text-red-600 p-3 rounded-xl border border-red-100 flex items-center gap-2 text-xs font-bold animate-shake">
                        <AlertTriangle size={16}/> {errorMsg}
                    </div>
                )}

                <div className="space-y-4 mb-6">
                    {isRegister && (
                        <div className="relative">
                            <UserPlus className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
                            <input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} placeholder="T√™n hi·ªÉn th·ªã (VD: B·ªë Tu·∫•n)" className="w-full h-14 pl-12 pr-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all"/>
                        </div>
                    )}
                    <div className="relative">
                        <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email ph·ª• huynh" className="w-full h-14 pl-12 pr-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all"/>
                    </div>
                    <div className="relative">
                        <Key className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
                        <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="M·∫≠t kh·∫©u" className="w-full h-14 pl-12 pr-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all"/>
                    </div>
                </div>

                <ClayButton onClick={handleAuth} disabled={loading} colorClass="bg-indigo-600 text-white" className="w-full h-14 flex items-center justify-center gap-2 font-black text-lg mb-4">
                    {loading ? <Loader className="animate-spin"/> : (isRegister ? <UserPlus/> : <LogIn/>)}
                    {isRegister ? 'ƒêƒÉng K√Ω Ngay' : 'ƒêƒÉng Nh·∫≠p'}
                </ClayButton>

                <button onClick={() => { setIsRegister(!isRegister); setErrorMsg(null); setResetInfo(null); }} className="text-sm font-bold text-indigo-500 hover:underline mb-1">
                    {isRegister ? 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p' : 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω m·ªõi'}
                </button>
                {!isRegister && (
                    <button
                        onClick={handleResetPassword}
                        disabled={resetLoading}
                        className="text-xs font-bold text-slate-400 hover:text-indigo-500 mb-4"
                    >
                        {resetLoading ? 'ƒêang g·ª≠i...' : 'Qu√™n m·∫≠t kh·∫©u? Nh·∫≠n email kh√¥i ph·ª•c'}
                    </button>
                )}

                <div className="text-xs text-slate-400 font-medium mb-3">HO·∫∂C</div>
                <ClayButton onClick={handleAnonLogin} disabled={loading} colorClass="bg-slate-200 text-slate-700" className="w-full h-12 flex items-center justify-center gap-2 font-bold text-sm">
                    {loading ? <Loader className="animate-spin"/> : <UserCheck/>}
                    D√πng th·ª≠ (Kh√¥ng l∆∞u d·ªØ li·ªáu l√¢u d√†i)
                </ClayButton>
            </div>
            
            <div className="mt-8 text-center">
                <div className="inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-full text-xs font-bold border border-green-200">
                    <ShieldCheck size={14}/> B·∫£o m·∫≠t b·ªüi Google Firebase
                </div>
            </div>
        </div>
    );
};

export default AuthScreen;

==================================================
FILE PATH: src\components\ConfigScreen.jsx
==================================================
import React, { useState, useEffect } from 'react';
import {
  Settings, XCircle, Trophy, ListChecks, CheckCircle,
  Save, Sparkles, HelpCircle
} from 'lucide-react';
import { TOPICS_LIST, ICON_MAP, SEMESTER_DEFAULT_TOPICS } from '../lib/constants';
import { ClayButton } from '../lib/helpers'; // T·∫≠n d·ª•ng ClayButton cho ƒë·ªìng b·ªô

const ConfigScreen = ({ config, saveConfig, setGameState }) => {
  const [localConfig, setLocalConfig] = useState(config);

  useEffect(() => {
    setLocalConfig(config);
  }, [config]);

  const toggleTopic = (topicId) => {
    const selectedTopics = localConfig.selectedTopics.includes(topicId)
      ? localConfig.selectedTopics.filter(id => id !== topicId)
      : [...localConfig.selectedTopics, topicId];
    setLocalConfig({ ...localConfig, selectedTopics });
  };

  const handleSemesterChange = (semester) => {
    setLocalConfig({
      ...localConfig,
      semester,
      selectedTopics: SEMESTER_DEFAULT_TOPICS[semester] || [],
    });
  };
  
  // UI Definitions
  const difficultyLevels = {
    easy: { label: 'Kh·ªüi ƒë·ªông', sub: 'D√†nh cho b√© c·∫ßn c·ªßng c·ªë g·ªëc (Level 1-2)', color: 'green', icon: Trophy },
    medium: { label: 'Ti√™u chu·∫©n', sub: 'B√°m s√°t SGK tr√™n l·ªõp (Level 2-3)', color: 'blue', icon: ListChecks },
    hard: { label: 'Th·∫ßn ƒë·ªìng', sub: 'Th·ª≠ th√°ch t∆∞ duy & HS Gi·ªèi (Level 3-4)', color: 'red', icon: Sparkles },
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 relative">
      {/* Header */}
      <div className="flex justify-between items-center p-6 bg-white shadow-sm shrink-0 z-10">
        <h1 className="text-2xl font-black text-slate-800 flex items-center gap-2">
          <Settings className="text-orange-500" />
          C·∫•u H√¨nh H·ªçc T·∫≠p
        </h1>
        <ClayButton onClick={() => setGameState('home')} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0">
          <XCircle size={24} className="text-slate-400 hover:text-red-500 transition-colors" />
        </ClayButton>
      </div>

      <div className="flex-grow p-4 overflow-y-auto space-y-6 no-scrollbar pb-24">
        {/* Difficulty Section */}
        <section>
          <h2 className="text-lg font-black text-slate-700 mb-3 px-2">ƒê·ªô kh√≥</h2>
          <div className="grid grid-cols-3 gap-3">
            {Object.entries(difficultyLevels).map(([key, { label, sub, color, icon: LevelIcon }]) => (
              <ClayButton
                key={key}
                onClick={() => setLocalConfig({ ...localConfig, difficultyMode: key })}
                className={`p-3 !rounded-2xl flex flex-col items-center justify-center gap-1 h-32 ${
                  localConfig.difficultyMode === key
                    ? `bg-${color}-100 border-${color}-300 ring-2 ring-${color}-400`
                    : 'bg-white border-slate-100'
                }`}
              >
                <LevelIcon size={24} className={localConfig.difficultyMode === key ? `text-${color}-600` : 'text-slate-300'} />
                <span className={`block text-sm font-black ${localConfig.difficultyMode === key ? `text-${color}-700` : 'text-slate-500'}`}>{label}</span>
                <span className="text-[9px] text-slate-400 leading-tight font-bold">{sub}</span>
              </ClayButton>
            ))}
          </div>
        </section>

        {/* Semester Section */}
        <section>
          <h2 className="text-lg font-black text-slate-700 mb-3 px-2">H·ªçc k·ª≥</h2>
          <div className="grid grid-cols-2 gap-3 p-1">
            {['hk1', 'hk2'].map(sem => (
                <ClayButton
                    key={sem}
                    onClick={() => handleSemesterChange(sem)}
                    colorClass={localConfig.semester === sem ? 'bg-indigo-500 text-white' : 'bg-white text-slate-500'}
                    className="h-12 font-black text-lg"
                >
                    {sem === 'hk1' ? 'H·ªçc k·ª≥ 1' : 'H·ªçc k·ª≥ 2'}
                </ClayButton>
            ))}
          </div>
        </section>

        {/* Topics Section */}
        <section>
          <h2 className="text-lg font-black text-slate-700 mb-3 px-2">Ch·ªß ƒë·ªÅ √¥n t·∫≠p</h2>
          <div className="space-y-2">
            {TOPICS_LIST.map((topic) => {
              const TopicIcon = ICON_MAP[topic.iconName] || HelpCircle;
              const isSelected = localConfig.selectedTopics.includes(topic.id);
              return (
                <ClayButton
                  key={topic.id}
                  onClick={() => toggleTopic(topic.id)}
                  className={`w-full flex items-center p-3 !rounded-xl border transition-all ${
                    isSelected
                      ? 'bg-indigo-50 border-indigo-200'
                      : 'bg-white border-slate-100 opacity-80'
                  }`}
                >
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white shadow-sm' : 'bg-slate-100'}`}>
                     <TopicIcon size={20} className={isSelected ? 'text-indigo-500' : 'text-slate-400'} />
                  </div>
                  <span className={`flex-grow text-left font-bold ${isSelected ? 'text-indigo-700' : 'text-slate-500'}`}>{topic.label}</span>
                  {isSelected && <CheckCircle className="w-5 h-5 text-indigo-500" />}
                </ClayButton>
              );
            })}
          </div>
        </section>
      </div>

      {/* Footer Floating */}
      <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-white via-white to-transparent pt-10">
        <ClayButton
          onClick={() => saveConfig(localConfig)}
          colorClass="bg-indigo-600 text-white border-indigo-700"
          className="w-full h-14 text-xl font-black flex items-center justify-center gap-2 shadow-xl"
        >
          <Save size={24} />
          L∆∞u C·∫•u H√¨nh
        </ClayButton>
      </div>
    </div>
  );
};

export default ConfigScreen;

==================================================
FILE PATH: src\components\FeedbackModal.jsx
==================================================
import React, { useState } from 'react';
import { X, Send, Bug, Lightbulb, MessageSquare, Loader, CheckCircle } from 'lucide-react';
import { addDoc, collection } from 'firebase/firestore';
import { db, appId } from '../lib/firebase';
import { ClayButton } from '../lib/helpers';
import { getDeviceId } from '../lib/utils';

const FeedbackModal = ({ isOpen, onClose, appUser }) => {
    const [type, setType] = useState('bug'); // 'bug' | 'feature' | 'other'
    const [content, setContent] = useState('');
    const [contact, setContact] = useState(appUser?.email || '');
    const [loading, setLoading] = useState(false);
    const [success, setSuccess] = useState(false);

    if (!isOpen) return null;

    const handleSubmit = async () => {
        if (!content.trim()) return;
        setLoading(true);

        try {
            // Chu·∫©n b·ªã d·ªØ li·ªáu
            const feedbackData = {
                type,
                content,
                contact,
                uid: appUser?.uid || 'anonymous',
                userName: appUser?.displayName || 'Unknown',
                deviceId: getDeviceId(),
                timestamp: Date.now(),
                userAgent: navigator.userAgent, // L·∫•y th√¥ng tin tr√¨nh duy·ªát/thi·∫øt b·ªã ƒë·ªÉ debug
                version: '1.0.0-test' // Phi√™n b·∫£n app
            };

            // L∆∞u v√†o collection ri√™ng bi·ªát 'app_feedbacks'
            // L∆∞u √Ω: Kh√¥ng l∆∞u v√†o 'math_user_data' ƒë·ªÉ d·ªÖ qu·∫£n l√Ω
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'app_feedbacks'), feedbackData);

            setSuccess(true);
            setTimeout(() => {
                setSuccess(false);
                setContent('');
                onClose();
            }, 2000);
        } catch (error) {
            console.error("L·ªói g·ª≠i g√≥p √Ω:", error);
            alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animation-fade-in">
            <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden relative animate-shake border-4 border-white">
                
                {/* Header */}
                <div className="bg-indigo-50 p-4 flex justify-between items-center border-b border-indigo-100">
                    <h3 className="font-black text-indigo-700 flex items-center gap-2 text-lg">
                        <MessageSquare size={20}/> G√≥p √ù & B√°o L·ªói
                    </h3>
                    <button onClick={onClose} className="p-1 bg-white rounded-full text-slate-400 hover:text-red-500 transition-colors shadow-sm">
                        <X size={20}/>
                    </button>
                </div>

                {/* Body */}
                <div className="p-5 space-y-4">
                    {success ? (
                        <div className="flex flex-col items-center justify-center py-8 text-green-600 animate-fade-in">
                            <CheckCircle size={64} className="mb-4"/>
                            <span className="font-black text-xl">ƒê√£ g·ª≠i th√†nh c√¥ng!</span>
                            <span className="text-sm font-bold opacity-70">C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p.</span>
                        </div>
                    ) : (
                        <>
                            {/* Type Selector */}
                            <div className="flex gap-2">
                                {[
                                    { id: 'bug', label: 'B√°o L·ªói', icon: Bug, color: 'red' },
                                    { id: 'feature', label: 'G√≥p √Ω', icon: Lightbulb, color: 'yellow' }
                                ].map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setType(item.id)}
                                        className={`flex-1 py-3 rounded-xl border-2 font-bold text-sm flex flex-col items-center gap-1 transition-all ${
                                            type === item.id 
                                            ? `bg-${item.color}-50 border-${item.color}-400 text-${item.color}-700 shadow-inner` 
                                            : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50'
                                        }`}
                                    >
                                        <item.icon size={20}/> {item.label}
                                    </button>
                                ))}
                            </div>

                            {/* Text Area */}
                            <div>
                                <textarea
                                    value={content}
                                    onChange={(e) => setContent(e.target.value)}
                                    placeholder={type === 'bug' ? "M√¥ t·∫£ l·ªói b·∫°n g·∫∑p ph·∫£i..." : "B·∫°n mu·ªën c√≥ th√™m t√≠nh nƒÉng g√¨..."}
                                    className="w-full h-32 p-4 rounded-2xl border-2 border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none font-bold text-slate-700 text-sm resize-none transition-all"
                                ></textarea>
                            </div>

                            {/* Contact Info */}
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Li√™n h·ªá (ƒë·ªÉ t·ª•i m√¨nh ph·∫£n h·ªìi)</label>
                                <input 
                                    type="text" 
                                    value={contact}
                                    onChange={(e) => setContact(e.target.value)}
                                    placeholder="Email ho·∫∑c SƒêT..."
                                    className="w-full h-12 px-4 rounded-xl border-2 border-slate-200 bg-white focus:border-indigo-500 outline-none font-bold text-slate-700 text-sm"
                                />
                            </div>

                            {/* Submit Button */}
                            <ClayButton 
                                onClick={handleSubmit} 
                                disabled={loading || !content.trim()}
                                colorClass="bg-indigo-600 text-white" 
                                className="w-full h-14 flex items-center justify-center gap-2 font-black text-lg !rounded-2xl mt-2"
                            >
                                {loading ? <Loader className="animate-spin"/> : <Send size={20}/>}
                                G·ª≠i Ngay
                            </ClayButton>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
};

export default FeedbackModal;

==================================================
FILE PATH: src\components\HomeScreen.jsx
==================================================
import React from 'react';
import { PiggyBank, Sparkles, WifiOff, Play, Loader, BarChart3, ShoppingBag, Settings, UserCog } from 'lucide-react'; // Th√™m UserCog
import { ClayButton } from '../lib/helpers.jsx';
import { fmt } from '../lib/utils.js';

const HomeScreen = ({ piggyBank, setGameState, currentProfile, isGenerating, handleStartQuiz, config, setCurrentProfile, appError, setAppError, onOpenConfig }) => (
    <div className="flex flex-col h-full bg-slate-50 p-6">
        {/* Header Profile Info */}
        <div className="flex justify-between items-center mb-6 pt-4">
            <button onClick={() => { setGameState('profile_select'); setCurrentProfile(null); }} className="flex items-center gap-3 bg-white p-2 pr-4 rounded-full shadow-sm border border-slate-100 active:scale-95 transition-transform">
                <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-2xl">{currentProfile?.avatar || '‚ùì'}</div>
                <div className="flex flex-col text-left"><span className="text-[10px] font-bold text-slate-400 uppercase">H·ªçc vi√™n</span><span className="font-black text-slate-700 leading-none">{currentProfile?.name || 'Ch·ªçn H·ªì S∆°'}</span></div>
            </button>
            <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-pink-100 shadow-sm"><PiggyBank className="text-pink-500 fill-pink-500" size={24} /><span className="font-black text-pink-600 text-lg">{fmt(piggyBank)}ƒë</span></div>
        </div>
        
        {appError ? (
             <div className="mb-6 bg-red-50 text-red-600 p-4 rounded-3xl border border-red-100 flex items-center gap-3 animate-shake">
                <WifiOff className="text-red-400" size={24}/>
                <div className="flex-1 text-sm font-bold">{appError}</div>
                <button onClick={() => setAppError(null)} className="ml-2 font-bold">‚úï</button>
            </div>
        ) : (
            <div className="mb-6 bg-indigo-50 text-indigo-600 p-4 rounded-3xl border border-indigo-100 flex items-center gap-3"><Sparkles className="text-indigo-400" size={24}/><p className="font-bold text-sm">H√¥m nay {currentProfile?.name} mu·ªën h·ªçc g√¨ n√†o?</p></div>
        )}

        {/* Updated Grid Menu: 2 h√†ng 2 c·ªôt cho c√¢n ƒë·ªëi ho·∫∑c 4 n√∫t */}
        <div className="grid grid-cols-2 gap-3 mb-6">
            <ClayButton onClick={() => setGameState('report')} className="h-20 flex flex-row items-center px-4 gap-3 bg-white border-slate-100 !rounded-2xl">
                <div className="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><BarChart3 size={20}/></div>
                <span className="text-sm font-black text-slate-600">H·ªçc B·∫°</span>
            </ClayButton>
            <ClayButton onClick={() => setGameState('shop')} className="h-20 flex flex-row items-center px-4 gap-3 bg-white border-slate-100 !rounded-2xl">
                <div className="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center"><ShoppingBag size={20}/></div>
                <span className="text-sm font-black text-slate-600">C·ª≠a H√†ng</span>
            </ClayButton>
            <ClayButton onClick={onOpenConfig} className="h-20 flex flex-row items-center px-4 gap-3 bg-white border-slate-100 !rounded-2xl">
                <div className="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><Settings size={20}/></div>
                <span className="text-sm font-black text-slate-600">C·∫•u H√¨nh</span>
            </ClayButton>
            {/* N√∫t m·ªõi cho T√†i kho·∫£n ph·ª• huynh */}
            <ClayButton onClick={() => setGameState('user_profile')} className="h-20 flex flex-row items-center px-4 gap-3 bg-white border-slate-100 !rounded-2xl">
                <div className="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center"><UserCog size={20}/></div>
                <span className="text-sm font-black text-slate-600">T√†i Kho·∫£n</span>
            </ClayButton>
        </div>

        <div className="flex-1 flex flex-col items-center justify-center text-center space-y-6">
            <div><h1 className="text-4xl font-black text-indigo-600 mb-2 font-nunito tracking-tight">To√°n L·ªõp 3</h1><p className="text-slate-400 font-medium">ƒê·ªÅ b√†i ƒë∆∞·ª£c "th·ª≠a ri√™ng" cho con!</p></div>
            <div className="w-full space-y-4">
                <ClayButton onClick={handleStartQuiz} disabled={isGenerating || !currentProfile} colorClass={`text-white ${isGenerating || !currentProfile ? 'bg-slate-400' : 'bg-gradient-to-r from-blue-600 to-indigo-600'}`} className="w-full h-24 flex items-center justify-center gap-3 text-2xl font-black shadow-indigo-200 !rounded-[2rem]">
                    {isGenerating ? <Loader className="animate-spin" /> : <Play fill="currentColor" size={32} />}
                    {isGenerating ? 'ƒêang t·∫°o...' : !currentProfile ? 'Vui l√≤ng ch·ªçn h·ªì s∆°' : 'L√†m B√†i T·∫≠p'}
                </ClayButton>
                {currentProfile && (
                  <div className="flex gap-2 justify-center opacity-70"><span className="px-3 py-1 bg-slate-200 rounded-full text-[10px] font-bold text-slate-500 uppercase tracking-wide">{config.difficultyMode === 'easy' ? 'D·ªÖ th·ªü' : config.difficultyMode === 'hard' ? 'Th·ª≠ th√°ch' : 'Ti√™u chu·∫©n'}</span><span className="px-3 py-1 bg-indigo-100 rounded-full text-[10px] font-bold text-indigo-500 uppercase tracking-wide">{config.semester === 'hk1' ? 'H·ªçc K·ª≥ 1' : 'H·ªçc K·ª≥ 2'}</span></div>
                )}
            </div>
        </div>
    </div>
);

export default HomeScreen;

==================================================
FILE PATH: src\components\ParentGateModal.jsx
==================================================
import React, { useEffect, useState } from 'react';
import { Lock, Brain, XCircle, ShieldCheck } from 'lucide-react';
import { ClayButton } from '../lib/helpers';
import { verifyParentPin } from '../lib/utils';

const createChallenge = () => {
    const a = Math.floor(Math.random() * 80) + 20;
    const b = Math.floor(Math.random() * 70) + 10;
    const operations = ['+', '-'];
    const op = operations[Math.floor(Math.random() * operations.length)];
    if (op === '+') {
        return { text: `${a} + ${b}`, answer: a + b };
    }
    const big = Math.max(a, b);
    const small = Math.min(a, b);
    return { text: `${big} - ${small}`, answer: big - small };
};

const ParentGateModal = ({ isOpen, onClose, onSuccess, parentSettings, reasonLabel }) => {
    const [mode, setMode] = useState(parentSettings?.pinHash ? 'pin' : 'challenge');
    const [pinInput, setPinInput] = useState('');
    const [challengeAnswer, setChallengeAnswer] = useState('');
    const [challenge, setChallenge] = useState(createChallenge());
    const [error, setError] = useState(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (isOpen) {
            setMode(parentSettings?.pinHash ? 'pin' : 'challenge');
            setPinInput('');
            setChallengeAnswer('');
            setError(null);
            setChallenge(createChallenge());
        }
    }, [isOpen, parentSettings]);

    if (!isOpen) return null;

    const handleVerify = async () => {
        setError(null);
        setLoading(true);
        try {
            let passed = false;
            if (mode === 'pin') {
                if (!pinInput) {
                    setError('Vui l√≤ng nh·∫≠p m√£ PIN 4 s·ªë.');
                } else if (!parentSettings?.pinHash) {
                    setError('Ch∆∞a thi·∫øt l·∫≠p m√£ PIN. Vui l√≤ng d√πng ph√©p t√≠nh.');
                } else {
                    passed = await verifyParentPin(pinInput, parentSettings.pinHash);
                    if (!passed) setError('PIN ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i nh√©.');
                }
            } else {
                if (String(challengeAnswer).trim() === '') {
                    setError('Vui l√≤ng ƒëi·ªÅn ƒë√°p √°n.');
                } else if (Number(challengeAnswer) !== challenge.answer) {
                    setError('ƒê√°p √°n ch∆∞a ch√≠nh x√°c, c√πng th·ª≠ l·∫ßn n·ªØa!');
                    setChallenge(createChallenge());
                    setChallengeAnswer('');
                } else {
                    passed = true;
                }
            }

            if (passed) {
                onSuccess();
            }
        } catch {
            setError('C√≥ l·ªói x·∫£y ra, th·ª≠ l·∫°i gi√∫p m√¨nh nh√©.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[120] bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-[2rem] p-6 shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-red-500">
                    <XCircle size={24} />
                </button>
                <div className="text-center mb-6">
                    <div className="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-3 text-indigo-600">
                        <ShieldCheck size={32} />
                    </div>
                    <h2 className="text-2xl font-black text-slate-800">G√≥c ph·ª• huynh</h2>
                    <p className="text-sm font-bold text-slate-400 mt-1">B·∫£o v·ªá: {reasonLabel}</p>
                </div>

                <div className="flex gap-2 mb-4">
                    <ClayButton
                        onClick={() => setMode('pin')}
                        colorClass={mode === 'pin' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}
                        className="flex-1 h-12 font-black !rounded-xl"
                    >
                        <Lock size={18} /> M√£ PIN
                    </ClayButton>
                    <ClayButton
                        onClick={() => setMode('challenge')}
                        colorClass={mode === 'challenge' ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-500'}
                        className="flex-1 h-12 font-black !rounded-xl"
                    >
                        <Brain size={18} /> Ph√©p t√≠nh
                    </ClayButton>
                </div>

                {mode === 'pin' ? (
                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-400 uppercase">Nh·∫≠p m√£ PIN 4 s·ªë</label>
                        <input
                            type="password"
                            maxLength={6}
                            value={pinInput}
                            onChange={(e) => setPinInput(e.target.value.replace(/\D/g, ''))}
                            className="w-full h-14 px-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:border-indigo-500 font-black text-center text-2xl tracking-widest"
                        />
                        {!parentSettings?.pinHash && (
                            <p className="text-xs text-orange-500 font-bold">Ch∆∞a ƒë·∫∑t PIN? D√πng ph√©p t√≠nh ho·∫∑c thi·∫øt l·∫≠p ·ªü m·ª•c T√†i kho·∫£n.</p>
                        )}
                    </div>
                ) : (
                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-400 uppercase">Gi·∫£i nhanh ph√©p t√≠nh</label>
                        <div className="w-full h-16 px-4 rounded-2xl border-2 border-orange-200 bg-orange-50 flex items-center justify-between">
                            <span className="font-black text-xl text-orange-600">{challenge.text} = ?</span>
                            <input
                                type="number"
                                value={challengeAnswer}
                                onChange={(e) => setChallengeAnswer(e.target.value)}
                                className="w-20 h-12 text-center font-black text-lg rounded-xl border border-orange-200"
                            />
                        </div>
                    </div>
                )}

                {error && <div className="mt-4 text-sm font-bold text-red-500 text-center">{error}</div>}

                <ClayButton
                    onClick={handleVerify}
                    disabled={loading}
                    colorClass="bg-indigo-600 text-white"
                    className="w-full h-14 font-black text-lg mt-6 !rounded-2xl"
                >
                    {loading ? 'ƒêang ki·ªÉm tra...' : 'M·ªü kh√≥a ngay'}
                </ClayButton>
            </div>
        </div>
    );
};

export default ParentGateModal;



==================================================
FILE PATH: src\components\ProfileScreen.jsx
==================================================
import React from 'react';
import { User, UserPlus, XCircle, CheckCircle, Loader } from 'lucide-react'; // Th√™m Loader
import { ClayButton } from '../lib/helpers';

const ProfileScreen = ({ profiles, setCurrentProfile, isCreatingProfile, setIsCreatingProfile, newProfileName, setNewProfileName, newProfileAvatar, setNewProfileAvatar, createProfile, appUser, isLoading }) => {
    
    React.useEffect(() => {
        // ‚úÖ FIX: Logic n√†y gi·ªù an to√†n h∆°n nh·ªù isLoadingData ƒë∆∞·ª£c kh·ªüi t·∫°o l√† true ·ªü hook
        if (!isLoading && profiles.length === 0 && !isCreatingProfile) {
            setIsCreatingProfile(true);
        }
    }, [profiles, isCreatingProfile, setIsCreatingProfile, isLoading]);

    return (
        <div className="flex flex-col h-full bg-slate-50 p-6 relative">
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-2xl font-black text-slate-700">Ch·ªçn H·ªì S∆°</h1>
                    <p className="text-sm font-bold text-slate-400">Ai ƒëang h·ªçc v·∫≠y nh·ªâ?</p>
                </div>
                {appUser && (
                   <div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center shadow-sm">
                        <User size={20} className="text-slate-500"/>
                   </div>
                )}
            </div>

            {/* ‚úÖ FIX: Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i r√µ r√†ng */}
            {isLoading ? (
                <div className="flex-1 flex flex-col items-center justify-center text-slate-400 gap-3">
                    <Loader className="animate-spin text-indigo-500" size={32} />
                    <span className="font-bold text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</span>
                </div>
            ) : (
                <div className="grid grid-cols-2 gap-4 overflow-y-auto pb-20 no-scrollbar content-start">
                    {profiles.map(profile => (
                        <ClayButton 
                            key={profile.id} 
                            onClick={() => setCurrentProfile(profile)} 
                            className="aspect-square flex flex-col items-center justify-center gap-2 bg-white !rounded-3xl border-slate-100 hover:border-indigo-200 hover:shadow-md transition-all"
                        >
                            <div className="text-5xl drop-shadow-sm transition-transform hover:scale-110">{profile.avatar}</div>
                            <div className="font-black text-slate-700 text-lg truncate w-full px-2">{profile.name}</div>
                        </ClayButton>
                    ))}
                    
                    {/* N√∫t t·∫°o m·ªõi */}
                    <ClayButton 
                        onClick={() => setIsCreatingProfile(true)} 
                        colorClass="bg-emerald-500 text-white border-emerald-600"
                        className="aspect-square flex flex-col items-center justify-center gap-2 !rounded-3xl shadow-lg shadow-emerald-200"
                    >
                        <div className="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                            <UserPlus size={32} className="text-white"/>
                        </div>
                        <div className="font-black text-white text-lg">T·∫°o m·ªõi</div>
                    </ClayButton>
                </div>
            )}

            {/* MODAL OVERLAY T·∫†O PROFILE */}
            {isCreatingProfile && !isLoading && (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animation-fade-in">
                    <div className="bg-white p-6 rounded-[2rem] shadow-2xl w-full max-w-sm relative animate-shake border-4 border-white">
                        {/* Ch·ªâ hi·ªán n√∫t ƒë√≥ng n·∫øu ƒë√£ c√≥ √≠t nh·∫•t 1 profile (ƒë·ªÉ tr√°nh user b·ªã k·∫πt n·∫øu ch∆∞a c√≥ profile n√†o) */}
                        {profiles.length > 0 && (
                            <button 
                                onClick={() => setIsCreatingProfile(false)} 
                                className="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors p-1 bg-slate-50 rounded-full"
                            >
                                <XCircle size={28} />
                            </button>
                        )}
                        
                        <h2 className="text-2xl font-black text-slate-700 mb-6 text-center">H·ªì S∆° M·ªõi</h2>
                        
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-2">T√™n c·ªßa b√©</label>
                            <input
                                type="text"
                                value={newProfileName}
                                onChange={(e) => setNewProfileName(e.target.value)}
                                placeholder="V√≠ d·ª•: Bi, B·ªëng..."
                                autoFocus
                                className="w-full h-14 px-4 rounded-2xl border-2 border-indigo-100 bg-indigo-50 focus:bg-white focus:border-indigo-500 outline-none font-bold text-indigo-900 text-lg text-center transition-all placeholder:text-indigo-200"
                            />
                        </div>
                        
                        <div className="mb-8">
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-2">Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</label>
                            <div className="flex gap-2 justify-center flex-wrap">
                                {['üê∂', 'üê±', 'ü¶ä', 'bq', 'ü¶Ñ', 'üêØ'].map(avatar => (
                                       <button 
                                            key={avatar} 
                                            onClick={() => setNewProfileAvatar(avatar)} 
                                            className={`text-3xl w-12 h-12 rounded-full flex items-center justify-center transition-all ${newProfileAvatar === avatar ? 'bg-indigo-100 ring-4 ring-indigo-200 scale-110' : 'bg-slate-50 hover:bg-slate-100'}`}
                                           >
                                            {avatar}
                                           </button>
                                ))}
                            </div>
                        </div>
                        
                        <ClayButton 
                            onClick={createProfile} 
                            colorClass="bg-indigo-600 text-white" 
                            className="w-full h-14 flex items-center justify-center gap-2 font-black text-lg !rounded-2xl shadow-xl shadow-indigo-200"
                        >
                            <CheckCircle size={20}/> Ho√†n T·∫•t
                        </ClayButton>
                    </div>
                </div>
            )}
        </div>
    );
};

export default ProfileScreen;

==================================================
FILE PATH: src\components\QuizScreen.jsx
==================================================
import React from 'react';
import { ArrowLeft, PiggyBank, Smile, Frown, ArrowRight } from 'lucide-react';
import { ClayButton, MathText } from '../lib/helpers';
import { REWARD_PER_LEVEL } from '../lib/constants';
// ‚úÖ C·∫¨P NH·∫¨T IMPORT: Th√™m normalizeVal
import { fmt, normalizeVal } from '../lib/utils';
import parse from 'html-react-parser';

// Import c√°c d·∫°ng b√†i t·∫≠p m·ªõi
import QuizMCQ from './quiz_types/QuizMCQ';
import QuizFillBlank from './quiz_types/QuizFillBlank';
import QuizComparison from './quiz_types/QuizComparison';
import QuizSorting from './quiz_types/QuizSorting';
import QuizMatching from './quiz_types/QuizMatching';

const ALLOWED_SVG_TAGS = new Set(['rect', 'circle', 'path', 'line', 'polygon', 'polyline', 'text']);
const ALLOWED_ATTRS = new Set([
    'x', 'y', 'x1', 'y1', 'x2', 'y2',
    'cx', 'cy', 'r',
    'width', 'height', 'rx', 'ry',
    'points', 'd',
    'stroke', 'stroke-width', 'strokeLinecap', 'strokeLinejoin', 'strokeDasharray',
    'fill', 'opacity',
    'font-size', 'fontWeight', 'text-anchor',
    'transform'
]);

const renderSafeSvgContent = (svgContent) => {
    if (!svgContent || typeof svgContent !== 'string') return null;

    return parse(svgContent, {
        replace: (domNode) => {
            if (domNode.type === 'text') {
                return domNode.data;
            }
            if (domNode.type !== 'tag') return null;

            const tag = domNode.name.toLowerCase();
            if (!ALLOWED_SVG_TAGS.has(tag)) return null;

            const safeProps = {};
            const attribs = domNode.attribs || {};

            Object.keys(attribs).forEach((key) => {
                const lowerKey = key.toLowerCase();
                // Lo·∫°i b·ªè m·ªçi on* handler, href, xlink, style inline
                if (lowerKey.startsWith('on')) return;
                if (lowerKey === 'href' || lowerKey === 'xlink:href') return;
                if (lowerKey === 'style') return;
                if (!ALLOWED_ATTRS.has(lowerKey)) return;
                safeProps[lowerKey] = attribs[key];
            });

            return React.createElement(tag, safeProps, domNode.children?.map((child) => (
                // G·ªçi l·∫°i parser tr√™n children ƒë·ªÉ √°p d·ª•ng c√πng logic
                renderSafeSvgContent(parse(child.data || '', {})) || null
            )));
        }
    });
};

const buildGeometrySvg = (question) => {
    if (question.topic !== 'geometry') return question.svgContent || null;
    if (question.svgContent && question.svgContent.trim().length > 0) return question.svgContent;
    const text = String(question.text || '').toLowerCase();
    const nums = (question.text || '').match(/\d+/g)?.map(Number) || [];
    if (text.includes('tam gi√°c')) {
        return `<polygon points="60,150 150,40 240,150" stroke="#4F46E5" stroke-width="4" fill="#E0E7FF" />
        <line x1="150" y1="40" x2="150" y2="150" stroke="#F97316" stroke-dasharray="6,4" stroke-width="2" />
        <text x="150" y="30" text-anchor="middle" font-size="14" fill="#374151" font-weight="bold">Tam gi√°c</text>`;
    }
    const width = Math.min(220, (nums[0] || 10) * 10);
    const height = Math.min(120, (nums[1] || nums[0] || 5) * 8);
    return `<rect x="${(300 - width) / 2}" y="${(200 - height) / 2}" width="${width}" height="${height}" rx="12" stroke="#4F46E5" stroke-width="4" fill="#E0E7FF" />
        <text x="150" y="${(200 - height) / 2 - 10}" text-anchor="middle" font-size="14" fill="#374151" font-weight="bold">${nums[0] || 10} cm</text>
        <text x="${(300 + width) / 2 + 10}" y="110" font-size="14" fill="#374151" font-weight="bold" transform="rotate(-90 ${(300 + width) / 2 + 10},110)">${nums[1] || nums[0] || 5} cm</text>`;
};

const QuizScreen = ({ quizData, currentQIndex, setGameState, sessionScore, selectedOption, isSubmitted, handleSelectOption, handleNextQuestion }) => {
    const q = quizData[currentQIndex];
    const geometrySvg = buildGeometrySvg(q);
    const progress = ((currentQIndex + 1) / quizData.length) * 100;
    
    if (!q) return <div className="p-6 text-center">ƒêang t·∫£i...</div>;

    // ‚úÖ S·ª¨A ƒê·ªîI: Logic ki·ªÉm tra ƒë√∫ng sai nh·∫•t qu√°n v·ªõi MathApp.js
    let isCorrect = false;
    if (isSubmitted) {
        if (q.type === 'sorting') {
            // Sorting: selectedOption ƒëang l√† JSON string (do MathApp convert) -> Parse l·∫°i ƒë·ªÉ so s√°nh
            let userArr = [];
            try { 
                // N·∫øu selectedOption l√† string th√¨ parse, n·∫øu l√† array s·∫µn th√¨ gi·ªØ nguy√™n
                userArr = typeof selectedOption === 'string' ? JSON.parse(selectedOption) : selectedOption;
            } catch (e) {
                console.warn("L·ªói parse selectedOption:", e);
            }
            
            const correctArr = q.correctOrder || [];
            
            // So s√°nh t·ª´ng ph·∫ßn t·ª≠ b·∫±ng normalizeVal
            isCorrect = Array.isArray(userArr) && 
                        userArr.length === correctArr.length && 
                        userArr.every((val, i) => normalizeVal(val) === normalizeVal(correctArr[i]));

        } else if (q.type === 'matching') {
            // Matching: ƒê√∫ng khi gi√° tr·ªã l√† true ho·∫∑c chu·ªói "true"
            isCorrect = selectedOption === true || String(selectedOption) === "true";

        } else {
            // MCQ & Comparison & FillBlank
            // So s√°nh l·ªèng b·∫±ng normalizeVal
            isCorrect = normalizeVal(selectedOption) === normalizeVal(q.correctVal);
        }
    }

    const isLastQuestion = currentQIndex === quizData.length - 1;

    // Helper render body
    const renderQuizBody = () => {
        // Th√™m prop key={currentQIndex} v√†o T·∫§T C·∫¢ c√°c component b√™n d∆∞·ªõi
        switch (q.type) {
            case 'fill_blank':
                return <QuizFillBlank key={currentQIndex} question={q} onAnswer={handleSelectOption} isSubmitted={isSubmitted} userAnswer={selectedOption} />;
            case 'comparison':
                return <QuizComparison key={currentQIndex} question={q} onAnswer={handleSelectOption} isSubmitted={isSubmitted} userAnswer={selectedOption} />;
            case 'sorting':
                return <QuizSorting key={currentQIndex} question={q} onAnswer={handleSelectOption} isSubmitted={isSubmitted} />;
            case 'matching':
                return <QuizMatching key={currentQIndex} question={q} onAnswer={handleSelectOption} isSubmitted={isSubmitted} />;
            case 'mcq':
            default:
                return <QuizMCQ key={currentQIndex} question={q} onAnswer={handleSelectOption} isSubmitted={isSubmitted} userAnswer={selectedOption} />;
        }
    };

    return (
        <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
            {/* --- HEADER STICKY --- */}
            <div className="px-4 pt-6 pb-2 bg-white sticky top-0 z-10 shadow-sm shrink-0">
                <div className="flex justify-between items-center mb-2">
                    <ClayButton onClick={() => setGameState('home')} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0">
                        <ArrowLeft size={20} className="text-slate-500"/>
                    </ClayButton>
                    <div className="flex flex-col items-center">
                        <span className="font-black text-slate-700 text-lg">C√¢u {currentQIndex + 1}/{quizData.length}</span>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 uppercase tracking-wider">{q.type || 'MCQ'}</span>
                            <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">M·ª©c {q.level} (+{REWARD_PER_LEVEL[q.level] || 0}ƒë)</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-1 bg-pink-100 px-2 py-1 rounded-lg text-pink-700 font-bold text-xs">
                        <PiggyBank size={14}/> +{fmt(sessionScore)}ƒë
                    </div>
                </div>
                <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-green-500 transition-all duration-500" style={{width: `${progress}%`}}></div>
                </div>
            </div>

            {/* --- SCROLLABLE CONTENT --- */}
            <div className="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar flex flex-col">
                {/* Question Box (Ch·ªâ hi·ªán text ·ªü ƒë√¢y n·∫øu ko ph·∫£i FillBlank - v√¨ FillBlank ƒë√£ t√≠ch h·ª£p text b√™n trong) */}
                {q.type !== 'fill_blank' && (
                    <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6 shrink-0">
                        <div className="text-lg sm:text-xl text-slate-800 font-bold leading-relaxed text-center">
                            <MathText text={q.text} />
                        </div>
                        {/* SVG Support */}
                        {geometrySvg && (
                            <div className="mt-4 flex justify-center animation-fade-in">
                                <div className="border border-slate-200 rounded-2xl p-4 bg-white shadow-inner">
                                    {/* FIX: B·ªè height="auto" */}
                                    <svg 
                                        width="100%" 
                                        viewBox="0 0 300 200" 
                                        xmlns="http://www.w3.org/2000/svg" 
                                        className="max-w-[280px] h-auto mx-auto" 
                                        style={{ minHeight: '120px' }} 
                                    >
                                        {renderSafeSvgContent(geometrySvg)}
                                    </svg>
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* Render Dynamic Component */}
                <div className="flex-1">
                    {renderQuizBody()}
                </div>
            </div>

            {/* --- RESULT MODAL (POPUP) --- */}
            {isSubmitted && (
                <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animation-fade-in">
                    <div className={`w-full max-w-sm bg-white rounded-[2rem] shadow-2xl overflow-hidden animate-shake border-4 ${isCorrect ? 'border-green-200' : 'border-red-200'}`}>
                        {/* Modal Header */}
                        <div className={`p-6 text-center ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`}>
                            <div className={`w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-3 shadow-sm border-4 border-white ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
                                {isCorrect ? <Smile size={48} /> : <Frown size={48} />}
                            </div>
                            <h2 className={`text-2xl font-black uppercase ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                {isCorrect ? "Hoan h√¥!" : "Ti·∫øc qu√°!"}
                            </h2>
                            <p className="font-bold text-slate-600 text-sm mt-1">
                                {isCorrect ? "B√© gi·ªèi qu√° ƒëi th√¥i!" : "Kh√¥ng sao, th·ª≠ l·∫°i l·∫ßn sau nh√©."}
                            </p>
                        </div>

                        {/* Modal Body: Explanation */}
                        <div className="p-6 bg-white">
                            {!isCorrect && (
                                <div className="mb-4 text-center">
                                    <div className="text-xs font-bold text-slate-400 uppercase mb-1">ƒê√°p √°n ƒë√∫ng l√†</div>
                                    <div className="text-xl font-black text-green-600 bg-green-50 py-2 rounded-xl border border-green-100">
                                        {q.type === 'sorting' 
                                            ? (Array.isArray(q.correctOrder) ? q.correctOrder.join(' ‚Üí ') : q.correctOrder)
                                            : q.type === 'matching' 
                                                ? 'Xem gi·∫£i th√≠ch b√™n d∆∞·ªõi'
                                                : (q.correctOption || q.correctVal)
                                        }
                                    </div>
                                </div>
                            )}
                            
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 text-slate-600 text-sm leading-relaxed font-medium max-h-40 overflow-y-auto">
                                <span className="font-bold text-indigo-500 block mb-1">üí° Gi·∫£i th√≠ch:</span>
                                <MathText text={q.explanation} />
                            </div>

                            {/* Action Button */}
                            <div className="mt-6">
                                <ClayButton 
                                    onClick={handleNextQuestion} 
                                    colorClass={isCorrect ? "bg-green-500 text-white" : "bg-indigo-500 text-white"} 
                                    className="w-full h-14 font-black text-xl flex items-center justify-center gap-2 !rounded-xl shadow-lg"
                                >
                                    {isLastQuestion ? 'Xem K·∫øt Qu·∫£' : 'C√¢u Ti·∫øp Theo'} <ArrowRight />
                                </ClayButton>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default QuizScreen;

==================================================
FILE PATH: src\components\quiz_types\QuizComparison.jsx
==================================================
import React from 'react';
import { ClayButton } from '../../lib/helpers';

const QuizComparison = ({ question, onAnswer, isSubmitted, userAnswer }) => {
    const options = ['>', '=', '<'];

    return (
        <div className="flex justify-center gap-4 mt-8">
            {options.map((opt, idx) => {
                let stateClass = "bg-white border-slate-200 text-indigo-600 hover:border-indigo-400 hover:-translate-y-1";
                
                if (isSubmitted) {
                    const isCorrect = opt === question.correctVal;
                    const isSelected = opt === userAnswer;
                    
                    if (isCorrect) stateClass = "bg-green-500 text-white border-green-600 shadow-xl ring-4 ring-green-200";
                    else if (isSelected) stateClass = "bg-red-500 text-white border-red-600 opacity-50";
                    else stateClass = "bg-slate-100 text-slate-300 border-slate-200 grayscale";
                }

                return (
                    <ClayButton
                        key={idx}
                        onClick={() => onAnswer(opt)}
                        disabled={isSubmitted}
                        className={`w-24 h-24 flex items-center justify-center text-5xl font-black rounded-3xl border-b-8 transition-all ${stateClass}`}
                    >
                        {opt}
                    </ClayButton>
                );
            })}
        </div>
    );
};

export default QuizComparison;

==================================================
FILE PATH: src\components\quiz_types\QuizFillBlank.jsx
==================================================
import React, { useState } from 'react';
import { ClayButton, MathText } from '../../lib/helpers';
import { Delete, Check } from 'lucide-react';

const QuizFillBlank = ({ question, onAnswer, isSubmitted, userAnswer }) => {
    const [input, setInput] = useState("");

    const handlePress = (val) => {
        if (isSubmitted) return;

        if (val === 'DEL') {
            // X√≥a k√Ω t·ª± cu·ªëi
            setInput(prev => prev.slice(0, -1));
        } 
        else if (val === 'OK') {
            // N·ªôp b√†i n·∫øu c√≥ d·ªØ li·ªáu
            if (input.length > 0) onAnswer(input.trim());
        }
        else if (val === '/') {
            // Logic cho ph√¢n s·ªë:
            // 1. Kh√¥ng cho nh·∫≠p '/' ·ªü ƒë·∫ßu ti√™n
            // 2. Kh√¥ng cho nh·∫≠p n·∫øu ƒë√£ c√≥ d·∫•u '/' r·ªìi (ch·ªâ h·ªó tr·ª£ ph√¢n s·ªë ƒë∆°n gi·∫£n a/b)
            if (input.length > 0 && !input.includes('/')) {
                setInput(prev => prev + val);
            }
        }
        else {
            // Nh·∫≠p s·ªë: Gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·ªÉ kh√¥ng v·ª° giao di·ªán
            setInput(prev => (prev.length < 10 ? prev + val : prev));
        }
    };

    return (
        <div className="flex flex-col items-center w-full">
            {/* Display Area */}
            <div className="w-full bg-indigo-50 p-6 rounded-3xl border-2 border-indigo-100 mb-6 text-center shadow-inner relative">
                <div className="text-2xl font-bold text-slate-700 leading-loose">
                    <MathText text={question.text.replace("__", "___")} />
                </div>
                
                <div className="mt-4 flex flex-col justify-center items-center gap-2">
                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">C√¢u tr·∫£ l·ªùi c·ªßa b√©:</span>
                    <div className={`min-w-[140px] h-16 border-b-4 text-3xl font-black text-center flex items-center justify-center px-4 transition-all ${
                        isSubmitted 
                            ? (String(userAnswer) === String(question.correctVal) 
                                ? 'border-green-500 text-green-600 bg-green-50 rounded-xl' 
                                : 'border-red-500 text-red-600 bg-red-50 rounded-xl') 
                            : 'border-indigo-400 text-indigo-600 bg-white rounded-xl shadow-sm'
                    }`}>
                        {/* N·∫øu ƒë√£ n·ªôp th√¨ hi·ªán userAnswer, ch∆∞a n·ªôp th√¨ hi·ªán input */}
                        {isSubmitted ? userAnswer : input}
                        
                        {/* Con tr·ªè nh·∫•p nh√°y */}
                        {!isSubmitted && <span className="animate-pulse text-indigo-300 ml-1">|</span>}
                    </div>
                </div>
            </div>

            {/* Custom Numpad */}
            {!isSubmitted && (
                <div className="w-full max-w-[300px]">
                    <div className="grid grid-cols-3 gap-3 mb-3">
                        {/* H√†ng 1-3: C√°c s·ªë 1-9 */}
                        {[1,2,3,4,5,6,7,8,9].map(n => (
                            <ClayButton key={n} onClick={() => handlePress(n)} className="h-14 font-black text-2xl bg-white text-slate-600 border-slate-200 active:bg-slate-100 shadow-sm">
                                {n}
                            </ClayButton>
                        ))}

                        {/* H√†ng 4: D·∫•u ph·∫ßn (/), S·ªë 0, X√≥a */}
                        <ClayButton onClick={() => handlePress('/')} className="h-14 font-black text-2xl bg-white text-indigo-600 border-indigo-200 active:bg-indigo-50">
                            /
                        </ClayButton>
                        
                        <ClayButton onClick={() => handlePress(0)} className="h-14 font-black text-2xl bg-white text-slate-600 border-slate-200 active:bg-slate-100">
                            0
                        </ClayButton>

                        <ClayButton onClick={() => handlePress('DEL')} className="h-14 flex items-center justify-center bg-red-50 text-red-500 border-red-200 active:bg-red-100">
                            <Delete size={24}/>
                        </ClayButton>
                    </div>

                    {/* H√†ng cu·ªëi: N√∫t OK to r√µ r√†ng */}
                    <ClayButton 
                        onClick={() => handlePress('OK')} 
                        colorClass="bg-green-500 text-white border-green-600 hover:bg-green-600" 
                        className="w-full h-16 flex items-center justify-center gap-2 font-black text-xl shadow-md !rounded-2xl"
                        disabled={input.length === 0} // Disable n·∫øu ch∆∞a nh·∫≠p g√¨
                    >
                        TR·∫¢ L·ªúI NGAY <Check size={28} strokeWidth={4}/>
                    </ClayButton>
                </div>
            )}
        </div>
    );
};

export default QuizFillBlank;

==================================================
FILE PATH: src\components\quiz_types\QuizMatching.jsx
==================================================
import React, { useState } from 'react';
import { ClayButton } from '../../lib/helpers';

const QuizMatching = ({ question, onAnswer, isSubmitted }) => {
    // Logic kh·ªüi t·∫°o an to√†n
    const [leftItems] = useState(() => {
        if (!question.pairs || !Array.isArray(question.pairs)) return [];
        return question.pairs.map((p, i) => ({ id: `L${i}`, val: p.left, pairId: i }));
    });

    const [rightItems] = useState(() => {
        if (!question.pairs || !Array.isArray(question.pairs)) return [];
        const rights = question.pairs.map((p, i) => ({ id: `R${i}`, val: p.right, pairId: i }));
        return rights.sort(() => Math.random() - 0.5);
    });

    const [selectedLeft, setSelectedLeft] = useState(null);
    const [matchedPairs, setMatchedPairs] = useState({});
    const [wrongPair, setWrongPair] = useState(null);

    // ‚úÖ Hi·ªÉn th·ªã fallback n·∫øu d·ªØ li·ªáu l·ªói
    if (leftItems.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-4">
                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-3xl">üß©</div>
                <h3 className="text-lg font-bold text-slate-700">L·ªói hi·ªÉn th·ªã c√¢u h·ªèi</h3>
                <p className="text-sm text-slate-500">D·ªØ li·ªáu gh√©p c·∫∑p b·ªã thi·∫øu. B√© h√£y b·∫•m "B·ªè qua" ho·∫∑c n·ªôp b√†i ƒë·ªÉ sang c√¢u ti·∫øp theo nh√©!</p>
                {/* N√∫t c·ª©u c√°nh ƒë·ªÉ qua m√†n */}
                {!isSubmitted && (
                    <ClayButton onClick={() => onAnswer(true)} colorClass="bg-indigo-500 text-white" className="px-6 py-3 font-bold">
                        B·ªè qua c√¢u n√†y
                    </ClayButton>
                )}
            </div>
        );
    }

    const handleLeftClick = (item) => {
        if (isSubmitted || matchedPairs[item.id]) return;
        setSelectedLeft(item);
        setWrongPair(null);
    };

    const handleRightClick = (item) => {
        if (isSubmitted || !selectedLeft) return;
        
        if (selectedLeft.pairId === item.pairId) {
            const newMatches = { ...matchedPairs, [selectedLeft.id]: item.id };
            setMatchedPairs(newMatches);
            setSelectedLeft(null);

            if (Object.keys(newMatches).length === leftItems.length) {
                setTimeout(() => onAnswer(true), 500);
            }
        } else {
            setWrongPair({ left: selectedLeft.id, right: item.id });
            setTimeout(() => {
                setWrongPair(null);
                setSelectedLeft(null);
            }, 800);
        }
    };

    return (
        <div className="flex gap-2 sm:gap-4 justify-between h-full">
            {/* C·ªôt Tr√°i */}
            <div className="flex-1 flex flex-col gap-3 justify-center">
                {leftItems.map((item) => {
                    const isMatched = !!matchedPairs[item.id];
                    const isSelected = selectedLeft?.id === item.id;
                    const isWrong = wrongPair?.left === item.id;

                    let bgClass = "bg-white text-slate-700 border-slate-200";
                    if (isMatched) bgClass = "bg-green-100 text-green-700 border-green-300 opacity-50 cursor-default scale-95";
                    else if (isWrong) bgClass = "bg-red-100 text-red-700 border-red-300 animate-shake";
                    else if (isSelected) bgClass = "bg-indigo-500 text-white border-indigo-700 scale-105 shadow-lg ring-2 ring-indigo-200";

                    return (
                        <ClayButton 
                            key={item.id} 
                            onClick={() => handleLeftClick(item)}
                            className={`min-h-[60px] font-bold text-sm sm:text-base px-2 break-words whitespace-normal ${bgClass}`}
                        >
                            {item.val}
                        </ClayButton>
                    );
                })}
            </div>

            {/* C·ªôt Ph·∫£i */}
            <div className="flex-1 flex flex-col gap-3 justify-center">
                {rightItems.map((item) => {
                    const isMatched = Object.values(matchedPairs).includes(item.id);
                    const isWrong = wrongPair?.right === item.id;

                    let bgClass = "bg-white text-slate-700 border-slate-200";
                    if (isMatched) bgClass = "bg-green-100 text-green-700 border-green-300 opacity-50 cursor-default scale-95";
                    else if (isWrong) bgClass = "bg-red-100 text-red-700 border-red-300 animate-shake";

                    return (
                        <ClayButton 
                            key={item.id} 
                            onClick={() => handleRightClick(item)}
                            className={`min-h-[60px] font-bold text-sm sm:text-base px-2 break-words whitespace-normal ${bgClass}`}
                        >
                            {item.val}
                        </ClayButton>
                    );
                })}
            </div>
        </div>
    );
};

export default QuizMatching;

==================================================
FILE PATH: src\components\quiz_types\QuizMCQ.jsx
==================================================
import React from 'react';
import { ClayButton, MathText } from '../../lib/helpers';
import { CheckCircle, XCircle } from 'lucide-react';

const QuizMCQ = ({ question, onAnswer, isSubmitted, userAnswer }) => {
    return (
        <div className="space-y-3">
            {question.options.map((opt, idx) => {
                const label = ['A', 'B', 'C', 'D'][idx];
                let stateClass = "bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:bg-indigo-50";
                let icon = <div className={`w-8 h-8 rounded-full flex items-center justify-center font-black text-sm border-2 bg-white border-current`}>{label}</div>;

                if (isSubmitted) {
                    // Logic m√†u s·∫Øc khi ƒë√£ n·ªôp b√†i
                    // So s√°nh tr·ª±c ti·∫øp gi√° tr·ªã (Value) ho·∫∑c Label n·∫øu c·∫ßn
                    const isCorrectVal = String(opt).trim() === String(question.correctVal).trim();
                    const isUserSelected = String(opt).trim() === String(userAnswer).trim();

                    if (isCorrectVal) {
                        stateClass = "bg-green-100 border-green-600 text-green-800 ring-4 ring-green-200 scale-[1.02] shadow-xl";
                        icon = <div className="w-8 h-8 rounded-full flex items-center justify-center font-black text-sm bg-green-600 text-white border-green-700"><CheckCircle size={18}/></div>;
                    } else if (isUserSelected) {
                        stateClass = "bg-red-100 border-red-600 text-red-800 ring-4 ring-red-200 animate-shake opacity-60";
                        icon = <div className="w-8 h-8 rounded-full flex items-center justify-center font-black text-sm bg-red-600 text-white border-red-700"><XCircle size={18}/></div>;
                    } else {
                        stateClass = "bg-slate-50 border-slate-100 text-slate-300 opacity-40 grayscale";
                    }
                } else if (userAnswer === opt) {
                    stateClass = "bg-blue-50 border-blue-500 text-blue-700";
                }

                return (
                    <ClayButton
                        key={idx}
                        onClick={() => onAnswer(opt)} // Tr·∫£ v·ªÅ gi√° tr·ªã option lu√¥n
                        disabled={isSubmitted}
                        className={`w-full min-h-[72px] flex items-center px-4 gap-4 ${stateClass} border-2 transition-all duration-200`}
                    >
                        {icon}
                        <span className="text-xl font-bold flex-1 text-left"><MathText text={opt} /></span>
                    </ClayButton>
                )
            })}
        </div>
    );
};

export default QuizMCQ;

==================================================
FILE PATH: src\components\quiz_types\QuizSorting.jsx
==================================================
import React, { useState } from 'react';
import { ClayButton } from '../../lib/helpers';
import { Undo2, Send } from 'lucide-react';

const QuizSorting = ({ question, onAnswer, isSubmitted }) => {
    const [ordered, setOrdered] = useState([]);

    // ‚úÖ FIX: Logic kh·ªüi t·∫°o th√¥ng minh h∆°n (Safety Init)
    const [available, setAvailable] = useState(() => {
        // ∆Øu ti√™n 1: L·∫•y t·ª´ items do API tr·∫£ v·ªÅ
        if (question.items && question.items.length > 0) {
            return [...question.items].sort(() => Math.random() - 0.5);
        }
        // ∆Øu ti√™n 2 (Fallback): N·∫øu AI qu√™n items, l·∫•y t·ª´ correctOrder
        if (question.correctOrder && Array.isArray(question.correctOrder)) {
            return [...question.correctOrder].sort(() => Math.random() - 0.5);
        }
        // Fallback cu·ªëi: Tr·∫£ v·ªÅ r·ªóng (nh∆∞ng hi·∫øm khi x·∫£y ra n·∫øu ƒë√£ qua x·ª≠ l√Ω ·ªü useQuizRunner)
        return [];
    });

    const handlePick = (item) => {
        setOrdered([...ordered, item]);
        setAvailable(available.filter(i => i !== item));
    };

    const handleReset = () => {
        setOrdered([]);
        
        // ‚úÖ FIX: Logic Reset c≈©ng ph·∫£i √°p d·ª•ng Fallback t∆∞∆°ng t·ª±
        let sourceList = [];
        if (question.items && question.items.length > 0) {
            sourceList = question.items;
        } else if (question.correctOrder) {
            sourceList = question.correctOrder;
        }
        
        setAvailable([...sourceList].sort(() => Math.random() - 0.5)); 
    };

    const handleSubmit = () => {
        onAnswer(ordered);
    };

    return (
        <div className="flex flex-col h-full">
            <p className="text-center text-sm font-bold text-slate-400 mb-2 italic">
                Ch·∫°m v√†o c√°c √¥ b√™n d∆∞·ªõi theo ƒë√∫ng th·ª© t·ª±
            </p>

            {/* Drop Zone */}
            <div className="min-h-[100px] bg-slate-100 rounded-3xl border-2 border-dashed border-indigo-200 p-4 mb-6 flex flex-wrap gap-2 justify-center items-center content-center transition-all">
                {ordered.length === 0 && <span className="text-slate-300 font-bold text-sm">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y</span>}
                {ordered.map((item, idx) => (
                    <div key={idx} className="bg-indigo-500 text-white font-black px-4 py-2 rounded-xl shadow-lg animate-fade-in border-b-4 border-indigo-700">
                        {item}
                    </div>
                ))}
            </div>

            {/* Source Zone */}
            {!isSubmitted ? (
                <>
                    <div className="flex flex-wrap gap-3 justify-center mb-8">
                        {available.map((item, idx) => (
                            <ClayButton key={idx} onClick={() => handlePick(item)} className="px-5 py-3 bg-white text-slate-700 font-black text-xl border-slate-200 hover:-translate-y-1">
                                {item}
                            </ClayButton>
                        ))}
                        {available.length === 0 && ordered.length === 0 && (
                            <div className="text-red-400 font-bold text-sm bg-red-50 p-2 rounded-lg border border-red-100">
                                ‚ö†Ô∏è L·ªói d·ªØ li·ªáu c√¢u h·ªèi. Vui l√≤ng b·ªè qua c√¢u n√†y.
                            </div>
                        )}
                    </div>

                    <div className="flex gap-4 mt-auto">
                        <ClayButton onClick={handleReset} disabled={ordered.length === 0} className="w-14 h-14 flex items-center justify-center bg-slate-200 text-slate-600 border-slate-300 rounded-full">
                            <Undo2 size={24}/>
                        </ClayButton>
                        <ClayButton 
                            onClick={handleSubmit} 
                            disabled={available.length > 0} 
                            colorClass={available.length === 0 ? "bg-green-500 text-white" : "bg-slate-300 text-white"}
                            className="flex-1 h-14 font-black text-lg flex items-center justify-center gap-2"
                        >
                            Ki·ªÉm Tra <Send size={18}/>
                        </ClayButton>
                    </div>
                </>
            ) : (
                <div className="text-center font-bold text-slate-500">
                    ƒê√£ s·∫Øp x·∫øp xong!
                </div>
            )}
        </div>
    );
};

export default QuizSorting;

==================================================
FILE PATH: src\components\ReportScreen.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { doc, getDoc } from 'firebase/firestore';
import { 
    BarChart3, XCircle, Trophy, Clock, Loader, Calendar, 
    ChevronRight, ArrowLeft, Play, ShieldAlert, Lightbulb
} from 'lucide-react';
import { db, appId } from '../lib/firebase';
import { ClayButton, MathText } from '../lib/helpers';
import { TOPICS_LIST, TOPIC_TRANSLATIONS } from '../lib/constants';
import { fmt } from '../lib/utils';

const ReportScreen = ({ currentProfile, appUser, setGameState, setConfig }) => {
    const [stats, setStats] = useState(null);
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedLog, setSelectedLog] = useState(null);
    const [historyFilter, setHistoryFilter] = useState('week');

    // Helper: L·∫•y ng√†y ƒë·ªãnh d·∫°ng YYYY-MM-DD theo gi·ªù ƒë·ªãa ph∆∞∆°ng
    const getLocalYMD = (date) => {
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        return localDate.toISOString().split('T')[0];
    };

    useEffect(() => {
        const fetchData = async () => {
            if (!appUser || !currentProfile) return;
            try {
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'math_user_data', appUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userData = userDocSnap.exists() ? userDocSnap.data() : {};
                
                if (userData.stats && userData.stats[currentProfile.id]) {
                    setStats(userData.stats[currentProfile.id]);
                }

                if (userData.logs && Array.isArray(userData.logs)) {
                    // L·∫•y logs c·ªßa profile hi·ªán t·∫°i
                    const profileLogs = userData.logs.filter(l => l.profileId === currentProfile.id);
                    profileLogs.sort((a, b) => b.timestamp - a.timestamp);
                    setLogs(profileLogs);
                }
            } catch (error) { console.error(error); } finally { setLoading(false); }
        };
        fetchData();
    }, [appUser, currentProfile]);

    const buildChartData = () => {
        const buildWeek = () => {
            const last7Days = [...Array(7)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d;
            });
            return last7Days.map(dateObj => {
                const dateStr = getLocalYMD(dateObj);
                const dayLogs = logs.filter(l => getLocalYMD(new Date(l.timestamp)) === dateStr);
                const dayScore = dayLogs.reduce((acc, curr) => acc + (curr.score || 0), 0);
                const dayOfWeek = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][dateObj.getDay()];
                return { label: `${dateObj.getDate()}/${dateObj.getMonth() + 1}`, dayOfWeek, score: dayScore };
            });
        };

        if (historyFilter === 'week') {
            return buildWeek();
        }

        const bucket = {};
        logs.forEach(log => {
            const date = new Date(log.timestamp);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!bucket[key]) bucket[key] = 0;
            bucket[key] += log.score || 0;
        });
        const sortedKeys = Object.keys(bucket).sort();
        const limit = historyFilter === 'month' ? 4 : sortedKeys.length;
        const keys = sortedKeys.slice(-limit);
        const monthlyData = keys.map(key => {
            const [year, month] = key.split('-');
            return {
                label: `Th${Number(month)}/${year.slice(-2)}`,
                dayOfWeek: '',
                score: bucket[key]
            };
        });
        if (monthlyData.length === 0) return buildWeek();
        return monthlyData;
    };

    const chartData = buildChartData();
    const chartTitle = historyFilter === 'week' ? 'Phong ƒë·ªô 7 ng√†y qua' : historyFilter === 'month' ? 'So s√°nh theo th√°ng' : 'T·∫•t c·∫£ l·ªãch s·ª≠';

    const getTopicVietnamese = (key) => {
        // 1. T√¨m trong danh s√°ch chu·∫©n (n·∫øu key l√† ID ti·∫øng Anh nh∆∞ 'geometry')
        const found = TOPICS_LIST.find(t => t.id === key);
        if (found) return found.label;

        // 2. T√¨m trong t·ª´ ƒëi·ªÉn d·ªãch (n·∫øu key l√† t·ª´ kh√≥a ti·∫øng Anh c≈©)
        const lowerKey = key.toLowerCase().trim();
        if (TOPIC_TRANSLATIONS[lowerKey]) return TOPIC_TRANSLATIONS[lowerKey];

        // 3. [FIX QUAN TR·ªåNG] N·∫øu kh√¥ng t√¨m th·∫•y ID, hi·ªÉn th·ªã lu√¥n Key
        // V√¨ d·ªØ li·ªáu trong Firebase hi·ªán t·∫°i ƒëang l∆∞u tr·ª±c ti·∫øp t√™n Ti·∫øng Vi·ªát (v√≠ d·ª•: "To√°n ƒë·ªë")
        // N√™n n·∫øu key l√† "To√°n ƒë·ªë", ta tr·∫£ v·ªÅ lu√¥n "To√°n ƒë·ªë".
        return key !== "undefined" && key !== "null" ? key : "Ch·ªß ƒë·ªÅ kh√°c";
    };

    const getWeakestTopic = () => {
        if (!stats?.topics) return null;
        let weakTopic = null; 
        let minRate = 101;
        Object.entries(stats.topics).forEach(([key, val]) => {
            if (val.total < 3) return; // B·ªè qua n·∫øu ch∆∞a l√†m ƒë·ªß nhi·ªÅu
            const rate = (val.correct / val.total) * 100;
            if (rate < 50 && rate < minRate) {
                minRate = rate;
                weakTopic = key;
            }
        });
        return weakTopic;
    };

    const handleSmartPractice = (topicKey) => {
        if (!setConfig) return;
        let targetId = topicKey;
        const foundObj = TOPICS_LIST.find(t => t.id === topicKey || t.label === topicKey);
        if (foundObj) targetId = foundObj.id;
        
        setConfig(prev => ({
            ...prev,
            selectedTopics: [targetId],
            difficultyMode: 'medium'
        }));
        setGameState('home');
    };

    const weakTopic = getWeakestTopic();

    if (loading) return <div className="flex items-center justify-center h-full"><Loader className="animate-spin text-indigo-500"/></div>;

    return (
        <div className="flex flex-col h-full bg-slate-50 p-6 overflow-y-auto no-scrollbar relative">
            {/* --- HEADER (Shrink-0 ƒë·ªÉ kh√¥ng b·ªã b·∫πp) --- */}
            <div className="flex justify-between items-center mb-6 shrink-0">
                <h2 className="text-2xl font-black text-slate-700 flex items-center gap-2">
                    <BarChart3 className="text-indigo-500"/> H·ªçc B·∫°
                </h2>
                <ClayButton onClick={() => setGameState('home')} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0">
                    <XCircle size={24} className="text-slate-400"/>
                </ClayButton>
            </div>

            {/* --- SMART ADVICE (Shrink-0) --- */}
            <div className={`p-6 rounded-3xl text-white shadow-lg mb-6 relative overflow-hidden transition-all shrink-0 ${weakTopic ? 'bg-gradient-to-br from-orange-400 to-red-500' : 'bg-gradient-to-br from-indigo-500 to-purple-600'}`}>
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div className="relative z-10">
                    <div className="flex items-start gap-4 mb-3">
                        <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center shadow-inner shrink-0">
                            {weakTopic ? <ShieldAlert size={28} className="text-white"/> : <Lightbulb size={28} className="text-white"/>}
                        </div>
                        <div>
                            <h3 className="font-bold text-white/90 text-xs uppercase mb-1">
                                {weakTopic ? 'C·∫ßn b·ªï sung g·∫•p!' : 'L·ªùi khuy√™n t·ª´ B√°c C√∫'}
                            </h3>
                            <p className="font-bold text-sm leading-relaxed">
                                {weakTopic 
                                    ? `B√© ƒëang g·∫∑p kh√≥ khƒÉn ·ªü "${getTopicVietnamese(weakTopic)}". H√£y d√†nh th·ªùi gian √¥n l·∫°i nh√©!`
                                    : "B√© h·ªçc r·∫•t ƒë·ªÅu. H√£y duy tr√¨ th√≥i quen luy·ªán t·∫≠p h√†ng ng√†y ƒë·ªÉ t√≠ch th√™m ƒëi·ªÉm ƒë·ªïi qu√†!"}
                            </p>
                        </div>
                    </div>
                    {weakTopic && (
                        <ClayButton 
                            onClick={() => handleSmartPractice(weakTopic)}
                            colorClass="bg-white text-red-500"
                            className="w-full h-10 text-sm font-black flex items-center justify-center gap-2 !rounded-xl mt-1 shadow-md"
                        >
                            <Play size={16} fill="currentColor"/> Luy·ªán "{getTopicVietnamese(weakTopic)}" ngay
                        </ClayButton>
                    )}
                </div>
            </div>

            {/* --- WEEKLY CHART (Quan tr·ªçng: shrink-0 v√† min-height) --- */}
            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6 shrink-0">
                <div className="flex items-center justify-between mb-6">
                    <h3 className="font-black text-slate-700 flex items-center gap-2 text-sm uppercase">
                        <Calendar size={18} className="text-blue-500"/> {chartTitle}
                    </h3>
                    <div className="flex gap-2 text-[10px] font-black">
                        {['week', 'month', 'all'].map(option => (
                            <button
                                key={option}
                                onClick={() => setHistoryFilter(option)}
                                className={`px-3 py-1 rounded-full border ${historyFilter === option ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-slate-100 text-slate-500 border-slate-200'}`}
                            >
                                {option === 'week' ? '7 ng√†y' : option === 'month' ? 'Th√°ng' : 'T·∫•t c·∫£'}
                            </button>
                        ))}
                    </div>
                </div>
                
                {/* Chart Container v·ªõi chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ tr√°nh b·ªã b·∫πp */}
                <div className="h-48 flex items-end justify-between gap-2 sm:gap-4 px-1">
                    {chartData.map((day, idx) => {
                        const maxScore = Math.max(...chartData.map(d => d.score), 2000); 
                        
                        // Chi·ªÅu cao %
                        const heightPercent = day.score > 0 ? Math.max((day.score / maxScore) * 100, 5) : 2; 
                        const isToday = historyFilter === 'week' ? idx === 6 : false;
                        
                        return (
                            <div key={idx} className="flex-1 flex flex-col items-center justify-end group h-full">
                                {/* Score Label (Bay l√™n khi hover) */}
                                <div className={`mb-2 text-[10px] font-black transition-all transform ${day.score > 0 ? 'text-indigo-500 opacity-100 translate-y-0' : 'text-slate-300 opacity-0 group-hover:opacity-100 group-hover:-translate-y-1'}`}>
                                    {day.score > 0 ? fmt(day.score) : '0'}
                                </div>
                                
                                {/* Bar */}
                                <div className="w-full max-w-[32px] sm:max-w-[40px] flex items-end relative">
                                    <div 
                                        className={`w-full rounded-t-lg transition-all duration-700 ease-out mx-auto ${isToday ? 'bg-indigo-500 shadow-indigo-200 shadow-lg' : (day.score > 0 ? 'bg-indigo-200 group-hover:bg-indigo-400' : 'bg-slate-100')}`}
                                        style={{ height: `${heightPercent}%` }}
                                    ></div>
                                </div>

                                {/* Date Label */}
                                <div className={`mt-3 text-[10px] font-bold uppercase tracking-wider ${isToday ? 'text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md' : 'text-slate-400'}`}>
                                    {historyFilter === 'week' ? day.dayOfWeek : day.label}
                                </div>
                            </div>
                        )
                    })}
                </div>
            </div>

            {/* --- TOPIC PROGRESS (Shrink-0) --- */}
            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6 shrink-0">
                <h3 className="font-black text-slate-700 mb-4 flex items-center gap-2 text-sm uppercase">
                    <Trophy size={18} className="text-green-500"/> Ch·ªâ s·ªë nƒÉng l·ª±c
                </h3>
                <div className="space-y-4">
                    {stats?.topics && Object.keys(stats.topics).length > 0 ? Object.entries(stats.topics).map(([key, val]) => {
                        const rate = val.total > 0 ? (val.correct / val.total) * 100 : 0;
                        const label = getTopicVietnamese(key);
                        let colorClass = rate >= 80 ? "bg-green-500" : rate >= 50 ? "bg-yellow-500" : "bg-red-500";
                        return (
                            <div key={key}>
                                <div className="flex justify-between text-xs font-bold text-slate-500 mb-1.5">
                                    <span className="flex items-center gap-1.5">{label}</span>
                                    <span>{Math.round(rate)}% <span className="text-slate-300 font-normal text-[10px]">({val.correct}/{val.total})</span></span>
                                </div>
                                <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner ring-1 ring-slate-50">
                                    <div className={`h-full ${colorClass} transition-all duration-1000 rounded-full relative`} style={{width: `${rate}%`}}>
                                        <div className="absolute top-0 right-0 bottom-0 w-full bg-gradient-to-b from-white/20 to-transparent"></div>
                                    </div>
                                </div>
                            </div>
                        );
                    }) : <div className="text-center text-slate-400 text-sm py-4 italic">Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc t·∫≠p</div>}
                </div>
            </div>

            {/* --- HISTORY LIST --- */}
            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 pb-10 shrink-0">
                <h3 className="font-black text-slate-700 mb-4 flex items-center gap-2 text-sm uppercase">
                    <Clock size={18} className="text-orange-500"/> L·ªãch s·ª≠ ƒë·∫•u tr∆∞·ªùng
                </h3>
                <div className="space-y-3">
                    {logs.length > 0 ? logs.map((log, index) => (
                        <ClayButton 
                            key={log.id || index} 
                            onClick={() => setSelectedLog(log)}
                            colorClass="bg-slate-50 hover:bg-white"
                            className="w-full flex justify-between items-center p-3 rounded-xl border border-slate-100 group"
                        >
                            <div className="text-left">
                                <div className="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    B√†i t·∫≠p {log.difficultyMode === 'easy' ? 'Kh·ªüi ƒë·ªông' : log.difficultyMode === 'hard' ? 'Th·∫ßn ƒë·ªìng' : 'Ti√™u chu·∫©n'}
                                </div>
                                <div className="text-[10px] font-bold text-slate-400 mt-0.5">
                                    {new Date(log.timestamp).toLocaleDateString('vi-VN')} ‚Ä¢ {new Date(log.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="font-black text-indigo-600">+{fmt(log.score)}ƒë</div>
                                    <div className={`text-[10px] font-bold ${log.questions.filter(q=>q.isCorrect).length >= 5 ? 'text-green-500' : 'text-red-500'}`}>
                                        {log.questions.filter(q=>q.isCorrect).length}/10 ƒë√∫ng
                                    </div>
                                </div>
                                <ChevronRight size={16} className="text-slate-300 group-hover:text-indigo-500 transition-colors"/>
                            </div>
                        </ClayButton>
                    )) : <div className="text-center text-slate-400 text-sm py-4 italic">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i</div>}
                </div>
            </div>

            {/* --- DETAIL MODAL --- */}
            {selectedLog && (
                <div className="fixed inset-0 z-[100] bg-slate-100 flex flex-col animation-fade-in overflow-hidden">
                    <div className="bg-white px-4 py-4 shadow-sm border-b border-slate-200 flex items-center gap-3 shrink-0 pt-safe-top">
                        <ClayButton onClick={() => setSelectedLog(null)} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0 bg-slate-100">
                            <ArrowLeft size={20} className="text-slate-600"/>
                        </ClayButton>
                        <div className="flex-1">
                            <h2 className="font-black text-slate-700 text-lg">Chi ti·∫øt b√†i l√†m</h2>
                            <p className="text-xs font-bold text-slate-400">
                                {new Date(selectedLog.timestamp).toLocaleDateString('vi-VN')} ‚Ä¢ T·ªïng ƒëi·ªÉm: {fmt(selectedLog.score)}ƒë
                            </p>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24 no-scrollbar">
                        {selectedLog.questions.map((q, idx) => (
                            <div key={idx} className={`bg-white p-4 rounded-2xl border-2 shadow-sm ${q.isCorrect ? 'border-green-100' : 'border-red-100'}`}>
                                <div className="flex gap-3 mb-3">
                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-black shrink-0 ${q.isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {idx + 1}
                                    </div>
                                    <div className="font-bold text-slate-700 text-sm leading-relaxed">
                                        <MathText text={q.text || "N·ªôi dung c√¢u h·ªèi kh√¥ng kh·∫£ d·ª•ng"} />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className={`p-2 rounded-lg border ${q.isCorrect ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                                        <span className="block font-black opacity-50 mb-1 uppercase text-[10px]">B√© ch·ªçn</span>
                                        <span className="font-bold">{q.userAnswer ? <MathText text={q.userAnswer} /> : "Kh√¥ng tr·∫£ l·ªùi"}</span>
                                    </div>
                                    <div className="p-2 rounded-lg bg-slate-50 border border-slate-200 text-slate-700">
                                        <span className="block font-black opacity-50 mb-1 uppercase text-[10px]">ƒê√°p √°n ƒë√∫ng</span>
                                        <span className="font-bold flex items-center gap-1">
                                            {q.correctOption} 
                                            {q.correctVal && q.correctVal !== q.correctOption && <span> (<MathText text={q.correctVal}/>)</span>}
                                        </span>
                                    </div>
                                </div>

                                {!q.isCorrect && q.explanation && (
                                    <div className="mt-2 pt-2 border-t border-red-50 text-xs text-slate-500 leading-relaxed">
                                        <span className="font-bold text-slate-400 mr-1">Gi·∫£i th√≠ch:</span> 
                                        <MathText text={q.explanation} />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};
export default ReportScreen;

==================================================
FILE PATH: src\components\ResultScreen.jsx
==================================================
import React from 'react';

const ResultScreen = ({ history, sessionScore, setGameState, currentProfile }) => {
    const correctAnswers = history.filter(q => q.isCorrect).length;
    const totalQuestions = history.length;

    return (
        <div className="p-6">
            <h1 className="text-3xl font-bold text-center mb-2">Ho√†n th√†nh!</h1>
            <p className="text-center text-gray-600 mb-6">Ch√∫c m·ª´ng {currentProfile?.name} ƒë√£ ho√†n th√†nh b√†i t·∫≠p.</p>

            <div className="bg-indigo-100 p-6 rounded-lg text-center mb-6">
                <p className="text-lg">T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c</p>
                <p className="text-5xl font-black text-indigo-600">{sessionScore}</p>
            </div>
            
            <div className="grid grid-cols-2 gap-4 text-center mb-6">
                <div className="bg-green-100 p-4 rounded-lg">
                    <p className="text-2xl font-bold text-green-700">{correctAnswers}</p>
                    <p className="text-sm font-semibold text-green-600">C√¢u ƒë√∫ng</p>
                </div>
                 <div className="bg-red-100 p-4 rounded-lg">
                    <p className="text-2xl font-bold text-red-700">{totalQuestions - correctAnswers}</p>
                    <p className="text-sm font-semibold text-red-600">C√¢u sai</p>
                </div>
            </div>

            <h2 className="font-bold text-lg mb-2">Xem l·∫°i b√†i l√†m:</h2>
            <div className="space-y-2 max-h-60 overflow-y-auto">
                {history.map((q, index) => (
                    <div key={q.id} className={`p-3 rounded-lg ${q.isCorrect ? 'bg-green-50' : 'bg-red-50'}`}>
                       <p className="font-semibold text-sm">C√¢u {index + 1}: {q.text}</p>
                       <p className="text-xs">B·∫°n ch·ªçn: {q.userAnswer}. ƒê√°p √°n ƒë√∫ng: {q.correctOption}</p>
                    </div>
                ))}
            </div>

            <button onClick={() => setGameState('home')} className="w-full bg-blue-500 text-white p-4 rounded-lg mt-6 font-bold">
                V·ªÅ trang ch·ªß
            </button>
        </div>
    );
};

export default ResultScreen;


==================================================
FILE PATH: src\components\ShopScreen.jsx
==================================================
import React, { useMemo, useState, useEffect } from 'react';
import { ArrowLeft, PiggyBank, Banknote, Clock, Shield, ShieldCheck, CircleAlert, CheckCircle, XCircle, AlertTriangle } from 'lucide-react';
import { ClayButton } from '../lib/helpers';
import { SHOP_ITEMS, REDEMPTION_STATUS } from '../lib/constants';
import { fmt } from '../lib/utils';

const STATUS_BADGE = {
    [REDEMPTION_STATUS.PENDING]: { label: 'Ch·ªù duy·ªát', color: 'bg-amber-100 text-amber-600' },
    [REDEMPTION_STATUS.APPROVED]: { label: 'ƒê√£ duy·ªát', color: 'bg-green-100 text-green-600' },
    [REDEMPTION_STATUS.REJECTED]: { label: 'T·ª´ ch·ªëi', color: 'bg-red-100 text-red-600' }
};

const ShopScreen = ({
    piggyBank,
    setGameState,
    redeemCash,
    redemptionRequests,
    onApproveRequest,
    onRejectRequest,
    ensureParentAccess,
    parentAccessValid
}) => {
    const [adminMode, setAdminMode] = useState(false);
    const [adminMessage, setAdminMessage] = useState(null);
    const [adminError, setAdminError] = useState(null);
    const [confirmRequest, setConfirmRequest] = useState(null);

    const pendingRequests = useMemo(
        () => redemptionRequests.filter(r => r.status === REDEMPTION_STATUS.PENDING),
        [redemptionRequests]
    );
    const historyRequests = useMemo(
        () => redemptionRequests.filter(r => r.status !== REDEMPTION_STATUS.PENDING).sort((a, b) => (b.approvedAt || b.rejectedAt || 0) - (a.approvedAt || a.rejectedAt || 0)),
        [redemptionRequests]
    );

    const toggleAdmin = () => {
        if (adminMode) {
            setAdminMode(false);
            return;
        }
        if (parentAccessValid) {
            setAdminMode(true);
        } else {
            ensureParentAccess('shop_admin', () => setAdminMode(true));
        }
    };

    const handleDecision = async (requestId, action) => {
        if (action === 'approve') {
            const req = pendingRequests.find(r => r.requestId === requestId);
            if (req) setConfirmRequest(req);
            return;
        }
        setAdminMessage(null);
        setAdminError(null);
        const result = await onRejectRequest(requestId);
        if (result?.success) setAdminMessage(result.message);
        else setAdminError(result?.message || 'Kh√¥ng th·ª±c hi·ªán ƒë∆∞·ª£c thao t√°c.');
    };

    const confirmApprove = async () => {
        if (!confirmRequest) return;
        setAdminMessage(null);
        setAdminError(null);
        const result = await onApproveRequest(confirmRequest.requestId);
        if (result?.success) {
            setAdminMessage(result.message);
            setConfirmRequest(null);
        } else {
            setAdminError(result?.message || 'Kh√¥ng th·ª±c hi·ªán ƒë∆∞·ª£c thao t√°c.');
        }
    };

    useEffect(() => {
        if (!parentAccessValid && adminMode) {
            const timer = setTimeout(() => setAdminMode(false), 0);
            return () => clearTimeout(timer);
        }
    }, [parentAccessValid, adminMode]);

    return (
        <div className="flex flex-col h-full bg-purple-50">
            <div className="p-4 pt-6 flex justify-between items-center bg-white/90 sticky top-0 z-10 shadow-sm">
                <ClayButton onClick={() => setGameState('home')} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0">
                    <ArrowLeft size={20} className="text-slate-500"/>
                </ClayButton>
                <div className="flex items-center gap-2 bg-pink-100 px-4 py-1.5 rounded-full border border-pink-200">
                    <PiggyBank className="text-pink-600 fill-pink-400" size={20} />
                    <span className="font-black text-pink-700 text-xl">{fmt(piggyBank)}ƒë</span>
                </div>
            </div>
            <div className="p-4 flex flex-col gap-4 overflow-y-auto pb-24 no-scrollbar">
                <div className="flex items-center justify-between px-2">
                    <h2 className="font-black text-slate-700 text-xl">ƒê·ªïi ti·ªÅn m·∫∑t</h2>
                    <ClayButton onClick={toggleAdmin} colorClass={adminMode ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'} className="h-9 px-3 text-xs font-black !rounded-full border border-slate-200">
                        <Shield size={14} /> {adminMode ? 'ƒê√≥ng ch·∫ø ƒë·ªô ph·ª• huynh' : 'Ch·∫ø ƒë·ªô ph·ª• huynh'}
                    </ClayButton>
                </div>
                {!adminMode && SHOP_ITEMS.map(item => { 
                    const canBuy = piggyBank >= item.value; 
                    return (
                        <ClayButton key={item.id} onClick={() => redeemCash(item)} colorClass="bg-white" className={`h-24 flex items-center px-6 gap-4 border-2 ${item.color} ${!canBuy ? 'opacity-50 grayscale' : ''}`} disabled={!canBuy}>
                            <div className="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl bg-slate-50 border border-slate-100 shadow-sm"><Banknote/></div>
                            <div className="flex-1 text-left">
                                <div className="font-black text-lg text-slate-700">{item.name}</div>
                                <div className="text-xs font-medium text-slate-400">ƒê·ªïi ngay ƒë·ªÉ nh·∫≠n ti·ªÅn th·∫≠t</div>
                            </div>
                            <div className={`px-3 py-1 rounded-full text-sm font-black flex gap-1 ${canBuy ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}`}>{fmt(item.value)}ƒë</div>
                        </ClayButton>
                    ); 
                })}

                {!adminMode && redemptionRequests.length > 0 && (
                    <div className="mt-2 px-2">
                        <h3 className="font-bold text-slate-500 text-sm uppercase mb-4">V√≠ qu√† t·∫∑ng c·ªßa b√©</h3>
                        <div className="space-y-3">
                            {redemptionRequests.slice().reverse().map((req) => {
                                const badge = STATUS_BADGE[req.status];
                                return (
                                    <div key={req.requestId} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                        <div>
                                            <div className="font-bold text-slate-700 text-sm">{req.name}</div>
                                            <div className={`text-[10px] font-black px-2 py-0.5 rounded-full inline-flex items-center gap-1 mt-1 ${badge.color}`}>
                                                <Clock size={10}/> {badge.label}
                                            </div>
                                            <div className="text-[10px] text-slate-400 mt-0.5">{req.requestedAt ? new Date(req.requestedAt).toLocaleDateString('vi-VN') : 'Ch∆∞a x√°c ƒë·ªãnh'}</div>
                                        </div>
                                        <span className="font-black text-red-500 text-sm">-{fmt(req.value)}ƒë</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {adminMode && (
                    <div className="bg-white rounded-3xl p-4 border border-slate-100 shadow-sm space-y-4">
                        <div className="flex items-center gap-2">
                            <ShieldCheck className="text-green-500"/>
                            <h3 className="font-black text-slate-700 text-lg">Trung t√¢m duy·ªát qu√†</h3>
                        </div>
                        {adminMessage && <div className="text-sm font-bold text-green-600 bg-green-50 px-3 py-2 rounded-xl">{adminMessage}</div>}
                        {adminError && <div className="text-sm font-bold text-red-600 bg-red-50 px-3 py-2 rounded-xl">{adminError}</div>}
                        <section>
                            <h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Y√™u c·∫ßu ƒëang ch·ªù ({pendingRequests.length})</h4>
                            {pendingRequests.length === 0 && (
                                <div className="text-center text-slate-400 text-sm py-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                                    <CircleAlert className="mx-auto mb-2" size={20}/>
                                    Ch∆∞a c√≥ y√™u c·∫ßu n√†o.
                                </div>
                            )}
                            <div className="space-y-3">
                                {pendingRequests.map(req => (
                                    <div key={req.requestId} className="p-3 border border-amber-100 rounded-2xl bg-amber-50 flex justify-between items-center">
                                        <div>
                                            <div className="font-black text-slate-700">{req.name}</div>
                                            <div className="text-xs text-slate-400 font-bold">Gi√° tr·ªã: {fmt(req.value)}ƒë</div>
                                            <div className="text-[10px] text-slate-400 mt-1">G·ª≠i l√∫c {new Date(req.requestedAt).toLocaleString('vi-VN')}</div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <ClayButton onClick={() => handleDecision(req.requestId, 'approve')} colorClass="bg-green-500 text-white" className="px-3 py-1 text-xs font-black !rounded-xl flex items-center justify-center gap-1">
                                                <CheckCircle size={12}/> Duy·ªát
                                            </ClayButton>
                                            <ClayButton onClick={() => handleDecision(req.requestId, 'reject')} colorClass="bg-red-100 text-red-600" className="px-3 py-1 text-xs font-black !rounded-xl flex items-center justify-center gap-1">
                                                <XCircle size={12}/> T·ª´ ch·ªëi
                                            </ClayButton>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                        {historyRequests.length > 0 && (
                            <section>
                                <h4 className="text-xs font-bold text-slate-400 uppercase mb-2">L·ªãch s·ª≠ x·ª≠ l√Ω</h4>
                                <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                    {historyRequests.map(req => {
                                        const badge = STATUS_BADGE[req.status];
                                        return (
                                            <div key={req.requestId} className="flex justify-between items-center p-2 bg-slate-50 rounded-xl">
                                                <div>
                                                    <div className="text-sm font-black text-slate-700">{req.name}</div>
                                                    <div className="text-[10px] text-slate-400">{new Date(req.approvedAt || req.rejectedAt).toLocaleDateString('vi-VN')}</div>
                                                </div>
                                                <div className={`text-[10px] font-black px-2 py-0.5 rounded-full ${badge.color}`}>{badge.label}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                        )}
                    </div>
                )}
            </div>

            {/* Confirm Approve Modal */}
            {confirmRequest && (
                <div className="fixed inset-0 z-[130] bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-[2rem] p-6 shadow-2xl relative border-4 border-amber-200">
                        <button onClick={() => setConfirmRequest(null)} className="absolute top-4 right-4 text-slate-400 hover:text-red-500">
                            <XCircle size={24} />
                        </button>
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-amber-100 rounded-2xl flex items-center justify-center mx-auto mb-3 text-amber-600">
                                <AlertTriangle size={32} />
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 mb-2">X√°c nh·∫≠n duy·ªát qu√†</h2>
                            <p className="text-sm font-bold text-slate-500">B·∫°n ƒë√£ ƒë∆∞a ti·ªÅn m·∫∑t cho b√© ch∆∞a?</p>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm font-bold text-slate-600">Qu√† t·∫∑ng:</span>
                                <span className="text-lg font-black text-slate-700">{confirmRequest.name}</span>
                            </div>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm font-bold text-slate-600">Gi√° tr·ªã:</span>
                                <span className="text-xl font-black text-red-600">{fmt(confirmRequest.value)}ƒë</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-bold text-slate-600">Y√™u c·∫ßu l√∫c:</span>
                                <span className="text-xs font-bold text-slate-400">{new Date(confirmRequest.requestedAt).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-6">
                            <p className="text-xs font-bold text-amber-700 text-center">
                                ‚ö†Ô∏è Sau khi duy·ªát, {fmt(confirmRequest.value)}ƒë s·∫Ω b·ªã tr·ª´ kh·ªèi v√≠ ti·∫øt ki·ªám c·ªßa b√©. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ ƒë∆∞a ti·ªÅn m·∫∑t cho b√©.
                            </p>
                        </div>
                        <div className="flex gap-3">
                            <ClayButton onClick={() => setConfirmRequest(null)} colorClass="bg-slate-100 text-slate-500" className="flex-1 h-12 font-black !rounded-xl">
                                H·ªßy
                            </ClayButton>
                            <ClayButton onClick={confirmApprove} colorClass="bg-green-500 text-white" className="flex-1 h-12 font-black !rounded-xl flex items-center justify-center gap-2">
                                <CheckCircle size={18}/> ƒê√£ ƒë∆∞a ti·ªÅn, duy·ªát ngay
                            </ClayButton>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default ShopScreen;


==================================================
FILE PATH: src\components\UserProfile.jsx
==================================================


==================================================
FILE PATH: src\components\UserProfileScreen.jsx
==================================================
import React, { useState } from 'react';
import { 
    UserCog, XCircle, CheckCircle, AlertTriangle, User, Mail, Save, Key, 
    RefreshCw, Loader, LogOut, MessageSquarePlus, ShieldCheck, Smartphone,
    Users, Edit3, Trash2, PlusCircle, Shield, Power
} from 'lucide-react'; 
import { updateProfile, updatePassword } from 'firebase/auth';
import { auth } from '../lib/firebase';
import { ClayButton } from '../lib/helpers';
import FeedbackModal from './FeedbackModal';
import { AVATARS } from '../lib/constants'; 
import { getDeviceId } from '../lib/utils';

const UserProfileScreen = ({
    appUser,
    setAppUser,
    setGameState,
    onLogout,
    profiles,
    onSaveProfiles,
    deviceSessions = [],
    onRemoteLogoutDevice,
    parentSettings,
    onUpdateParentSettings
}) => {
    // --- STATE QU·∫¢N L√ù T√ÄI KHO·∫¢N ---
    const [displayName, setDisplayName] = useState(appUser.displayName || '');
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [message, setMessage] = useState(null);
    const [error, setError] = useState(null);
    const [loading, setLoading] = useState(false);
    const [showFeedback, setShowFeedback] = useState(false);
    const [pinValue, setPinValue] = useState('');
    const [pinConfirm, setPinConfirm] = useState('');
    const [pinLoading, setPinLoading] = useState(false);

    // --- STATE QU·∫¢N L√ù S·ª¨A PROFILE ---
    const [editingProfile, setEditingProfile] = useState(null); 
    const [editName, setEditName] = useState('');
    const [editAvatar, setEditAvatar] = useState('');
    const [localDeviceId] = useState(() => getDeviceId());

    // --- H√ÄM C·∫¨P NH·∫¨T T√äN HI·ªÇN TH·ªä (PH·ª§ HUYNH) ---
    const handleUpdateProfile = async () => {
        setLoading(true); setMessage(null); setError(null);
        try {
            if (auth.currentUser) {
                await updateProfile(auth.currentUser, { displayName: displayName });
                
                const updatedUser = { ...appUser, displayName };
                setAppUser(updatedUser);
                localStorage.setItem('math_app_user_session', JSON.stringify(updatedUser));
                
                setMessage("ƒê√£ c·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã!");
            } else {
                setError("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p.");
            }
        } catch (e) {
            setError("L·ªói c·∫≠p nh·∫≠t: " + e.message);
        }
        setLoading(false);
    };

    const handleSavePin = async () => {
        if (pinValue.length < 4) { setError("M√£ PIN ph·∫£i c√≥ √≠t nh·∫•t 4 s·ªë."); return; }
        if (pinValue !== pinConfirm) { setError("PIN x√°c nh·∫≠n ch∆∞a kh·ªõp."); return; }
        setPinLoading(true); setMessage(null); setError(null);
        const result = await onUpdateParentSettings({ pin: pinValue });
        setPinLoading(false);
        if (result.success) {
            setMessage("ƒê√£ l∆∞u m√£ PIN ph·ª• huynh!");
            setPinValue(''); setPinConfirm('');
        } else {
            setError(result.message || "Kh√¥ng th·ªÉ l∆∞u m√£ PIN.");
        }
    };

    const handleClearPin = async () => {
        if (!parentSettings?.pinHash) return;
        setPinLoading(true); setMessage(null); setError(null);
        const result = await onUpdateParentSettings({ pin: '' });
        setPinLoading(false);
        if (result.success) setMessage("ƒê√£ xo√° m√£ PIN. Vui l√≤ng ƒë·∫∑t m√£ m·ªõi ƒë·ªÉ b·∫£o v·ªá b√©.");
        else setError(result.message || "Kh√¥ng th·ªÉ xo√° m√£ PIN.");
    };

    const handleRemoteLogout = async (deviceId) => {
        if (!window.confirm("ƒêƒÉng xu·∫•t thi·∫øt b·ªã n√†y kh·ªèi t√†i kho·∫£n?")) return;
        setLoading(true); setMessage(null); setError(null);
        const result = await onRemoteLogoutDevice(deviceId);
        setLoading(false);
        if (result.success) setMessage(result.message);
        else setError(result.message);
    };

    // --- H√ÄM ƒê·ªîI M·∫¨T KH·∫®U ---
    const handleChangePassword = async () => {
        if (!newPassword || !confirmPassword) { setError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi"); return; }
        if (newPassword !== confirmPassword) { setError("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp"); return; }
        if (newPassword.length < 6) { setError("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n"); return; }

        setLoading(true); setMessage(null); setError(null);
        try {
            if (auth.currentUser) {
                await updatePassword(auth.currentUser, newPassword);
                setMessage("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
                setNewPassword(''); setConfirmPassword('');
            } else {
                setError("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.");
            }
        } catch (e) {
            if (e.code === 'auth/requires-recent-login') {
                setError("ƒê·ªÉ b·∫£o m·∫≠t, vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i tr∆∞·ªõc khi ƒë·ªïi m·∫≠t kh·∫©u.");
            } else {
                setError("L·ªói: " + e.message);
            }
        }
        setLoading(false);
    };

    // --- C√ÅC H√ÄM CRUD PROFILE H·ªåC SINH ---
    const startEdit = (profile) => {
        setEditingProfile(profile);
        setEditName(profile.name);
        setEditAvatar(profile.avatar);
    };

    const handleDeleteProfile = (profileId) => {
        if (window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªì s∆° n√†y? D·ªØ li·ªáu h·ªçc t·∫≠p c·ªßa b√© s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn.")) {
            const newList = profiles.filter(p => p.id !== profileId);
            onSaveProfiles(newList);
        }
    };

    const saveEditProfile = () => {
        if (!editName.trim()) return;
        const newList = profiles.map(p => 
            p.id === editingProfile.id 
                ? { ...p, name: editName, avatar: editAvatar } 
                : p
        );
        onSaveProfiles(newList);
        setEditingProfile(null);
    };

    return (
        <div className="flex flex-col h-full bg-slate-50 relative">
            {/* Header */}
            <div className="flex justify-between items-center p-6 bg-white shadow-sm z-10 shrink-0">
                <h2 className="text-2xl font-black text-slate-700 flex items-center gap-2">
                    <UserCog className="text-blue-500"/> T√†i Kho·∫£n
                </h2>
                <ClayButton onClick={() => setGameState('home')} className="w-10 h-10 flex items-center justify-center !rounded-full !p-0">
                    <XCircle size={24} className="text-slate-400"/>
                </ClayButton>
            </div>

            <div className="flex-1 overflow-y-auto p-6 space-y-6 pb-32 no-scrollbar">
                {/* Th√¥ng b√°o */}
                {message && <div className="bg-green-100 text-green-700 p-3 rounded-xl font-bold flex gap-2 animate-fade-in"><CheckCircle size={20}/> {message}</div>}
                {error && <div className="bg-red-100 text-red-600 p-3 rounded-xl font-bold flex gap-2 animate-shake"><AlertTriangle size={20}/> {error}</div>}

                {/* --- M·ª§C 1: QU·∫¢N L√ù H·ªí S∆† H·ªåC SINH --- */}
                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-400 text-xs uppercase flex items-center gap-2"><Users size={14}/> H·ªì s∆° h·ªçc sinh ({profiles.length})</h3>
                        <button onClick={() => setGameState('profile_select')} className="text-indigo-500 font-bold text-xs flex items-center gap-1 hover:underline">
                            <PlusCircle size={14}/> Th√™m m·ªõi
                        </button>
                    </div>
                    
                    <div className="space-y-3">
                        {profiles.map(profile => (
                            <div key={profile.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-200">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-xl shadow-sm border border-slate-100">
                                        {profile.avatar}
                                    </div>
                                    <span className="font-black text-slate-700">{profile.name}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => startEdit(profile)} className="p-2 bg-white text-blue-500 rounded-xl border border-blue-100 hover:bg-blue-50 transition-colors">
                                        <Edit3 size={16}/>
                                    </button>
                                    <button onClick={() => handleDeleteProfile(profile.id)} className="p-2 bg-white text-red-500 rounded-xl border border-red-100 hover:bg-red-50 transition-colors">
                                        <Trash2 size={16}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {profiles.length === 0 && <div className="text-center text-slate-400 text-sm italic py-2">Ch∆∞a c√≥ h·ªì s∆° n√†o</div>}
                    </div>
                </div>

                {/* --- M·ª§C 2: TH√îNG TIN PH·ª§ HUYNH --- */}
                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <h3 className="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><User size={14}/> Th√¥ng tin chung</h3>
                    <div className="space-y-4">
                        <div>
                            <label className="text-xs font-bold text-slate-400 block mb-1">Email ƒëƒÉng nh·∫≠p</label>
                            <div className="w-full h-12 px-4 rounded-xl bg-slate-100 flex items-center text-slate-600 font-bold border border-slate-200">
                                <Mail size={16} className="mr-2 opacity-50"/> {appUser.email || "T√†i kho·∫£n ·∫©n danh"}
                            </div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-400 block mb-1">T√™n ph·ª• huynh</label>
                            <div className="flex gap-2">
                                <input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} className="flex-1 h-12 px-4 rounded-xl border-2 border-slate-100 bg-white focus:border-blue-500 outline-none font-bold text-slate-700 transition-all"/>
                                <ClayButton onClick={handleUpdateProfile} disabled={loading} colorClass="bg-blue-100 text-blue-600" className="w-12 h-12 flex items-center justify-center !rounded-xl border-blue-200">
                                    {loading ? <Loader size={20} className="animate-spin"/> : <Save size={20}/>}
                                </ClayButton>
                            </div>
                        </div>
                    </div>
                </div>

                {/* --- M·ª§C 3: M√É PIN PH·ª§ HUYNH --- */}
                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <h3 className="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><Shield size={14}/> H√†ng r√†o ph·ª• huynh</h3>
                    <div className="space-y-3">
                        <input
                            type="password"
                            value={pinValue}
                            onChange={e => setPinValue(e.target.value.replace(/\D/g, ''))}
                            placeholder="Nh·∫≠p m√£ PIN 4 s·ªë"
                            maxLength={6}
                            className="w-full h-12 px-4 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all"
                        />
                        <input
                            type="password"
                            value={pinConfirm}
                            onChange={e => setPinConfirm(e.target.value.replace(/\D/g, ''))}
                            placeholder="Nh·∫≠p l·∫°i m√£ PIN"
                            maxLength={6}
                            className="w-full h-12 px-4 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all"
                        />
                        <div className="flex gap-2">
                            <ClayButton onClick={handleSavePin} disabled={pinLoading || !pinValue} colorClass="bg-indigo-600 text-white" className="flex-1 h-12 font-bold !rounded-xl">
                                {pinLoading ? <Loader size={18} className="animate-spin"/> : 'L∆∞u M√£ PIN'}
                            </ClayButton>
                            <ClayButton onClick={handleClearPin} disabled={!parentSettings?.pinHash || pinLoading} colorClass="bg-slate-100 text-slate-500" className="w-28 h-12 font-bold !rounded-xl">
                                Xo√° PIN
                            </ClayButton>
                        </div>
                        <p className="text-[11px] text-slate-400 font-bold">M√£ PIN s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu khi m·ªü C·∫•u h√¨nh v√† ch·∫ø ƒë·ªô Admin c·ªßa C·ª≠a h√†ng.</p>
                    </div>
                </div>

                {/* --- M·ª§C 4: ƒê·ªîI M·∫¨T KH·∫®U --- */}
                {!appUser.isAnon && (
                    <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <h3 className="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><Key size={14}/> B·∫£o m·∫≠t</h3>
                        <div className="space-y-3">
                            <input type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} placeholder="M·∫≠t kh·∫©u m·ªõi" className="w-full h-12 px-4 rounded-xl border-2 border-slate-100 focus:border-blue-500 outline-none font-bold text-slate-700 transition-all"/>
                            <input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" className="w-full h-12 px-4 rounded-xl border-2 border-slate-100 focus:border-blue-500 outline-none font-bold text-slate-700 transition-all"/>
                            <ClayButton onClick={handleChangePassword} disabled={loading || !newPassword} colorClass="bg-slate-800 text-white" className="w-full h-12 flex items-center justify-center gap-2 font-bold !rounded-xl shadow-lg shadow-slate-200">
                                <RefreshCw size={18}/> C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                            </ClayButton>
                        </div>
                    </div>
                )}

                {/* --- M·ª§C 5: THI·∫æT B·ªä ƒêƒÇNG NH·∫¨P --- */}
                {!appUser.isAnon && (
                    <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <h3 className="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><Smartphone size={14}/> Thi·∫øt b·ªã ƒë√£ ƒëƒÉng nh·∫≠p ({deviceSessions.length}/3)</h3>
                        <div className="space-y-3">
                            {deviceSessions.length === 0 && (
                                <div className="text-center text-slate-400 text-sm italic py-2">Ch∆∞a ghi nh·∫≠n thi·∫øt b·ªã n√†o.</div>
                            )}
                            {deviceSessions.map(device => (
                                <div key={device.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-200">
                                    <div>
                                        <div className="font-black text-slate-700 text-sm">{device.name || 'Thi·∫øt b·ªã l·∫°'}</div>
                                        <div className="text-[10px] text-slate-400">Ho·∫°t ƒë·ªông: {device.lastActive ? new Date(device.lastActive).toLocaleString('vi-VN') : 'Kh√¥ng r√µ'}</div>
                                    </div>
                                    {device.id === localDeviceId ? (
                                        <span className="text-[10px] font-black text-green-500 px-2 py-1 bg-green-100 rounded-full">Thi·∫øt b·ªã n√†y</span>
                                    ) : (
                                        <ClayButton onClick={() => handleRemoteLogout(device.id)} colorClass="bg-red-100 text-red-600" className="h-9 px-3 text-xs font-black !rounded-xl">
                                            <Power size={14}/> ƒêƒÉng xu·∫•t
                                        </ClayButton>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* --- M·ª§C 6: C√îNG C·ª§ KH√ÅC --- */}
                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm space-y-3">
                    <h3 className="font-bold text-slate-400 text-xs uppercase mb-2 flex items-center gap-2"><ShieldCheck size={14}/> Trung t√¢m h·ªó tr·ª£</h3>
                    
                    <ClayButton onClick={() => setShowFeedback(true)} colorClass="bg-yellow-50 text-yellow-700 border-yellow-200" className="w-full h-14 flex items-center px-4 gap-3 !rounded-2xl hover:bg-yellow-100">
                        <div className="w-10 h-10 rounded-full bg-yellow-200 flex items-center justify-center border border-yellow-300"><MessageSquarePlus size={20}/></div>
                        <div className="flex-1 text-left font-bold">G√≥p √Ω & B√°o l·ªói</div>
                    </ClayButton>

                    <ClayButton onClick={() => { if(window.confirm('ƒêƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n n√†y?')) onLogout(true); }} colorClass="bg-red-50 text-red-600 border-red-200" className="w-full h-14 flex items-center px-4 gap-3 !rounded-2xl hover:bg-red-100">
                        <div className="w-10 h-10 rounded-full bg-red-200 flex items-center justify-center border border-red-300"><LogOut size={20}/></div>
                        <div className="flex-1 text-left font-bold">ƒêƒÉng xu·∫•t</div>
                    </ClayButton>
                </div>
                
                {/* Footer Info */}
                <div className="text-center pb-4">
                    <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-200 text-slate-500 text-[10px] font-bold">
                        <Smartphone size={10}/> Thi·∫øt b·ªã ƒëang d√πng: {deviceSessions.length}/3
                    </span>
                </div>
            </div>

            {/* --- MODAL CH·ªàNH S·ª¨A PROFILE --- */}
            {editingProfile && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-shake relative border-4 border-white">
                        <button onClick={() => setEditingProfile(null)} className="absolute top-4 right-4 text-slate-400 hover:text-red-500">
                            <XCircle size={24}/>
                        </button>

                        <h3 className="text-xl font-black text-slate-700 mb-6 text-center">S·ª≠a H·ªì S∆°</h3>
                        
                        <div className="mb-6">
                            <label className="text-xs font-bold text-slate-400 uppercase block mb-2 text-center">T√™n b√©</label>
                            <input 
                                type="text" 
                                value={editName} 
                                onChange={(e) => setEditName(e.target.value)}
                                className="w-full h-14 px-4 rounded-2xl border-2 border-indigo-100 bg-indigo-50 font-bold text-indigo-900 text-lg text-center outline-none focus:border-indigo-500 transition-all"
                            />
                        </div>

                        <div className="mb-8">
                            <label className="text-xs font-bold text-slate-400 uppercase block mb-2 text-center">Ch·ªçn Avatar</label>
                            <div className="flex gap-2 justify-center flex-wrap">
                                {AVATARS.map(avatar => (
                                     <button 
                                        key={avatar} 
                                        onClick={() => setEditAvatar(avatar)} 
                                        className={`text-3xl w-12 h-12 rounded-full flex items-center justify-center transition-transform hover:scale-110 ${editAvatar === avatar ? 'bg-indigo-100 ring-2 ring-indigo-500 scale-110' : 'bg-slate-50'}`}
                                     >
                                        {avatar}
                                     </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <ClayButton onClick={() => setEditingProfile(null)} colorClass="bg-slate-100 text-slate-500" className="flex-1 h-12 font-bold !rounded-xl border-slate-200">H·ªßy</ClayButton>
                            <ClayButton onClick={saveEditProfile} colorClass="bg-indigo-600 text-white" className="flex-1 h-12 font-bold !rounded-xl border-indigo-700 shadow-lg shadow-indigo-200">L∆∞u</ClayButton>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal G√≥p √ù */}
            <FeedbackModal isOpen={showFeedback} onClose={() => setShowFeedback(false)} appUser={appUser} />
        </div>
    );
};

export default UserProfileScreen;

==================================================
FILE PATH: src\hooks\useMathAuth.js
==================================================
import { useState, useEffect, useCallback } from 'react';
import { 
    onAuthStateChanged, signInWithCustomToken, signOut 
} from 'firebase/auth';
import { doc, updateDoc, getDoc, setDoc, onSnapshot } from 'firebase/firestore';
import { auth, db, appId } from '../lib/firebase';
import { getDeviceId, encodeEmail, getDeviceLabel } from '../lib/utils';

export const useMathAuth = () => {
    const [appUser, setAppUser] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [authError, setAuthError] = useState(null);
    const [deviceSessions, setDeviceSessions] = useState([]);

    // Kh·ªüi t·∫°o Auth
    useEffect(() => {
        const initSystemAuth = async () => {
            if (!auth) return;
            try {
                // Ki·ªÉm tra token t·ª´ bi·∫øn m√¥i tr∆∞·ªùng (d√πng cho test/dev n·∫øu c√≥)
                const initialAuthToken = import.meta.env.VITE_INITIAL_AUTH_TOKEN;
                if (initialAuthToken) { 
                    await signInWithCustomToken(auth, initialAuthToken); 
                } 
                
                // ‚ùå ƒê√É S·ª¨A: Xo√° b·ªè ƒëo·∫°n t·ª± ƒë·ªông signInAnonymously ·ªü ƒë√¢y.
                // Vi·ªác ƒëƒÉng nh·∫≠p (k·ªÉ c·∫£ ·∫©n danh) ph·∫£i do ng∆∞·ªùi d√πng k√≠ch ho·∫°t t·ª´ AuthScreen.
                
            } catch (e) {
                console.error("L·ªói Auth Init:", e);
            }
        };

        initSystemAuth();

        const unsubscribe = onAuthStateChanged(auth, (u) => {
            if (u) {
                // Kh√¥i ph·ª•c session t·ª´ localStorage n·∫øu c√≥
                const savedSession = localStorage.getItem('math_app_user_session');
                if (savedSession) {
                    try {
                        const parsedUser = JSON.parse(savedSession);
                        // ƒê·∫£m b·∫£o UID lu√¥n ƒë√∫ng v·ªõi phi√™n hi·ªán t·∫°i c·ªßa Firebase
                        const finalUid = u.uid; 
                        setAppUser({ ...parsedUser, uid: finalUid });
                    } catch { 
                        // N·∫øu JSON l·ªói, th·ª≠ fallback
                        localStorage.removeItem('math_app_user_session'); 
                        if (u.isAnonymous) {
                            setAppUser({ uid: u.uid, isAnon: true });
                        }
                    }
                } else {
                    // N·∫øu Firebase nh·ªõ user (do persistence) nh∆∞ng localStorage m·∫•t (xo√° cache)
                    // Ta v·∫´n kh√¥i ph·ª•c l·∫°i tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                    if (u.isAnonymous) {
                        setAppUser({ uid: u.uid, isAnon: true });
                    }
                    // L∆∞u √Ω: N·∫øu user l√† Google/Email login m√† m·∫•t localStorage, 
                    // h·ªç s·∫Ω c·∫ßn login l·∫°i ƒë·ªÉ l·∫•y l·∫°i th√¥ng tin userAccount ƒë·∫ßy ƒë·ªß (t√™n, avatar...),
                    // ho·∫∑c b·∫°n c√≥ th·ªÉ fetch l·∫°i t·ª´ Firestore ·ªü ƒë√¢y n·∫øu mu·ªën.
                }
            } else {
                // Kh√¥ng c√≥ user (ƒë√£ logout ho·∫∑c ch∆∞a login) -> AppUser = null
                setAppUser(null);
            }
            // ƒê√°nh d·∫•u h·ªá th·ªëng Auth ƒë√£ s·∫µn s√†ng
            setIsAuthReady(true);
        });

        return () => unsubscribe();
    }, []);

    // H√†m Login (X·ª≠ l√Ω logic device limit & merge user)
    // H√†m n√†y ƒë∆∞·ª£c g·ªçi SAU KHI Firebase ƒë√£ sign-in th√†nh c√¥ng (b·ªüi AuthScreen)
    const getAccountRef = (email) => doc(db, 'artifacts', appId, 'public', 'data', 'math_accounts', encodeEmail(email));

    const fetchAccountData = async (email) => {
        if (!email) return { devices: [], deviceSessions: [] };
        const ref = getAccountRef(email);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
            const ownerUid = auth.currentUser?.uid || null;
            await setDoc(ref, { email, ownerUid, devices: [], deviceSessions: [] });
            return { email, ownerUid, devices: [], deviceSessions: [] };
        }
        return snap.data();
    };

    const login = async (userAccount) => {
        const deviceId = getDeviceId();
        let devices = [];
        let sessions = [];
        const isAnon = userAccount.isAnon || false;

        if (!isAnon) {
            const accountData = await fetchAccountData(userAccount.email);
            devices = accountData.devices || [];
            sessions = accountData.deviceSessions || [];

            if (!devices.includes(deviceId)) {
                if (devices.length >= 3) {
                    setAuthError("T√†i kho·∫£n ƒë√£ ƒëƒÉng nh·∫≠p qu√° 3 thi·∫øt b·ªã.");
                    // N·∫øu v∆∞·ª£t qu√° gi·ªõi h·∫°n, sign out ngay l·∫≠p t·ª©c
                    await signOut(auth);
                    return false;
                } else {
                    devices.push(deviceId);
                }
            }

            try {
                const accountRef = getAccountRef(userAccount.email);
                const deviceName = getDeviceLabel();
                const now = Date.now();
                const updatedSessions = [
                    ...sessions.filter(session => session.id !== deviceId),
                    { id: deviceId, name: deviceName, lastActive: now }
                ];
                await updateDoc(accountRef, { devices, deviceSessions: updatedSessions });
            } catch (e) {
                console.warn("L·ªói c·∫≠p nh·∫≠t thi·∫øt b·ªã:", e);
            }
        } else {
            // N·∫øu l√† ·∫©n danh, g√°n UID th·∫≠t t·ª´ Firebase
            userAccount.uid = auth.currentUser?.uid;
        }

        const updatedUser = { ...userAccount, devices };
        setAppUser(updatedUser);
        localStorage.setItem('math_app_user_session', JSON.stringify(updatedUser));
        setAuthError(null);
        return true;
    };

    // H√†m Logout
    const logout = useCallback(async () => {
        try {
            const deviceId = getDeviceId();
            const userEmail = appUser?.email;
            const isAnon = appUser?.isAnon;
            if (userEmail && !isAnon) {
                try {
                    const ref = getAccountRef(userEmail);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const data = snap.data();
                        const filteredDevices = (data.devices || []).filter(id => id !== deviceId);
                        const filteredSessions = (data.deviceSessions || []).filter(sess => sess.id !== deviceId);
                        await updateDoc(ref, { devices: filteredDevices, deviceSessions: filteredSessions });
                    }
                } catch (e) {
                    console.warn("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã khi logout", e);
                }
            }
            await signOut(auth);
            setAppUser(null);
            localStorage.removeItem('math_app_user_session');
            localStorage.removeItem('math_app_last_profile_id'); // Xo√° lu√¥n nh·ªõ profile ƒë·ªÉ s·∫°ch s·∫Ω
            return true;
        } catch (e) {
            console.error("L·ªói Logout:", e);
            return false;
        }
    }, [appUser]);

    const remoteLogoutDevice = async (deviceId) => {
        if (!appUser?.email) return { success: false, message: "Kh√¥ng c√≥ email ƒë·ªÉ x√°c ƒë·ªãnh t√†i kho·∫£n." };
        try {
            const ref = getAccountRef(appUser.email);
            const snap = await getDoc(ref);
            if (!snap.exists()) return { success: false, message: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t√†i kho·∫£n." };
            const data = snap.data();
            const updatedDevices = (data.devices || []).filter(id => id !== deviceId);
            const updatedSessions = (data.deviceSessions || []).filter(sess => sess.id !== deviceId);
            await updateDoc(ref, { devices: updatedDevices, deviceSessions: updatedSessions });
            if (deviceId === getDeviceId()) {
                await logout();
            }
            return { success: true, message: "ƒê√£ ƒëƒÉng xu·∫•t thi·∫øt b·ªã kh·ªèi t√†i kho·∫£n." };
        } catch (error) {
            console.error(error);
            return { success: false, message: "Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t thi·∫øt b·ªã." };
        }
    };

    useEffect(() => {
        if (!appUser?.email || appUser.isAnon) {
            setTimeout(() => setDeviceSessions([]), 0);
            return;
        }
        const ref = getAccountRef(appUser.email);
        const unsubscribe = onSnapshot(ref, (snap) => {
            if (!snap.exists()) return;
            const data = snap.data();
            setDeviceSessions(data.deviceSessions || []);
            if (data.devices && !data.devices.includes(getDeviceId())) {
                logout();
            }
        });
        return () => unsubscribe();
    }, [appUser?.email, appUser?.isAnon, logout]);

    return { appUser, setAppUser, isAuthReady, authError, setAuthError, login, logout, deviceSessions, remoteLogoutDevice };
};

==================================================
FILE PATH: src\hooks\useQuizRunner.js
==================================================
import { useState, useCallback } from 'react';
import { callGemini } from '../lib/gemini';
import { 
    solveEquation, 
    solveComparison, 
    solveSimpleExpression, 
    normalizeVal,
    normalizeComparisonSymbol 
} from '../lib/utils';
import { TOPICS_LIST, TOPIC_TRANSLATIONS, REWARD_PER_LEVEL } from '../lib/constants';
import { buildOfflineQuiz } from '../lib/offlineGenerator';
import { evaluate } from 'mathjs';

const getRandomConstraints = () => {
    const constraints = [
        "∆Øu ti√™n s·ª≠ d·ª•ng c√°c s·ªë l·∫ª trong ph√©p t√≠nh.",
        "∆Øu ti√™n s·ª≠ d·ª•ng c√°c s·ªë ch·∫µn v√† s·ªë tr√≤n ch·ª•c.",
        "K·∫øt qu·∫£ c√°c ph√©p t√≠nh n√™n l·ªõn h∆°n 100.",
        "K·∫øt qu·∫£ c√°c ph√©p t√≠nh n√™n nh·ªè h∆°n 50.",
        "Trong b√†i to√°n ƒë·ªë, h√£y s·ª≠ d·ª•ng t√™n c√°c nh√¢n v·∫≠t trong truy·ªán c·ªï t√≠ch Vi·ªát Nam.",
        "Trong b√†i to√°n ƒë·ªë, h√£y s·ª≠ d·ª•ng b·ªëi c·∫£nh v·ªÅ phi h√†nh gia v√† v≈© tr·ª•.",
        "Trong b√†i to√°n ƒë·ªë, h√£y s·ª≠ d·ª•ng b·ªëi c·∫£nh v·ªÅ c√°c lo√†i ƒë·ªông v·∫≠t d∆∞·ªõi bi·ªÉn.",
        "H√£y t·∫°o √≠t nh·∫•t 1 c√¢u h·ªèi v·ªÅ t√¨m quy lu·∫≠t d√£y s·ªë.",
        "H√£y t·∫°o √≠t nh·∫•t 1 c√¢u h·ªèi so s√°nh.",
        `H√£y s·ª≠ d·ª•ng c√°c s·ªë k·∫øt th√∫c b·∫±ng ${Math.floor(Math.random() * 9)}.`
    ];
    return constraints.sort(() => 0.5 - Math.random()).slice(0, 2).join(" ");
};

export const useQuizRunner = (currentProfile, config) => {
    const [quizData, setQuizData] = useState([]);
    const [currentQIndex, setCurrentQIndex] = useState(0);
    const [selectedOption, setSelectedOption] = useState(null);
    const [isSubmitted, setIsSubmitted] = useState(false);
    const [sessionScore, setSessionScore] = useState(0);
    const [history, setHistory] = useState([]);
    const [questionStartTime, setQuestionStartTime] = useState(null);
    const [isGenerating, setIsGenerating] = useState(false);
    const [preloadedQuiz, setPreloadedQuiz] = useState(null);

    const generateQuizQuestions = useCallback(async (isBackground = false) => {
        if (!currentProfile) return null;

        const randomSeed = Math.floor(Math.random() * 1000000);
        const dynamicConstraint = getRandomConstraints();
        const topicLabels = TOPICS_LIST.filter(t => config.selectedTopics.includes(t.id)).map(t => t.label).join(", ");
        const themes = ["Si√™u th·ªã", "N√¥ng tr·∫°i", "Tr∆∞·ªùng h·ªçc", "Th√°m hi·ªÉm ƒë·∫°i d∆∞∆°ng", "V≈© tr·ª•", "Th·∫ø gi·ªõi k·∫πo ng·ªçt"];
        const randomTheme = themes[Math.floor(Math.random() * themes.length)];

        const aiPrompt = `
        M√£ phi√™n: ${randomSeed}. Vai tr√≤: GV To√°n l·ªõp 3. T·∫°o 10 c√¢u h·ªèi JSON.
        B·ªêI C·∫¢NH: ${config.semester === 'hk1' ? 'HK1' : 'HK2'}. Ch·ªß ƒë·ªÅ: ${randomTheme}.
        CH·ªà T·∫†O C√ÇU H·ªéI V·ªÄ CH·ª¶ ƒê·ªÄ: ${topicLabels}. TUY·ªÜT ƒê·ªêI KH√îNG t·∫°o c√¢u h·ªèi ngo√†i c√°c ch·ªß ƒë·ªÅ n√†y.
        Y√äU C·∫¶U: ${dynamicConstraint}. C√¢u vƒÉn ng·∫Øn g·ªçn. TUY·ªÜT ƒê·ªêI KH√îNG d√πng ƒë∆°n v·ªã "t√°", "l·∫°ng". S·ª≠ d·ª•ng ƒë∆°n v·ªã chu·∫©n: kg, g, l√≠t, ml, km, m, cm, mm.
        QUY T·∫ÆC: 'correctVal' l√† s·ªë/t·ª´ ƒë∆°n gi·∫£n. 'options' ƒë·ªß 4 gi√° tr·ªã.
        TYPES: mcq(40%), fill_blank(20%), comparison(10%), sorting(15%), matching(15%).
        L∆∞u √Ω: N·∫øu ch·ªß ƒë·ªÅ l√† H√¨nh h·ªçc, h√£y ∆∞u ti√™n Type 'mcq' v√† 'comparison', gi·∫£m b·ªõt 'sorting' n·∫øu kh√¥ng ph√π h·ª£p.
        OUTPUT JSON SCHEMA.
        `;

        const processQuestions = (questions) => {
            return questions.map((q, idx) => {
                let processedQ = {
                    ...q, id: idx, level: q.level || 2,
                    topic: TOPIC_TRANSLATIONS[String(q.topic).toLowerCase().trim()] || 'arithmetic',
                    type: q.type || 'mcq'
                };
                
                // --- LOGIC T·ª∞ S·ª¨A L·ªñI AI (SELF-CORRECTION) ---
                let computedVal = null;

                if (processedQ.type === 'comparison') {
                    computedVal = solveComparison(processedQ.text);
                } else if (processedQ.topic === 'finding_x' || processedQ.text.toLowerCase().includes('t√¨m x')) {
                    computedVal = solveEquation(processedQ.text);
                } else if ((processedQ.type === 'mcq' || processedQ.type === 'fill_blank') && (processedQ.topic === 'arithmetic' || processedQ.topic === 'expressions')) {
                    computedVal = solveSimpleExpression(processedQ.text);
                }

                if (computedVal !== null && !isNaN(computedVal)) {
                    const correctStr = String(computedVal);
                    processedQ.correctVal = correctStr;

                    if (processedQ.type === 'mcq' && Array.isArray(processedQ.options)) {
                        const hasCorrectOption = processedQ.options.some(opt => normalizeVal(opt) === normalizeVal(correctStr));
                        if (!hasCorrectOption) {
                            processedQ.options[Math.floor(Math.random() * 4)] = correctStr;
                        }
                    }
                }

                // --- FIX SORTING ---
                if (processedQ.type === 'sorting') {
                    if (!processedQ.items || processedQ.items.length === 0) {
                        let foundItems = processedQ.text.match(/\d+\s*\/\s*\d+/g);
                        if (!foundItems || foundItems.length < 2) {
                            foundItems = processedQ.text.match(/-?\d+(\.\d+)?/g);
                        }
                        if (foundItems && foundItems.length >= 2) processedQ.items = foundItems;
                    }
                    if (processedQ.items && (!processedQ.correctOrder || processedQ.correctOrder.length === 0)) {
                        try {
                            const sorted = [...processedQ.items].sort((a, b) => {
                                const valA = evaluate(String(a).replace(',', '.'));
                                const valB = evaluate(String(b).replace(',', '.'));
                                return processedQ.text.toLowerCase().includes('gi·∫£m') ? valB - valA : valA - valB;
                            });
                            processedQ.correctOrder = sorted;
                        } catch {
                            // ‚úÖ FIX: B·ªè bi·∫øn 'e' kh√¥ng d√πng
                            processedQ.correctOrder = processedQ.items.sort(); 
                        }
                    }
                    if (processedQ.items) processedQ.items = [...processedQ.items].sort(() => Math.random() - 0.5);
                }

                // --- FIX MATCHING ---
                if (processedQ.type === 'matching') {
                    if (!processedQ.pairs || processedQ.pairs.length === 0) {
                        try {
                            let splitParts = processedQ.text.split(/(?:\.\s*|\n)(?:K·∫øt qu·∫£|ƒê√°p √°n|C·ªôt ph·∫£i|Result|Answer):/i);
                            if (splitParts.length < 2) {
                                const withSplit = processedQ.text.split(/\s+v·ªõi\s+(?=[0-9A-Z])/i);
                                if (withSplit.length >= 2) splitParts = withSplit;
                                else splitParts = [processedQ.text, processedQ.text];
                            }

                            const extractItems = (str, pattern) => {
                                const matches = str.match(pattern);
                                return matches ? matches.map(m => m.replace(/^[A-Z0-9]+\s*[).:-]\s*/i, '').trim()) : [];
                            };

                            const numPattern = /[1-4]\s*[).:-]\s*[^,;\n]+/g; 
                            let leftRaw = extractItems(splitParts[0], numPattern);
                            // 

                            if (leftRaw.length === 0) {
                                // ‚úÖ FIX: S·ª≠a l·ªói Regex "Unnecessary escape character" (\+ -> +, \* -> *)
                                leftRaw = processedQ.text.match(/\d+\s*[+\-x*]\s*\d+/g) || [];
                            }

                            const newPairs = [];
                            leftRaw.forEach(leftExpr => {
                                const solvedLeft = solveSimpleExpression(leftExpr);
                                if (solvedLeft !== null) {
                                    const matchRight = String(solvedLeft);
                                    if (processedQ.text.includes(matchRight)) {
                                            newPairs.push({ left: leftExpr, right: matchRight });
                                    }
                                }
                            });
                            if (newPairs.length > 0) processedQ.pairs = newPairs;
                        } catch (e) { console.warn(e); }
                    }
                }

                return processedQ;
            });
        };

        try {
            const aiResult = await callGemini(aiPrompt);
            if (aiResult && !aiResult.debug_error && Array.isArray(aiResult)) {
                return processQuestions(aiResult.slice(0, 10));
            }
            throw new Error("AI data invalid");
        } catch (e) {
            console.warn("AI Error, using backup:", e);
            if (isBackground) return null;

            const offline = buildOfflineQuiz(config);
            return processQuestions(offline);
        }
    }, [currentProfile, config]);

    const startSession = (questions) => {
        setQuizData(questions);
        setCurrentQIndex(0); setSessionScore(0); setHistory([]);
        setSelectedOption(null); setIsSubmitted(false);
        setQuestionStartTime(Date.now());
    };

    const handleSelectOption = (userAnswerData) => {
        if (isSubmitted) return;
        const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
        let displayAnswer = typeof userAnswerData === 'object' ? JSON.stringify(userAnswerData) : userAnswerData;
        setSelectedOption(displayAnswer);

        const currentQ = quizData[currentQIndex];
        let isCorrect = false;
        
        if (currentQ.type === 'sorting') {
            const userArr = Array.isArray(userAnswerData) ? userAnswerData : [];
            const correctArr = currentQ.correctOrder || [];
            if (userArr.length === correctArr.length) {
                isCorrect = userArr.every((val, index) => normalizeVal(val) === normalizeVal(correctArr[index]));
            }
        } else if (currentQ.type === 'matching') {
            isCorrect = userAnswerData === true;
        } else if (currentQ.type === 'comparison') {
            isCorrect = normalizeComparisonSymbol(userAnswerData) === normalizeComparisonSymbol(currentQ.correctVal);
        } else {
            isCorrect = normalizeVal(userAnswerData) === normalizeVal(currentQ.correctVal);
        }

        if (isCorrect) {
            setSessionScore(prev => prev + (REWARD_PER_LEVEL[currentQ.level] || 200));
        }
        setHistory(prev => [...prev, { ...currentQ, userAnswer: displayAnswer, isCorrect, timeTaken }]);
        setIsSubmitted(true);
    };

    const nextQuestion = () => {
        if (currentQIndex < quizData.length - 1) {
            setCurrentQIndex(prev => prev + 1);
            setSelectedOption(null); setIsSubmitted(false);
            setQuestionStartTime(Date.now());
            return true; 
        }
        return false; 
    };

    return {
        quizData, currentQIndex, selectedOption, isSubmitted, sessionScore, history,
        isGenerating, setIsGenerating, preloadedQuiz, setPreloadedQuiz,
        generateQuizQuestions, startSession, handleSelectOption, nextQuestion
    };
};

==================================================
FILE PATH: src\hooks\useUserData.js
==================================================
// src/hooks/useUserData.js
import { useState, useEffect } from 'react';
import { doc, getDoc, setDoc, updateDoc } from 'firebase/firestore';
import { db, appId, auth } from '../lib/firebase';
import { SEMESTER_DEFAULT_TOPICS, DEFAULT_PARENT_SETTINGS, REDEMPTION_STATUS } from '../lib/constants';
import { hashParentPin } from '../lib/utils';
import { secureUpdatePiggyBank } from '../lib/piggyBank';

export const useUserData = (appUser) => {
    const [profiles, setProfiles] = useState([]);
    const [piggyBank, setPiggyBank] = useState(0);
    const [redeemRequests, setRedeemRequests] = useState([]);
    const [userStats, setUserStats] = useState({});
    const [config, setConfig] = useState({
        difficultyMode: 'medium',
        semester: 'hk2',
        selectedTopics: SEMESTER_DEFAULT_TOPICS['hk2'],
    });
    const [parentSettings, setParentSettings] = useState(DEFAULT_PARENT_SETTINGS);
    
    // ‚úÖ FIX L·ªñI F5: M·∫∑c ƒë·ªãnh l√† TRUE ƒë·ªÉ App ch·ªù t·∫£i d·ªØ li·ªáu xong m·ªõi quy·∫øt ƒë·ªãnh hi·ªÉn th·ªã g√¨
    // Tr√°nh vi·ªác ProfileScreen th·∫•y list r·ªóng (do ch∆∞a t·∫£i) m√† v·ªôi v√†ng hi·ªán popup t·∫°o m·ªõi
    const [isLoadingData, setIsLoadingData] = useState(true);

    // Load data khi user thay ƒë·ªïi
    useEffect(() => {
        const loadData = async () => {
            // N·∫øu ch∆∞a c√≥ user, t·∫Øt loading ƒë·ªÉ App x·ª≠ l√Ω lu·ªìng Auth
            if (!appUser || !appUser.uid || !auth.currentUser) {
                setIsLoadingData(false);
                return;
            }
            
            // B·∫Øt ƒë·∫ßu t·∫£i, ƒë·∫£m b·∫£o loading l√† true
            setIsLoadingData(true);
            
            try {
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'math_user_data', appUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    const data = userDocSnap.data();
                    setProfiles(data.profiles || []);
                    setPiggyBank(data.piggyBank || 0);
                    const requests = data.redemptionRequests || (data.redemptionHistory ? data.redemptionHistory.map(req => ({
                        ...req,
                        status: req.status || REDEMPTION_STATUS.APPROVED,
                        approvedAt: req.date || Date.now()
                    })) : []);
                    setRedeemRequests(requests);
                    setUserStats(data.stats || {});
                    if (data.config) setConfig(data.config);
                    setParentSettings(data.parentSettings || DEFAULT_PARENT_SETTINGS);
                } else {
                    // Init data m·ªõi n·∫øu ch∆∞a c√≥
                    const initData = {
                        profiles: [], 
                        piggyBank: 0, 
                        redemptionRequests: [],
                        config: { 
                            difficultyMode: 'medium', 
                            semester: 'hk2', 
                            selectedTopics: SEMESTER_DEFAULT_TOPICS['hk2'] 
                        },
                        stats: {}, 
                        logs: [],
                        parentSettings: DEFAULT_PARENT_SETTINGS
                    };
                    await setDoc(userDocRef, initData);
                    setProfiles([]); 
                    setUserStats({});
                }
            } catch (e) {
                console.error("L·ªói load user data:", e);
                // T·ª± ƒë·ªông reset n·∫øu l·ªói quy·ªÅn truy c·∫≠p
                if (e.code === 'permission-denied' || e.message.includes('Missing or insufficient permissions')) {
                    console.warn("Ph√°t hi·ªán l·ªói session c≈©, ƒëang reset...");
                    localStorage.removeItem('math_app_user_session');
                    window.location.reload();
                }
            } finally {
                // ‚úÖ Lu√¥n t·∫Øt loading khi xong vi·ªác (d√π th√†nh c√¥ng hay th·∫•t b·∫°i)
                setIsLoadingData(false);
            }
        };

        loadData();
    }, [appUser]);

    // H√†m helper ƒë·ªÉ save nhanh
    const saveData = async (newData) => {
        if (!appUser || !appUser.uid) return;
        try {
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'math_user_data', appUser.uid);
            await updateDoc(userDocRef, newData);
        } catch (e) {
            console.error("L·ªói save data:", e);
        }
    };

    // H√†m x·ª≠ l√Ω ƒë·ªïi ti·ªÅn
    const redeemCash = async (item) => {
        if (piggyBank < item.value) {
            return { success: false, message: "S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ ƒë·ªïi qu√† n√†y!" };
        }

        const request = {
            requestId: crypto.randomUUID(),
            id: item.id,
            name: item.name,
            value: item.value,
            status: REDEMPTION_STATUS.PENDING,
            requestedAt: Date.now()
        };
        const newRequests = [...redeemRequests, request];

        try {
            setRedeemRequests(newRequests);

            await saveData({ 
                redemptionRequests: newRequests 
            });

            return { success: true, message: "ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·ªïi qu√†! B·ªë m·∫π s·∫Ω duy·ªát s·ªõm th√¥i." };
        } catch (error) {
            console.error("L·ªói giao d·ªãch:", error);
            return { success: false, message: "L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i sau." };
        }
    };

    const approveRedemption = async (requestId) => {
        const target = redeemRequests.find(r => r.requestId === requestId);
        if (!target) return { success: false, message: "Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu." };
        if (target.status !== REDEMPTION_STATUS.PENDING) {
            return { success: false, message: "Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω." };
        }
        if (piggyBank < target.value) {
            return { success: false, message: "S·ªë d∆∞ hi·ªán t·∫°i kh√¥ng ƒë·ªß ƒë·ªÉ tr·ª´." };
        }

        const updatedRequests = redeemRequests.map(r => r.requestId === requestId
            ? { ...r, status: REDEMPTION_STATUS.APPROVED, approvedAt: Date.now() }
            : r
        );
        try {
            // G·ªçi Cloud Function ƒë·ªÉ tr·ª´ ƒëi·ªÉm an to√†n
            try {
                const res = await secureUpdatePiggyBank(-target.value, 'redeem_cash');
                if (res?.success && typeof res.after === 'number') {
                    setPiggyBank(res.after);
                } else {
                    setPiggyBank(prev => prev - target.value);
                }
            } catch (err) {
                console.error("L·ªói updatePiggyBank khi duy·ªát qu√†:", err);
                setPiggyBank(prev => prev - target.value);
            }

            setRedeemRequests(updatedRequests);
            await saveData({
                redemptionRequests: updatedRequests
            });
            return { success: true, message: "ƒê√£ duy·ªát v√† tr·ª´ ƒëi·ªÉm ti·∫øt ki·ªám c·ªßa b√©." };
        } catch (error) {
            console.error(error);
            return { success: false, message: "Kh√¥ng th·ªÉ l∆∞u ph√™ duy·ªát. Vui l√≤ng th·ª≠ l·∫°i." };
        }
    };

    const rejectRedemption = async (requestId) => {
        const target = redeemRequests.find(r => r.requestId === requestId);
        if (!target) return { success: false, message: "Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu." };
        if (target.status !== REDEMPTION_STATUS.PENDING) {
            return { success: false, message: "Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω." };
        }
        const updatedRequests = redeemRequests.map(r => r.requestId === requestId
            ? { ...r, status: REDEMPTION_STATUS.REJECTED, rejectedAt: Date.now() }
            : r
        );
        try {
            setRedeemRequests(updatedRequests);
            await saveData({ redemptionRequests: updatedRequests });
            return { success: true, message: "ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu n√†y." };
        } catch (error) {
            console.error(error);
            return { success: false, message: "Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i. Vui l√≤ng th·ª≠ l·∫°i." };
        }
    };

    const updateParentSettings = async (payload) => {
        const updates = { ...payload };
        if (Object.prototype.hasOwnProperty.call(updates, 'pin')) {
            updates.pinHash = updates.pin ? await hashParentPin(updates.pin) : null;
            delete updates.pin;
        }
        const nextSettings = {
            ...DEFAULT_PARENT_SETTINGS,
            ...parentSettings,
            ...updates,
            lastUpdated: Date.now()
        };
        try {
            setParentSettings(nextSettings);
            await saveData({ parentSettings: nextSettings });
            return { success: true };
        } catch (error) {
            console.error(error);
            return { success: false, message: "Kh√¥ng th·ªÉ l∆∞u m√£ PIN." };
        }
    };

    return {
        profiles, setProfiles,
        piggyBank, setPiggyBank,
        redeemRequests, setRedeemRequests,
        userStats, setUserStats,
        config, setConfig,
        isLoadingData,
        saveData,
        redeemCash,
        parentSettings, updateParentSettings,
        approveRedemption, rejectRedemption
    };
};

==================================================
FILE PATH: src\index.css
==================================================
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    font-family: 'Nunito', sans-serif;
    @apply bg-slate-50 text-slate-800;
  }
}

/* C√°c class ti·ªán √≠ch t√πy ch·ªânh ƒë·ªÉ ·∫©n thanh cu·ªôn nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Animation rung l·∫Øc khi sai */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-5px); }
  40%, 80% { transform: translateX(5px); }
}
.animate-shake {
  animation: shake 0.5s ease-in-out;
}

==================================================
FILE PATH: src\lib\constants.js
==================================================
import { 
    Calculator, Sigma, Target, Brain, BookOpen, Banknote, Shapes, Hash, BarChart3, HelpCircle 
} from 'lucide-react';

export const TOPICS_LIST = [
    { id: 'arithmetic', label: 'T√≠nh to√°n', iconName: 'Calculator' },
    { id: 'expressions', label: 'Bi·ªÉu th·ª©c', iconName: 'Sigma' }, 
    { id: 'finding_x', label: 'T√¨m X', iconName: 'Target' },
    { id: 'fractions', label: 'Ph√¢n s·ªë', iconName: 'Brain' },
    { id: 'word_problems', label: 'To√°n ƒë·ªë', iconName: 'BookOpen' },
    { id: 'money_units', label: 'ƒêo l∆∞·ªùng & Ti·ªÅn', iconName: 'Banknote' },
    { id: 'geometry', label: 'H√¨nh h·ªçc', iconName: 'Shapes' },
    { id: 'numbers_roman', label: 'S·ªë l·ªõn & La M√£', iconName: 'Hash' }, 
    { id: 'statistics', label: 'Th·ªëng k√™', iconName: 'BarChart3' } 
];

export const TOPIC_TRANSLATIONS = {
    'word problem': 'To√°n ƒë·ªë',
    'word_problem': 'To√°n ƒë·ªë',
    'arithmetic': 'T√≠nh to√°n',
    'calculation': 'T√≠nh to√°n',
    'geometry': 'H√¨nh h·ªçc',
    'fraction': 'Ph√¢n s·ªë',
    'fractions': 'Ph√¢n s·ªë',
    'time': 'Th·ªùi gian',
    'money': 'Ti·ªÅn t·ªá',
    'measurement': 'ƒêo l∆∞·ªùng',
    'statistics': 'Th·ªëng k√™',
    'logic': 'T∆∞ duy Logic'
};

export const ICON_MAP = { Calculator, Sigma, Target, Brain, BookOpen, Banknote, Shapes, Hash, BarChart3, HelpCircle };

export const SEMESTER_DEFAULT_TOPICS = {
    hk1: ['arithmetic', 'expressions', 'fractions', 'word_problems', 'money_units', 'geometry'],
    hk2: ['arithmetic', 'finding_x', 'word_problems', 'money_units', 'geometry', 'numbers_roman', 'statistics']
};

export const SEMESTER_CONTENT = {
    hk1: "Ph·∫°m vi 1000. B·∫£ng nh√¢n 2-9, B·∫£ng chia 2-9. G·∫•p m·ªôt s·ªë l√™n nhi·ªÅu l·∫ßn, gi·∫£m ƒëi m·ªôt s·ªë l·∫ßn. So s√°nh s·ªë l·ªõn g·∫•p m·∫•y l·∫ßn s·ªë b√©. L√†m quen bi·ªÉu th·ª©c s·ªë. Ph√¢n s·ªë 1/2 ƒë·∫øn 1/9. H√¨nh h·ªçc: G√≥c vu√¥ng/kh√¥ng vu√¥ng, Chu vi h√¨nh tam gi√°c/t·ª© gi√°c. ƒê∆°n v·ªã: mm, g, ml, ƒë·ªô C.",
    hk2: "Ph·∫°m vi 100.000 (S·ªë c√≥ 5 ch·ªØ s·ªë). L√†m tr√≤n s·ªë ƒë·∫øn h√†ng ch·ª•c/trƒÉm/ngh√¨n/ch·ª•c ngh√¨n. Ch·ªØ s·ªë La M√£ (I ƒë·∫øn XX). Di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t/vu√¥ng (cm¬≤). H√¨nh tr√≤n (t√¢m, b√°n k√≠nh, ƒë∆∞·ªùng k√≠nh). Trung ƒëi·ªÉm ƒëo·∫°n th·∫≥ng. B·∫£ng s·ªë li·ªáu th·ªëng k√™ & Kh·∫£ nƒÉng x·∫£y ra s·ª± ki·ªán. Ti·ªÅn Vi·ªát Nam."
};

export const REWARD_PER_LEVEL = { 2: 200, 3: 300, 4: 350 }; 
export const DIFFICULTY_MIX = {
    easy: { 2: 7, 3: 3, 4: 0 },    
    medium: { 2: 4, 3: 4, 4: 2 }, 
    hard: { 2: 2, 3: 4, 4: 4 }     
};

export const SHOP_ITEMS = [
    { id: 'cash_10k', name: '10.000ƒë Ti·ªÅn m·∫∑t', value: 10000, color: 'bg-green-100 text-green-700 border-green-200' },
    { id: 'cash_20k', name: '20.000ƒë Ti·ªÅn m·∫∑t', value: 20000, color: 'bg-blue-100 text-blue-700 border-blue-200' },
    { id: 'cash_30k', name: '30.000ƒë Ti·ªÅn m·∫∑t', value: 30000, color: 'bg-purple-100 text-purple-700 border-purple-200' },
    { id: 'cash_40k', name: '40.000ƒë Ti·ªÅn m·∫∑t', value: 40000, color: 'bg-orange-100 text-orange-700 border-orange-200' },
    { id: 'cash_50k', name: '50.000ƒë Ti·ªÅn m·∫∑t', value: 50000, color: 'bg-red-100 text-red-700 border-red-200' },
];

export const AVATARS = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ'];
export const REDEMPTION_STATUS = {
    PENDING: 'PENDING',
    APPROVED: 'APPROVED',
    REJECTED: 'REJECTED'
};

export const DEFAULT_PARENT_SETTINGS = {
    pinHash: null,
    lastUpdated: null,
    unlockedSeconds: 300
};

==================================================
FILE PATH: src\lib\firebase.js
==================================================
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

// --- S·ª¨ D·ª§NG BI·∫æN M√îI TR∆Ø·ªúNG ---
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
};

const appId = firebaseConfig.appId;

// Kh·ªüi t·∫°o c√°c bi·∫øn
let app, db, auth;

try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (error) {
    console.error("L·ªói kh·ªüi t·∫°o Firebase:", error);
    app = null;
    db = null;
    auth = null;
}

// Export ·ªü c·∫•p cao nh·∫•t (Top-level)
// QUAN TR·ªåNG: Ph·∫£i c√≥ 'app' ·ªü ƒë√¢y ƒë·ªÉ gemini.js s·ª≠ d·ª•ng
export { db, auth, appId, app };

==================================================
FILE PATH: src\lib\gemini.js
==================================================
import { getFunctions, httpsCallable } from 'firebase/functions';
import { app } from './firebase'; // ƒê·∫£m b·∫£o export app t·ª´ firebase.js

// Kh·ªüi t·∫°o Functions service
const functions = getFunctions(app, 'us-central1'); // Region ph·∫£i kh·ªõp v·ªõi l√∫c deploy function

export const callGemini = async (prompt) => {
  const generateQuestions = httpsCallable(functions, 'generateQuestions');

  try {
    const result = await generateQuestions({ prompt: prompt });
    // Cloud Function v2 onCall tr·∫£ v·ªÅ data trong result.data
    return result.data;
  } catch (error) {
    console.error("L·ªói g·ªçi Cloud Function:", error);
    // Tr·∫£ v·ªÅ null ƒë·ªÉ App.jsx bi·∫øt m√† chuy·ªÉn sang ch·∫ø ƒë·ªô Offline/Backup
    return null;
  }
};

==================================================
FILE PATH: src\lib\helpers.jsx
==================================================
import React from 'react';

// --- UI COMPONENTS ---
export const ClayButton = ({ children, onClick, colorClass = "bg-white", className = "", disabled=false }) => (
    <button onClick={onClick} disabled={disabled} className={`relative overflow-hidden transition-all duration-150 ease-in-out rounded-2xl border-2 border-transparent ${disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'active:scale-95 active:shadow-none shadow-[0_6px_0_rgba(0,0,0,0.15)] cursor-pointer'} ${colorClass} ${className}`}>
        {children}
        <div className="absolute top-0 left-0 w-full h-1/3 bg-gradient-to-b from-white/30 to-transparent pointer-events-none"></div>
    </button>
);

export const Fraction = ({ num, den }) => (
  <span className="inline-block text-center align-middle mx-1.5" style={{ verticalAlign: 'middle' }}>
    <span className="block border-b-2 border-current px-1 text-lg font-bold leading-tight pb-[1px]">{num}</span>
    <span className="block px-1 text-lg font-bold leading-tight pt-[1px]">{den}</span>
  </span>
);

export const MathText = ({ text }) => {
  if (text === null || text === undefined) return "";
  const stringText = String(text);
  
  let cleanText = stringText
      .replace(/(\d+)\s+(\d{3})/g, '$1$2') 
      .replace(/(\d+),(\d{3})/g, '$1$2');

  let formattedText = cleanText.replace(/\d{4,}/g, (match) => {
      return match.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  });

  let processedText = formattedText
    .replace(/\t+imes/g, ' √ó ')      
    .replace(/\\t+imes/g, ' √ó ')     
    .replace(/\s+imes/g, ' √ó ')      
    .replace(/x\s*imes/g, ' √ó ')     
    .replace(/\\times/g, ' √ó ')      
    .replace(/\*/g, ' √ó ')            
    .replace(/\sx\s/g, ' √ó ')        
    .replace(/(\d)\s+x\s+(\d)/g, '$1 √ó $2') 
    .replace(/\\div/g, ':')          
    .replace(/:/g, ':')              
    .replace(/\f/g, '\\f') 
    .replace(/\\fracrac/g, '\\frac')
    .replace(/\\frac\\frac/g, '\\frac')
    .replace(/\$/g, '');

  const regex = /(\\frac\{([0-9.]+)\}\{([0-9.]+)\}|([0-9.]+)\/([0-9.]+))/g;
  const elements = [];
  let lastIndex = 0;
  
  processedText.replace(regex, (match, latexGroup, n1, d1, n2, d2, index) => {
    if (index > lastIndex) {
        elements.push(<span key={`text-${index}`}>{processedText.substring(lastIndex, index)}</span>);
    }
    elements.push(<Fraction key={`frac-${index}`} num={n1 || n2} den={d1 || d2} />);
    lastIndex = index + match.length;
    return match;
  });
  
  if (lastIndex < processedText.length) {
      elements.push(<span key={`text-end`}>{processedText.substring(lastIndex)}</span>);
  }
  
  return <span className="inline-block leading-relaxed whitespace-pre-wrap">{elements}</span>;
};


==================================================
FILE PATH: src\lib\offlineGenerator.js
==================================================
import { DIFFICULTY_MIX } from './constants';

const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

const chooseLevel = (difficulty = 'medium') => {
    const mix = DIFFICULTY_MIX[difficulty] || DIFFICULTY_MIX.medium;
    const pool = Object.entries(mix).flatMap(([level, count]) => Array(count).fill(Number(level)));
    return pool[randomInt(0, pool.length - 1)];
};

const topicFallbacks = ['arithmetic', 'expressions', 'finding_x', 'money_units', 'geometry'];

const pickTopic = (selectedTopics = []) => {
    const viable = selectedTopics.filter(t => topicFallbacks.includes(t));
    const pool = viable.length > 0 ? viable : topicFallbacks;
    return pool[randomInt(0, pool.length - 1)];
};

const buildOptions = (correctVal) => {
    const answers = new Set([correctVal]);
    while (answers.size < 4) {
        const jitter = randomInt(-20, 20);
        const candidate = Math.max(0, correctVal + jitter);
        if (!answers.has(candidate)) answers.add(candidate);
    }
    return Array.from(answers).sort(() => Math.random() - 0.5).map(num => String(num));
};

const createArithmeticQuestion = (level, topic) => {
    const operations = [
        { label: '+', generator: () => {
            const a = randomInt(50, 999);
            const b = randomInt(10, 400);
            return {
                text: `B√© t√≠nh gi√∫p: ${a} + ${b} = ?`,
                answer: a + b,
                explanation: `${a} + ${b} = ${a + b}`
            };
        }},
        { label: '-', generator: () => {
            const a = randomInt(200, 999);
            const b = randomInt(10, a - 20);
            return {
                text: `Si√™u nh√¢n A tr·ª´ ƒëi ${b} kh·ªèi ${a}. K·∫øt qu·∫£ l√† bao nhi√™u?`,
                answer: a - b,
                explanation: `${a} - ${b} = ${a - b}`
            };
        }},
        { label: '√ó', generator: () => {
            const a = randomInt(2, 20);
            const b = randomInt(2, 15);
            return {
                text: `Robot nh√¢n ${a} v·ªõi ${b} ƒë·ªÉ s·∫°c pin. B√© cho bi·∫øt k·∫øt qu·∫£ nh√©!`,
                answer: a * b,
                explanation: `${a} √ó ${b} = ${a * b}`
            };
        }}
    ];
    const seed = operations[randomInt(0, operations.length - 1)].generator();
    return {
        type: 'mcq',
        topic,
        level,
        text: seed.text,
        correctVal: String(seed.answer),
        options: buildOptions(seed.answer),
        explanation: seed.explanation
    };
};

const createFillBlankQuestion = (level, topic) => {
    const total = randomInt(120, 600);
    const addend = randomInt(20, total - 40);
    const missing = total - addend;
    return {
        type: 'fill_blank',
        topic,
        level,
        text: `ƒêi·ªÅn s·ªë c√≤n thi·∫øu: ${addend} + __ = ${total}`,
        correctVal: String(missing),
        explanation: `Mu·ªën t√¨m s·ªë h·∫°ng ch∆∞a bi·∫øt, l·∫•y ${total} - ${addend} = ${missing}.`
    };
};

const createComparisonQuestion = (level, topic) => {
    const left = randomInt(50, 999);
    const right = randomInt(50, 999);
    const expression = `${left} ... ${right}`;
    const symbol = left > right ? '>' : left < right ? '<' : '=';
    return {
        type: 'comparison',
        topic,
        level,
        text: `ƒêi·ªÅn d·∫•u th√≠ch h·ª£p: ${expression}`,
        options: ['>', '<', '='],
        correctVal: symbol,
        explanation: `${left} ${symbol} ${right}`
    };
};

const createFindingXQuestion = (level) => {
    const patterns = [
        {
            generator: () => {
                const a = randomInt(10, 200);
                const x = randomInt(5, 100);
                const b = a + x;
                return {
                    text: `T√¨m x, bi·∫øt: ${a} + x = ${b}`,
                    answer: x,
                    explanation: `Mu·ªën t√¨m s·ªë h·∫°ng ch∆∞a bi·∫øt, ta l·∫•y t·ªïng tr·ª´ ƒëi s·ªë h·∫°ng ƒë√£ bi·∫øt: ${b} - ${a} = ${x}.`
                };
            }
        },
        {
            generator: () => {
                const x = randomInt(50, 500);
                const a = randomInt(10, x - 20);
                const b = x - a;
                return {
                    text: `T√¨m x, bi·∫øt: x - ${a} = ${b}`,
                    answer: x,
                    explanation: `Mu·ªën t√¨m s·ªë b·ªã tr·ª´, ta l·∫•y hi·ªáu c·ªông v·ªõi s·ªë tr·ª´: ${b} + ${a} = ${x}.`
                };
            }
        },
        {
            generator: () => {
                const a = randomInt(200, 800);
                const x = randomInt(10, a - 50);
                const b = a - x;
                return {
                    text: `T√¨m x, bi·∫øt: ${a} - x = ${b}`,
                    answer: x,
                    explanation: `Mu·ªën t√¨m s·ªë tr·ª´, ta l·∫•y s·ªë b·ªã tr·ª´ tr·ª´ ƒëi hi·ªáu: ${a} - ${b} = ${x}.`
                };
            }
        },
        {
            generator: () => {
                const x = randomInt(5, 20);
                const a = randomInt(2, 12);
                const b = x * a;
                return {
                    text: `T√¨m x, bi·∫øt: x √ó ${a} = ${b}`,
                    answer: x,
                    explanation: `Mu·ªën t√¨m th·ª´a s·ªë ch∆∞a bi·∫øt, ta l·∫•y t√≠ch chia cho th·ª´a s·ªë ƒë√£ bi·∫øt: ${b} : ${a} = ${x}.`
                };
            }
        }
    ];
    const seed = patterns[randomInt(0, patterns.length - 1)].generator();
    return {
        type: 'mcq',
        topic: 'finding_x',
        level,
        text: seed.text,
        correctVal: String(seed.answer),
        options: buildOptions(seed.answer),
        explanation: seed.explanation
    };
};

const createGeometryQuestion = (level) => {
    const shapes = [
        {
            generator: () => {
                const length = randomInt(5, 15);
                const width = randomInt(3, 10);
                const perimeter = 2 * (length + width);
                const area = length * width;
                const isPerimeter = Math.random() > 0.5;
                return {
                    text: isPerimeter
                        ? `M·ªôt h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i ${length}cm, chi·ªÅu r·ªông ${width}cm. Chu vi h√¨nh ch·ªØ nh·∫≠t ƒë√≥ l√† bao nhi√™u cm?`
                        : `M·ªôt h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i ${length}cm, chi·ªÅu r·ªông ${width}cm. Di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t ƒë√≥ l√† bao nhi√™u cm¬≤?`,
                    answer: isPerimeter ? perimeter : area,
                    explanation: isPerimeter
                        ? `Chu vi h√¨nh ch·ªØ nh·∫≠t = (D√†i + R·ªông) √ó 2 = (${length} + ${width}) √ó 2 = ${perimeter}cm.`
                        : `Di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t = D√†i √ó R·ªông = ${length} √ó ${width} = ${area}cm¬≤.`,
                    svgContent: `<rect x="${(300 - length * 10) / 2}" y="${(200 - width * 10) / 2}" width="${length * 10}" height="${width * 10}" stroke="#4F46E5" stroke-width="3" fill="#E0E7FF" /><text x="150" y="${(200 - width * 10) / 2 - 10}" text-anchor="middle" font-size="14" fill="#374151" font-weight="bold">${length} cm</text><text x="${(300 + length * 10) / 2 + 10}" y="110" font-size="14" fill="#374151" font-weight="bold" transform="rotate(-90 ${(300 + length * 10) / 2 + 10},110)">${width} cm</text>`
                };
            }
        },
        {
            generator: () => {
                const side = randomInt(4, 12);
                const perimeter = side * 4;
                const area = side * side;
                const isPerimeter = Math.random() > 0.5;
                return {
                    text: isPerimeter
                        ? `M·ªôt h√¨nh vu√¥ng c√≥ c·∫°nh ${side}cm. Chu vi h√¨nh vu√¥ng ƒë√≥ l√† bao nhi√™u cm?`
                        : `M·ªôt h√¨nh vu√¥ng c√≥ c·∫°nh ${side}cm. Di·ªán t√≠ch h√¨nh vu√¥ng ƒë√≥ l√† bao nhi√™u cm¬≤?`,
                    answer: isPerimeter ? perimeter : area,
                    explanation: isPerimeter
                        ? `Chu vi h√¨nh vu√¥ng = C·∫°nh √ó 4 = ${side} √ó 4 = ${perimeter}cm.`
                        : `Di·ªán t√≠ch h√¨nh vu√¥ng = C·∫°nh √ó C·∫°nh = ${side} √ó ${side} = ${area}cm¬≤.`,
                    svgContent: `<rect x="${(300 - side * 10) / 2}" y="${(200 - side * 10) / 2}" width="${side * 10}" height="${side * 10}" stroke="#4F46E5" stroke-width="3" fill="#E0E7FF" /><text x="150" y="${(200 - side * 10) / 2 - 10}" text-anchor="middle" font-size="14" fill="#374151" font-weight="bold">${side} cm</text>`
                };
            }
        }
    ];
    const seed = shapes[randomInt(0, shapes.length - 1)].generator();
    return {
        type: 'mcq',
        topic: 'geometry',
        level,
        text: seed.text,
        correctVal: String(seed.answer),
        options: buildOptions(seed.answer),
        explanation: seed.explanation,
        svgContent: seed.svgContent
    };
};

export const buildOfflineQuiz = (config = {}) => {
    const questions = [];
    const selectedTopics = config.selectedTopics || [];
    const hasGeometry = selectedTopics.includes('geometry') || selectedTopics.length === 0;
    const hasFindingX = selectedTopics.includes('finding_x') || selectedTopics.length === 0;
    
    for (let i = 0; i < 10; i++) {
        const level = chooseLevel(config.difficultyMode);
        const topic = pickTopic(selectedTopics);
        let question;
        
        const pattern = i % 5;
        if (pattern === 0) {
            question = createArithmeticQuestion(level, topic);
        } else if (pattern === 1) {
            question = createFillBlankQuestion(level, topic);
        } else if (pattern === 2) {
            question = createComparisonQuestion(level, topic);
        } else if (pattern === 3 && hasFindingX) {
            question = createFindingXQuestion(level);
        } else if (pattern === 4 && hasGeometry) {
            question = createGeometryQuestion(level);
        } else {
            question = createArithmeticQuestion(level, topic);
        }
        
        question.id = i;
        questions.push(question);
    }
    return questions;
};



==================================================
FILE PATH: src\lib\piggyBank.js
==================================================
import { getFunctions, httpsCallable } from 'firebase/functions';
import { app, appId } from './firebase';

let functionsInstance = null;

const getFunctionsInstance = () => {
    if (!functionsInstance && app) {
        functionsInstance = getFunctions(app, 'us-central1');
    }
    return functionsInstance;
};

export const secureUpdatePiggyBank = async (delta, reason) => {
    const functions = getFunctionsInstance();
    if (!functions) {
        throw new Error('Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.');
    }
    const fn = httpsCallable(functions, 'updatePiggyBank');
    const res = await fn({ delta, reason, appId });
    return res.data;
};




==================================================
FILE PATH: src\lib\utils.js
==================================================
import { evaluate } from 'mathjs';
import { TOPIC_TRANSLATIONS } from './constants';

export const getDeviceId = () => {
    let deviceId = localStorage.getItem('math_app_device_id');
    if (!deviceId) {
        deviceId = crypto.randomUUID();
        localStorage.setItem('math_app_device_id', deviceId);
    }
    return deviceId;
};

export const fmt = (num) => {
    if (num === null || num === undefined) return "0";
    if (/[a-zA-Z]/.test(String(num))) return String(num); 
    return String(parseInt(num)).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
};

export const normalizeVal = (val) => {
    if (val === null || val === undefined) return '';
    const str = String(val).toLowerCase().trim().replace(/,/g, '');
    if (/^-?\d+(\.\d+)?$/.test(str)) {
        return parseFloat(str);
    }
    return str;
};

export const normalizeComparisonSymbol = (val) => {
    const v = String(val).toLowerCase().trim();
    if (['b·∫±ng nhau', 'b·∫±ng', 'equal', '=', 'eq'].includes(v)) return '=';
    if (v.includes('l·ªõn') || v === 'greater' || v === 'gt' || v === '>') return '>';
    if (v.includes('b√©') || v.includes('nh·ªè') || v === 'less' || v === 'lt' || v === '<') return '<';
    return v;
};

// --- H√ÄM L√ÄM S·∫†CH TEXT (QUAN TR·ªåNG) ---
const cleanMathText = (text) => {
    return text.toLowerCase()
        .replace(/ƒëi·ªÅn d·∫•u.*?(:|v√†o ch·ªó ch·∫•m)/g, '') // B·ªè "ƒêi·ªÅn d·∫•u..."
        .replace(/k·∫øt qu·∫£ c·ªßa ph√©p t√≠nh/g, '')
        .replace(/gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c/g, '')
        .replace(/t√≠nh nh·∫©m/g, '')
        .replace(/t√≠nh/g, '')
        .replace(/so s√°nh/g, '')
        .replace(/h√£y ch·ªçn/g, '')
        .replace(/t√¨m x,? bi·∫øt/g, '') // B·ªè "T√¨m x bi·∫øt"
        .replace(/t√¨m y,? bi·∫øt/g, '')
        .replace(/x\s*=/g, '') // B·ªè "x =" n·∫øu c√≥
        .replace(/:/g, '') // B·ªè d·∫•u hai ch·∫•m ·ªü cu·ªëi c√¢u d·∫´n
        .trim();
};

export const solveSimpleExpression = (text) => {
    try {
        // L√†m s·∫°ch text tr∆∞·ªõc khi t√≠nh
        let clean = cleanMathText(text)
            .replace(/x/g, '*')
            .replace(/√ó/g, '*')
            .replace(/:/g, '/')
            .replace(/√∑/g, '/')
            .replace(/c·ªßa/g, '*')
            .replace(/,/g, '.')
            .trim();

        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ch·ªâ c√≤n l·∫°i s·ªë (v√≠ d·ª•: " 500 ")
        if (/^-?\d+(\.\d+)?$/.test(clean)) return parseFloat(clean);

        // N·∫øu chu·ªói r·ªóng ho·∫∑c ch·ª©a k√Ω t·ª± l·∫°, return null
        if (!clean || /[a-zƒë]/.test(clean)) return null;

        const result = evaluate(clean);
        return (isFinite(result) && !isNaN(result)) ? parseFloat(result.toFixed(2)) : null; 
    } catch {
        return null;
    }
};

export const solveEquation = (text) => {
    try {
        let clean = cleanMathText(text)
            .replace(/√ó/g, '*')
            .replace(/x/g, '*') // L∆∞u √Ω: ·ªü ƒë√¢y coi x l√† d·∫•u nh√¢n sau khi ƒë√£ remove ch·ªØ "t√¨m x"
            .replace(/√∑/g, '/')
            .trim();

        // Ph∆∞∆°ng tr√¨nh ph·∫£i c√≥ d·∫•u b·∫±ng
        const sides = clean.split('=');
        if (sides.length !== 2) return null;

        const left = sides[0].trim();
        const right = sides[1].trim();

        const rightVal = evaluate(right);
        if (!isFinite(rightVal)) return null;

        // T√¨m s·ªë trong v·∫ø tr√°i
        const numMatch = left.match(/(\d+(\.\d+)?)/); 
        if (!numMatch) return null;
        const a = parseFloat(numMatch[0]);

        if (left.includes('+')) return rightVal - a;
        else if (left.includes('-')) {
            const indexNum = left.indexOf(numMatch[0]);
            const indexOp = left.indexOf('-');
            return indexNum < indexOp ? a - rightVal : rightVal + a;
        } else if (left.includes('*')) return rightVal / a;
        else if (left.includes('/')) {
            const indexNum = left.indexOf(numMatch[0]);
            const indexOp = left.indexOf('/');
            return indexNum < indexOp ? a / rightVal : rightVal * a;
        }
        
        return null;
    } catch {
        return null;
    }
};

export const solveComparison = (text) => {
    try {
        // 1. L√†m s·∫°ch c√¢u d·∫´n (ƒê√¢y l√† b∆∞·ªõc s·ª≠a l·ªói quan tr·ªçng nh·∫•t)
        // V√≠ d·ª•: "ƒêi·ªÅn d·∫•u...: 15 + 9 ... 32 - 8" -> "15 + 9 ... 32 - 8"
        const clean = cleanMathText(text);

        // 2. T√°ch 2 v·∫ø
        const parts = clean.split(/(?:\.\.+|_+|\?|;|v·ªõi|\s{2,})/i);
        
        // L·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu v√† cu·ªëi c√≥ n·ªôi dung
        const validParts = parts.filter(p => p.trim().length > 0);
        
        if (validParts.length < 2) return null;

        const leftStr = validParts[0];
        const rightStr = validParts[validParts.length - 1];

        const val1 = solveSimpleExpression(leftStr);
        const val2 = solveSimpleExpression(rightStr);

        if (val1 === null || val2 === null || isNaN(val1) || isNaN(val2)) return null;

        if (val1 > val2) return '>';
        if (val1 < val2) return '<';
        return '='; 
    } catch (e) { 
        console.error("L·ªói t√≠nh so s√°nh:", e);
        return null;
    }
};

export const encodeEmail = (email) => {
    return btoa(email.toLowerCase().trim()).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
};

export const getWeakTopics = (stats) => {
    if (!stats || !stats.topics) return [];
    return Object.entries(stats.topics)
        .filter(([, val]) => { 
            const rate = val.total > 0 ? (val.correct / val.total) : 1;
            return rate < 0.5 && val.total >= 3;
        })
        .map(([key]) => TOPIC_TRANSLATIONS[key] || key); 
};

export const getDeviceLabel = () => {
    try {
        const ua = navigator?.userAgent || 'Thi·∫øt b·ªã';
        const platform = navigator?.platform || '';
        const browserMatch = ua.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/i);
        const browser = browserMatch ? browserMatch[1] : 'Tr√¨nh duy·ªát';
        if (platform) return `${platform} ‚Ä¢ ${browser}`;
        return `${browser} ‚Ä¢ Web`;
    } catch {
        return 'Thi·∫øt b·ªã ch∆∞a x√°c ƒë·ªãnh';
    }
};

const digestToHex = (buffer) => Array.from(new Uint8Array(buffer))
    .map(b => b.toString(16).padStart(2, '0')).join('');

export const hashParentPin = async (pin) => {
    if (!pin) return null;
    const encoder = new TextEncoder();
    const data = encoder.encode(String(pin).trim());
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return digestToHex(hashBuffer);
};

export const verifyParentPin = async (pin, pinHash) => {
    if (!pinHash) return false;
    const hashed = await hashParentPin(pin);
    return hashed === pinHash;
};

==================================================
FILE PATH: src\lib\utils.test.js
==================================================
import { describe, it, expect } from 'vitest';
import { normalizeVal, solveEquation, solveComparison } from './utils';

describe('normalizeVal', () => {
    it('chu·∫©n ho√° s·ªë nguy√™n v√† chu·ªói s·ªë c∆° b·∫£n', () => {
        expect(normalizeVal(10)).toBe(10);
        expect(normalizeVal('10')).toBe(10);
        expect(normalizeVal('  10  ')).toBe(10);
    });

    it('x·ª≠ l√Ω s·ªë th·∫≠p ph√¢n d·∫°ng ch·∫•m', () => {
        expect(normalizeVal('3.5')).toBeCloseTo(3.5);
        expect(normalizeVal(0.5)).toBeCloseTo(0.5);
    });

    it('x·ª≠ l√Ω s·ªë c√≥ d·∫•u ph·∫©y (theo logic hi·ªán t·∫°i)', () => {
        // Theo implement: b·ªè d·∫•u ph·∫©y r·ªìi parse, n√™n "3,5" => 35
        expect(normalizeVal('3,5')).toBe(35);
        expect(normalizeVal('1,000')).toBe(1000);
    });

    it('gi·ªØ nguy√™n ph√¢n s·ªë d·∫°ng 1/2 d∆∞·ªõi d·∫°ng chu·ªói', () => {
        expect(normalizeVal('1/2')).toBe('1/2');
    });

    it('tr·∫£ v·ªÅ chu·ªói r·ªóng cho null/undefined', () => {
        expect(normalizeVal(null)).toBe('');
        expect(normalizeVal(undefined)).toBe('');
    });

    it('gi·ªØ nguy√™n text (ƒë√£ ƒë∆∞·ª£c lower-case v√† trim)', () => {
        expect(normalizeVal('  Xin Ch√†o  ')).toBe('xin ch√†o');
    });
});

describe('solveEquation', () => {
    it('gi·∫£i ph∆∞∆°ng tr√¨nh d·∫°ng x + a = b', () => {
        const result = solveEquation('T√¨m x, bi·∫øt: x + 5 = 12');
        expect(result).toBe(7);
    });

    it('gi·∫£i ph∆∞∆°ng tr√¨nh d·∫°ng x - a = b', () => {
        const result = solveEquation('T√¨m x, bi·∫øt: x - 3 = 7');
        expect(result).toBe(10);
    });

    it('gi·∫£i ph∆∞∆°ng tr√¨nh d·∫°ng x √ó a = b', () => {
        const result = solveEquation('T√¨m x, bi·∫øt: x √ó 4 = 20');
        expect(result).toBe(5);
    });

    it('b·ªè qua c√°c ph∆∞∆°ng tr√¨nh ph·ª©c t·∫°p kh√¥ng h·ªó tr·ª£ (chia ·ªü nhi·ªÅu v·ªã tr√≠)', () => {
        const result = solveEquation('T√¨m x, bi·∫øt: 14 : x = 6');
        expect(result).toBeNull();
    });

    it('tr·∫£ v·ªÅ null n·∫øu kh√¥ng c√≥ d·∫•u "="', () => {
        const result = solveEquation('T√¨m x, bi·∫øt: x + 5');
        expect(result).toBeNull();
    });
});

describe('solveComparison', () => {
    it('so s√°nh ƒë∆°n gi·∫£n v·ªõi ph√©p nh√¢n', () => {
        const res = solveComparison('So s√°nh: 5 x 5 ... 24');
        expect(res).toBe('>');
    });

    it('so s√°nh khi hai v·∫ø b·∫±ng nhau', () => {
        const res = solveComparison('ƒêi·ªÅn d·∫•u: 15 + 9 ... 32 - 8');
        expect(res).toBe('=');
    });

    it('so s√°nh v·ªõi s·ªë th·∫≠p ph√¢n d·∫•u ch·∫•m', () => {
        const res = solveComparison('So s√°nh: 1.5 + 2.5 ... 4');
        expect(res).toBe('=');
    });

    it('so s√°nh v·ªõi s·ªë th·∫≠p ph√¢n d·∫•u ph·∫©y trong c√¢u ti·∫øng Vi·ªát', () => {
        const res = solveComparison('So s√°nh: 3,5 + 1,5 ... 5');
        expect(res).toBe('=');
    });

    it('tr·∫£ v·ªÅ null n·∫øu kh√¥ng t√°ch ƒë∆∞·ª£c hai v·∫ø', () => {
        const res = solveComparison('C√¢u h·ªèi b·ªã l·ªói, kh√¥ng c√≥ bi·ªÉu th·ª©c h·ª£p l·ªá');
        expect(res).toBeNull();
    });
});




==================================================
FILE PATH: src\main.jsx
==================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


==================================================
FILE PATH: tailwind.config.js
==================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
  "./index.html",
  "./src/**/*.{js,ts,jsx,tsx}",
],
  theme: {
    extend: {},
  },
  plugins: [],
}



==================================================
FILE PATH: vite.config.js
==================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'node',
    include: ['src/lib/**/*.test.js']
  }
})

