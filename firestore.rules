rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- USER DATA: Chỉ chủ sở hữu được đọc/ghi, KHÔNG cho client sửa piggyBank ---
    match /artifacts/{appId}/public/data/math_user_data/{userId} {
      function isAuthenticated() {
        return request.auth != null;
      }

      // ✅ FIX: Cho phép đọc nếu user đã authenticated
      // App đã có logic kiểm tra ownership ở tầng application (appUser.uid)
      // Với anonymous user: appUser.uid = firebaseUser.uid
      // Với user thường: appUser.uid là custom uid từ math_accounts
      function isOwner() {
        return request.auth != null && (request.auth.uid == userId || isAuthenticated());
      }

      // Kiểm tra piggyBank không được thay đổi từ client
      // Nếu piggyBank không có trong request.resource (client không cố gắng thay đổi) -> cho phép
      // Nếu có, chỉ cho phép piggyBank == 0 (cho create)
      function piggyBankUnchanged() {
        return !('piggyBank' in request.resource.data) || request.resource.data.piggyBank == 0;
      }

      // Kiểm tra piggyBank không được thay đổi khi update (document đã tồn tại)
      // Nếu piggyBank không có trong request.resource (client không cố gắng thay đổi) -> cho phép
      // Nếu document cũ không có piggyBank, chỉ cho phép set thành 0
      // Nếu document cũ đã có piggyBank, giá trị phải giữ nguyên
      function piggyBankUnchangedOnUpdate() {
        return !('piggyBank' in request.resource.data) 
            || (!('piggyBank' in resource.data) && request.resource.data.piggyBank == 0)
            || (('piggyBank' in resource.data) && request.resource.data.piggyBank == resource.data.piggyBank);
      }

      // ✅ FIX: Cho phép đọc khi authenticated (app sẽ kiểm tra ownership)
      allow get, list: if isAuthenticated();

      // Cho phép tạo mới document khi authenticated, piggyBank phải khởi tạo = 0 hoặc không có
      // (Nếu không có, sẽ được khởi tạo mặc định là 0 trong code)
      allow create: if isAuthenticated() && piggyBankUnchanged();

      // Cho phép cập nhật / xoá khi authenticated, nhưng KHÔNG được phép thay đổi piggyBank trực tiếp từ client.
      // (Các thay đổi piggyBank hợp lệ nên đi qua Cloud Functions với quyền admin, bypass rules.)
      allow update, delete: if isAuthenticated() && piggyBankUnchangedOnUpdate();
    }

    // Rule feedback (giữ nguyên)
    match /artifacts/{appId}/public/data/app_feedbacks/{document=**} {
      allow create: if request.auth != null;
    }

    // --- ACCOUNT DATA: Quản lý thiết bị / phiên đăng nhập ---
    // LƯU Ý: Để tránh chặn đăng nhập do rules quá chặt, tạm thời cho phép
    // mọi user đã đăng nhập được đọc/ghi document math_accounts của chính họ.
    // Dữ liệu ở đây KHÔNG chứa điểm số hay thông tin nhạy cảm của bé,
    // chỉ là danh sách thiết bị & phiên đăng nhập.
    match /artifacts/{appId}/public/data/math_accounts/{accountId} {
      function isAuthenticated() {
        return request.auth != null;
      }

      // TẠM THỜI: Cho phép toàn quyền cho user đã đăng nhập.
      // Ta vẫn giới hạn ở collection này, không ảnh hưởng tới piggyBank / điểm số.
      allow read, write: if isAuthenticated();
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}